<!DOCTYPE html>
<html lang="en" dir="auto">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>LLM 输出限制：Structured Outputs、受限编码和提示词工程 | LZY Blog</title>
<meta name="keywords" content="Agent, LLM">
<meta name="description" content="在使用大型语言模型（LLM）时，我们常常面临一个挑战：如何从模型输出中准确提取自己所需的信息。例如，当我们希望模型输出 JSON 格式的数据时，由于模型生成的内容并不总是稳定，可能需要额外编写大量的正则表达式来匹配并提取其中的有效信息。然而，由于 LLM 的能力，导致其输出结构并不永远可靠。
现阶段， 让LLM按要求生成特定格式文本的主要方法有几种种：


微调：使模型的输出遵循特定格式


OpenAI Json-mode/Structured Outputs/function-calling: 这些功能允许模型生成更严格、结构化的输出，但受限于openAI平台。


格式约束：在decoding阶段进行约束，限制模型的输出，


Prompt Engineering： 最简单的办法，但不稳定。


多阶段prompting： 通过多个步骤的提示逐步引导模型生成所需的格式。


本文将聚焦在Structured Outputs， 受限编码， 和prompt-engineering的角度，探讨它们在生成特定格式文本中的应用和效果。
Json Mode
仅特定模型和平台支持
以openAI 为例， 在openai.chat.completions.create 参数中增加response_format={&quot;type&quot;:&quot;json_object&quot;} 即可（具体参见：response_format ）。


需要在prompt中要求输出json格式


不能保证完全按要求的格式结构输出


但非100%成功率，存在一些需要额外检测和适当处理的edge case。



  Handling edge cases
  
    根据OpenAI官方文档提供的处理方案
    https://platform.openai.com/docs/guides/structured-outputs/json-mode
      we_did_not_specify_stop_tokens = True
      
      try:
          response = client.chat.completions.create(
              model=&#34;gpt-3.5-turbo-0125&#34;,
              messages=[
                  {&#34;role&#34;: &#34;system&#34;, &#34;content&#34;: &#34;You are a helpful assistant designed to output JSON.&#34;},
                  {&#34;role&#34;: &#34;user&#34;, &#34;content&#34;: &#34;Who won the world series in 2020? Please respond in the format {winner: ...}&#34;}
              ],
              response_format={&#34;type&#34;: &#34;json_object&#34;}
          )
      
          # Check if the conversation was too long for the context window, resulting in incomplete JSON 
          if response.choices[0].message.finish_reason == &#34;length&#34;:
              # your code should handle this error case
              pass
      
          # Check if the OpenAI safety system refused the request and generated a refusal instead
          if response.choices[0].message[0].get(&#34;refusal&#34;):
              # your code should handle this error case
              # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing
              print(response.choices[0].message[0][&#34;refusal&#34;])
      
          # Check if the model&#39;s output included restricted content, so the generation of JSON was halted and may be partial
          if response.choices[0].message.finish_reason == &#34;content_filter&#34;:
              # your code should handle this error case
              pass
      
          if response.choices[0].message.finish_reason == &#34;stop&#34;:
              # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a &#34;stop token&#34;
      
              if we_did_not_specify_stop_tokens:
                  # If you didn&#39;t specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object
                  # This is guaranteed to parse successfully and should now contain  &#34;{&#34;winner&#34;: &#34;Los Angeles Dodgers&#34;}&#34;
                  print(response.choices[0].message.content)
              else:
                  # Check if the response.choices[0].message.content ends with one of your stop tokens and handle appropriately
                  pass
      except Exception as e:
          # Your code should handle errors here, for example a network error calling the API
          print(e)
  
  
    使用pydantic的方案
    使用pydantic的方案
      from pydantic import BaseModel, EmailStr, ValidationError
      
      # 定义你期望的 JSON 数据模型
      class UserModel(BaseModel):
          name: str
          age: int
          email: EmailStr
      
      # 检查 JSON 是否符合模型的函数
      def validate_json(json_str):
          try:
              # 将输入的 JSON 字符串转换为 UserModel 实例
              user = UserModel.parse_raw(json_str)
              
              # 如果验证通过，返回字典
              return user.dict()
          except ValidationError as ve:
              print(f&#34;JSON validation error: {ve.json()}&#34;)
              return None
      
      # 示例用法
      json_str = &#39;{&#34;name&#34;: &#34;John Doe&#34;, &#34;email&#34;: &#34;john.doe@example.com&#34;}&#39;
      validated_json = validate_json(json_str)
      
      if validated_json is not None:
          print(&#34;JSON is valid and conforms to the schema:&#34;)
          print(validated_json)
      else:
          print(&#34;JSON is invalid.&#34;)
  

Json-Mode 更多是对于输出json的格式进行检查(即Json格式的有效性)">
<meta name="author" content="Theme PaperMod">
<link rel="canonical" href="http://localhost:1313/posts/llm-%E8%BE%93%E5%87%BA%E9%99%90%E5%88%B6structured-outputs%E5%8F%97%E9%99%90%E7%BC%96%E7%A0%81%E5%92%8C%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="http://localhost:1313/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="http://localhost:1313/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="http://localhost:1313/favicon-32x32.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">
<link rel="mask-icon" href="http://localhost:1313/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="http://localhost:1313/posts/llm-%E8%BE%93%E5%87%BA%E9%99%90%E5%88%B6structured-outputs%E5%8F%97%E9%99%90%E7%BC%96%E7%A0%81%E5%92%8C%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="LLM 输出限制：Structured Outputs、受限编码和提示词工程" />
<meta property="og:description" content="在使用大型语言模型（LLM）时，我们常常面临一个挑战：如何从模型输出中准确提取自己所需的信息。例如，当我们希望模型输出 JSON 格式的数据时，由于模型生成的内容并不总是稳定，可能需要额外编写大量的正则表达式来匹配并提取其中的有效信息。然而，由于 LLM 的能力，导致其输出结构并不永远可靠。
现阶段， 让LLM按要求生成特定格式文本的主要方法有几种种：


微调：使模型的输出遵循特定格式


OpenAI Json-mode/Structured Outputs/function-calling: 这些功能允许模型生成更严格、结构化的输出，但受限于openAI平台。


格式约束：在decoding阶段进行约束，限制模型的输出，


Prompt Engineering： 最简单的办法，但不稳定。


多阶段prompting： 通过多个步骤的提示逐步引导模型生成所需的格式。


本文将聚焦在Structured Outputs， 受限编码， 和prompt-engineering的角度，探讨它们在生成特定格式文本中的应用和效果。
Json Mode
仅特定模型和平台支持
以openAI 为例， 在openai.chat.completions.create 参数中增加response_format={&quot;type&quot;:&quot;json_object&quot;} 即可（具体参见：response_format ）。


需要在prompt中要求输出json格式


不能保证完全按要求的格式结构输出


但非100%成功率，存在一些需要额外检测和适当处理的edge case。



  Handling edge cases
  
    根据OpenAI官方文档提供的处理方案
    https://platform.openai.com/docs/guides/structured-outputs/json-mode
      we_did_not_specify_stop_tokens = True
      
      try:
          response = client.chat.completions.create(
              model=&#34;gpt-3.5-turbo-0125&#34;,
              messages=[
                  {&#34;role&#34;: &#34;system&#34;, &#34;content&#34;: &#34;You are a helpful assistant designed to output JSON.&#34;},
                  {&#34;role&#34;: &#34;user&#34;, &#34;content&#34;: &#34;Who won the world series in 2020? Please respond in the format {winner: ...}&#34;}
              ],
              response_format={&#34;type&#34;: &#34;json_object&#34;}
          )
      
          # Check if the conversation was too long for the context window, resulting in incomplete JSON 
          if response.choices[0].message.finish_reason == &#34;length&#34;:
              # your code should handle this error case
              pass
      
          # Check if the OpenAI safety system refused the request and generated a refusal instead
          if response.choices[0].message[0].get(&#34;refusal&#34;):
              # your code should handle this error case
              # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing
              print(response.choices[0].message[0][&#34;refusal&#34;])
      
          # Check if the model&#39;s output included restricted content, so the generation of JSON was halted and may be partial
          if response.choices[0].message.finish_reason == &#34;content_filter&#34;:
              # your code should handle this error case
              pass
      
          if response.choices[0].message.finish_reason == &#34;stop&#34;:
              # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a &#34;stop token&#34;
      
              if we_did_not_specify_stop_tokens:
                  # If you didn&#39;t specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object
                  # This is guaranteed to parse successfully and should now contain  &#34;{&#34;winner&#34;: &#34;Los Angeles Dodgers&#34;}&#34;
                  print(response.choices[0].message.content)
              else:
                  # Check if the response.choices[0].message.content ends with one of your stop tokens and handle appropriately
                  pass
      except Exception as e:
          # Your code should handle errors here, for example a network error calling the API
          print(e)
  
  
    使用pydantic的方案
    使用pydantic的方案
      from pydantic import BaseModel, EmailStr, ValidationError
      
      # 定义你期望的 JSON 数据模型
      class UserModel(BaseModel):
          name: str
          age: int
          email: EmailStr
      
      # 检查 JSON 是否符合模型的函数
      def validate_json(json_str):
          try:
              # 将输入的 JSON 字符串转换为 UserModel 实例
              user = UserModel.parse_raw(json_str)
              
              # 如果验证通过，返回字典
              return user.dict()
          except ValidationError as ve:
              print(f&#34;JSON validation error: {ve.json()}&#34;)
              return None
      
      # 示例用法
      json_str = &#39;{&#34;name&#34;: &#34;John Doe&#34;, &#34;email&#34;: &#34;john.doe@example.com&#34;}&#39;
      validated_json = validate_json(json_str)
      
      if validated_json is not None:
          print(&#34;JSON is valid and conforms to the schema:&#34;)
          print(validated_json)
      else:
          print(&#34;JSON is invalid.&#34;)
  

Json-Mode 更多是对于输出json的格式进行检查(即Json格式的有效性)" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://localhost:1313/posts/llm-%E8%BE%93%E5%87%BA%E9%99%90%E5%88%B6structured-outputs%E5%8F%97%E9%99%90%E7%BC%96%E7%A0%81%E5%92%8C%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B/" />
<meta property="og:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-08-21T14:49:00+08:00" />
<meta property="article:modified_time" content="2024-08-21T14:49:00+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="http://localhost:1313/images/papermod-cover.png" />
<meta name="twitter:title" content="LLM 输出限制：Structured Outputs、受限编码和提示词工程"/>
<meta name="twitter:description" content="在使用大型语言模型（LLM）时，我们常常面临一个挑战：如何从模型输出中准确提取自己所需的信息。例如，当我们希望模型输出 JSON 格式的数据时，由于模型生成的内容并不总是稳定，可能需要额外编写大量的正则表达式来匹配并提取其中的有效信息。然而，由于 LLM 的能力，导致其输出结构并不永远可靠。
现阶段， 让LLM按要求生成特定格式文本的主要方法有几种种：


微调：使模型的输出遵循特定格式


OpenAI Json-mode/Structured Outputs/function-calling: 这些功能允许模型生成更严格、结构化的输出，但受限于openAI平台。


格式约束：在decoding阶段进行约束，限制模型的输出，


Prompt Engineering： 最简单的办法，但不稳定。


多阶段prompting： 通过多个步骤的提示逐步引导模型生成所需的格式。


本文将聚焦在Structured Outputs， 受限编码， 和prompt-engineering的角度，探讨它们在生成特定格式文本中的应用和效果。
Json Mode
仅特定模型和平台支持
以openAI 为例， 在openai.chat.completions.create 参数中增加response_format={&quot;type&quot;:&quot;json_object&quot;} 即可（具体参见：response_format ）。


需要在prompt中要求输出json格式


不能保证完全按要求的格式结构输出


但非100%成功率，存在一些需要额外检测和适当处理的edge case。



  Handling edge cases
  
    根据OpenAI官方文档提供的处理方案
    https://platform.openai.com/docs/guides/structured-outputs/json-mode
      we_did_not_specify_stop_tokens = True
      
      try:
          response = client.chat.completions.create(
              model=&#34;gpt-3.5-turbo-0125&#34;,
              messages=[
                  {&#34;role&#34;: &#34;system&#34;, &#34;content&#34;: &#34;You are a helpful assistant designed to output JSON.&#34;},
                  {&#34;role&#34;: &#34;user&#34;, &#34;content&#34;: &#34;Who won the world series in 2020? Please respond in the format {winner: ...}&#34;}
              ],
              response_format={&#34;type&#34;: &#34;json_object&#34;}
          )
      
          # Check if the conversation was too long for the context window, resulting in incomplete JSON 
          if response.choices[0].message.finish_reason == &#34;length&#34;:
              # your code should handle this error case
              pass
      
          # Check if the OpenAI safety system refused the request and generated a refusal instead
          if response.choices[0].message[0].get(&#34;refusal&#34;):
              # your code should handle this error case
              # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing
              print(response.choices[0].message[0][&#34;refusal&#34;])
      
          # Check if the model&#39;s output included restricted content, so the generation of JSON was halted and may be partial
          if response.choices[0].message.finish_reason == &#34;content_filter&#34;:
              # your code should handle this error case
              pass
      
          if response.choices[0].message.finish_reason == &#34;stop&#34;:
              # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a &#34;stop token&#34;
      
              if we_did_not_specify_stop_tokens:
                  # If you didn&#39;t specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object
                  # This is guaranteed to parse successfully and should now contain  &#34;{&#34;winner&#34;: &#34;Los Angeles Dodgers&#34;}&#34;
                  print(response.choices[0].message.content)
              else:
                  # Check if the response.choices[0].message.content ends with one of your stop tokens and handle appropriately
                  pass
      except Exception as e:
          # Your code should handle errors here, for example a network error calling the API
          print(e)
  
  
    使用pydantic的方案
    使用pydantic的方案
      from pydantic import BaseModel, EmailStr, ValidationError
      
      # 定义你期望的 JSON 数据模型
      class UserModel(BaseModel):
          name: str
          age: int
          email: EmailStr
      
      # 检查 JSON 是否符合模型的函数
      def validate_json(json_str):
          try:
              # 将输入的 JSON 字符串转换为 UserModel 实例
              user = UserModel.parse_raw(json_str)
              
              # 如果验证通过，返回字典
              return user.dict()
          except ValidationError as ve:
              print(f&#34;JSON validation error: {ve.json()}&#34;)
              return None
      
      # 示例用法
      json_str = &#39;{&#34;name&#34;: &#34;John Doe&#34;, &#34;email&#34;: &#34;john.doe@example.com&#34;}&#39;
      validated_json = validate_json(json_str)
      
      if validated_json is not None:
          print(&#34;JSON is valid and conforms to the schema:&#34;)
          print(validated_json)
      else:
          print(&#34;JSON is invalid.&#34;)
  

Json-Mode 更多是对于输出json的格式进行检查(即Json格式的有效性)"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "http://localhost:1313/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "LLM 输出限制：Structured Outputs、受限编码和提示词工程",
      "item": "http://localhost:1313/posts/llm-%E8%BE%93%E5%87%BA%E9%99%90%E5%88%B6structured-outputs%E5%8F%97%E9%99%90%E7%BC%96%E7%A0%81%E5%92%8C%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "LLM 输出限制：Structured Outputs、受限编码和提示词工程",
  "name": "LLM 输出限制：Structured Outputs、受限编码和提示词工程",
  "description": "在使用大型语言模型（LLM）时，我们常常面临一个挑战：如何从模型输出中准确提取自己所需的信息。例如，当我们希望模型输出 JSON 格式的数据时，由于模型生成的内容并不总是稳定，可能需要额外编写大量的正则表达式来匹配并提取其中的有效信息。然而，由于 LLM 的能力，导致其输出结构并不永远可靠。\n现阶段， 让LLM按要求生成特定格式文本的主要方法有几种种：\n微调：使模型的输出遵循特定格式\nOpenAI Json-mode/Structured Outputs/function-calling: 这些功能允许模型生成更严格、结构化的输出，但受限于openAI平台。\n格式约束：在decoding阶段进行约束，限制模型的输出，\nPrompt Engineering： 最简单的办法，但不稳定。\n多阶段prompting： 通过多个步骤的提示逐步引导模型生成所需的格式。\n本文将聚焦在Structured Outputs， 受限编码， 和prompt-engineering的角度，探讨它们在生成特定格式文本中的应用和效果。\nJson Mode 仅特定模型和平台支持\n以openAI 为例， 在openai.chat.completions.create 参数中增加response_format={\u0026quot;type\u0026quot;:\u0026quot;json_object\u0026quot;} 即可（具体参见：response_format ）。\n需要在prompt中要求输出json格式\n不能保证完全按要求的格式结构输出\n但非100%成功率，存在一些需要额外检测和适当处理的edge case。\nHandling edge cases 根据OpenAI官方文档提供的处理方案 https://platform.openai.com/docs/guides/structured-outputs/json-mode we_did_not_specify_stop_tokens = True try: response = client.chat.completions.create( model=\u0026#34;gpt-3.5-turbo-0125\u0026#34;, messages=[ {\u0026#34;role\u0026#34;: \u0026#34;system\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;You are a helpful assistant designed to output JSON.\u0026#34;}, {\u0026#34;role\u0026#34;: \u0026#34;user\u0026#34;, \u0026#34;content\u0026#34;: \u0026#34;Who won the world series in 2020? Please respond in the format {winner: ...}\u0026#34;} ], response_format={\u0026#34;type\u0026#34;: \u0026#34;json_object\u0026#34;} ) # Check if the conversation was too long for the context window, resulting in incomplete JSON if response.choices[0].message.finish_reason == \u0026#34;length\u0026#34;: # your code should handle this error case pass # Check if the OpenAI safety system refused the request and generated a refusal instead if response.choices[0].message[0].get(\u0026#34;refusal\u0026#34;): # your code should handle this error case # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing print(response.choices[0].message[0][\u0026#34;refusal\u0026#34;]) # Check if the model\u0026#39;s output included restricted content, so the generation of JSON was halted and may be partial if response.choices[0].message.finish_reason == \u0026#34;content_filter\u0026#34;: # your code should handle this error case pass if response.choices[0].message.finish_reason == \u0026#34;stop\u0026#34;: # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a \u0026#34;stop token\u0026#34; if we_did_not_specify_stop_tokens: # If you didn\u0026#39;t specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object # This is guaranteed to parse successfully and should now contain \u0026#34;{\u0026#34;winner\u0026#34;: \u0026#34;Los Angeles Dodgers\u0026#34;}\u0026#34; print(response.choices[0].message.content) else: # Check if the response.choices[0].message.content ends with one of your stop tokens and handle appropriately pass except Exception as e: # Your code should handle errors here, for example a network error calling the API print(e) 使用pydantic的方案 使用pydantic的方案 from pydantic import BaseModel, EmailStr, ValidationError # 定义你期望的 JSON 数据模型 class UserModel(BaseModel): name: str age: int email: EmailStr # 检查 JSON 是否符合模型的函数 def validate_json(json_str): try: # 将输入的 JSON 字符串转换为 UserModel 实例 user = UserModel.parse_raw(json_str) # 如果验证通过，返回字典 return user.dict() except ValidationError as ve: print(f\u0026#34;JSON validation error: {ve.json()}\u0026#34;) return None # 示例用法 json_str = \u0026#39;{\u0026#34;name\u0026#34;: \u0026#34;John Doe\u0026#34;, \u0026#34;email\u0026#34;: \u0026#34;john.doe@example.com\u0026#34;}\u0026#39; validated_json = validate_json(json_str) if validated_json is not None: print(\u0026#34;JSON is valid and conforms to the schema:\u0026#34;) print(validated_json) else: print(\u0026#34;JSON is invalid.\u0026#34;) Json-Mode 更多是对于输出json的格式进行检查(即Json格式的有效性)\n",
  "keywords": [
    "Agent", "LLM"
  ],
  "articleBody": "在使用大型语言模型（LLM）时，我们常常面临一个挑战：如何从模型输出中准确提取自己所需的信息。例如，当我们希望模型输出 JSON 格式的数据时，由于模型生成的内容并不总是稳定，可能需要额外编写大量的正则表达式来匹配并提取其中的有效信息。然而，由于 LLM 的能力，导致其输出结构并不永远可靠。\n现阶段， 让LLM按要求生成特定格式文本的主要方法有几种种：\n微调：使模型的输出遵循特定格式\nOpenAI Json-mode/Structured Outputs/function-calling: 这些功能允许模型生成更严格、结构化的输出，但受限于openAI平台。\n格式约束：在decoding阶段进行约束，限制模型的输出，\nPrompt Engineering： 最简单的办法，但不稳定。\n多阶段prompting： 通过多个步骤的提示逐步引导模型生成所需的格式。\n本文将聚焦在Structured Outputs， 受限编码， 和prompt-engineering的角度，探讨它们在生成特定格式文本中的应用和效果。\nJson Mode 仅特定模型和平台支持\n以openAI 为例， 在openai.chat.completions.create 参数中增加response_format={\"type\":\"json_object\"} 即可（具体参见：response_format ）。\n需要在prompt中要求输出json格式\n不能保证完全按要求的格式结构输出\n但非100%成功率，存在一些需要额外检测和适当处理的edge case。\nHandling edge cases 根据OpenAI官方文档提供的处理方案 https://platform.openai.com/docs/guides/structured-outputs/json-mode we_did_not_specify_stop_tokens = True try: response = client.chat.completions.create( model=\"gpt-3.5-turbo-0125\", messages=[ {\"role\": \"system\", \"content\": \"You are a helpful assistant designed to output JSON.\"}, {\"role\": \"user\", \"content\": \"Who won the world series in 2020? Please respond in the format {winner: ...}\"} ], response_format={\"type\": \"json_object\"} ) # Check if the conversation was too long for the context window, resulting in incomplete JSON if response.choices[0].message.finish_reason == \"length\": # your code should handle this error case pass # Check if the OpenAI safety system refused the request and generated a refusal instead if response.choices[0].message[0].get(\"refusal\"): # your code should handle this error case # In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing print(response.choices[0].message[0][\"refusal\"]) # Check if the model's output included restricted content, so the generation of JSON was halted and may be partial if response.choices[0].message.finish_reason == \"content_filter\": # your code should handle this error case pass if response.choices[0].message.finish_reason == \"stop\": # In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a \"stop token\" if we_did_not_specify_stop_tokens: # If you didn't specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object # This is guaranteed to parse successfully and should now contain \"{\"winner\": \"Los Angeles Dodgers\"}\" print(response.choices[0].message.content) else: # Check if the response.choices[0].message.content ends with one of your stop tokens and handle appropriately pass except Exception as e: # Your code should handle errors here, for example a network error calling the API print(e) 使用pydantic的方案 使用pydantic的方案 from pydantic import BaseModel, EmailStr, ValidationError # 定义你期望的 JSON 数据模型 class UserModel(BaseModel): name: str age: int email: EmailStr # 检查 JSON 是否符合模型的函数 def validate_json(json_str): try: # 将输入的 JSON 字符串转换为 UserModel 实例 user = UserModel.parse_raw(json_str) # 如果验证通过，返回字典 return user.dict() except ValidationError as ve: print(f\"JSON validation error: {ve.json()}\") return None # 示例用法 json_str = '{\"name\": \"John Doe\", \"email\": \"john.doe@example.com\"}' validated_json = validate_json(json_str) if validated_json is not None: print(\"JSON is valid and conforms to the schema:\") print(validated_json) else: print(\"JSON is invalid.\") Json-Mode 更多是对于输出json的格式进行检查(即Json格式的有效性)\nStructured Outputs 在模型升级到2024-08-06版本后， OpenAI增加了Structured Outputs功能。\n其旨在保证模型始终生成符合所提供的JSON Schema的响应，而无需处理edge case，以及json内容错误。\n其优势在于：\n无需验证或重试格式不正确的响应\n可通过编程检测模型是否安全生成（在API返回结果中增加了\"refusal”字段）\n无需复杂的prompt用于限制输出结构\n相较于Json-Mode， 虽然两者都确保生成有效的JSON，但只有Structured Outputs能确保输出json-schema的一致性。因此理论上无需额外的json-schema检查的代码步骤。\n如何使用 以官方文档所提供的`Structured data extraction`为例：\nfrom pydantic import BaseModel from openai import OpenAI client = OpenAI() class ResearchPaperExtraction(BaseModel): title: str authors: list[str] abstract: str keywords: list[str] completion = client.beta.chat.completions.parse( model=\"gpt-4o-2024-08-06\", messages=[ {\"role\": \"system\", \"content\": \"You are an expert at structured data extraction. You will be given unstructured text from a research paper and should convert it into the given structure.\"}, {\"role\": \"user\", \"content\": \"...\"} ], response_format=ResearchPaperExtraction, ) research_paper = completion.choices[0].message.parsed output { \"title\": \"Application of Quantum Algorithms in Interstellar Navigation: A New Frontier\", \"authors\": [ \"Dr. Stella Voyager\", \"Dr. Nova Star\", \"Dr. Lyra Hunter\" ], \"abstract\": \"This paper investigates the utilization of quantum algorithms to improve interstellar navigation systems. By leveraging quantum superposition and entanglement, our proposed navigation system can calculate optimal travel paths through space-time anomalies more efficiently than classical methods. Experimental simulations suggest a significant reduction in travel time and fuel consumption for interstellar missions.\", \"keywords\": [ \"Quantum algorithms\", \"interstellar navigation\", \"space-time anomalies\", \"quantum superposition\", \"quantum entanglement\", \"space travel\" ] } 和在LLM输出的结果中通过`pydantic`进行格式检查类似，只是直接将格式要求传给了模型，减少了额外工作。 等价于\n... \"response_format\": { \"type\": \"json_schema\", \"json_schema\": { \"name\": \"research_paper_extraction\", \"schema\": { \"type\": \"object\", \"properties\": { \"title\": { \"type\": \"string\" }, \"authors\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } }, \"abstract\": { \"type\": \"string\" }, \"keywords\": { \"type\": \"array\", \"items\": { \"type\": \"string\" } } }, \"required\": [\"title\", \"authors\", \"abstract\", \"keywords\"], \"additionalProperties\": false }, \"strict\": true } } 此外， 文档中还提供了COT的Structured Outputs例子\nChain of thought\nfrom pydantic import BaseModel from openai import OpenAI client = OpenAI() class Step(BaseModel): explanation: str output: str class MathReasoning(BaseModel): steps: list[Step] final_answer: str completion = client.beta.chat.completions.parse( model=\"gpt-4o-2024-08-06\", messages=[ {\"role\": \"system\", \"content\": \"You are a helpful math tutor. Guide the user through the solution step by step.\"}, {\"role\": \"user\", \"content\": \"how can I solve 8x + 7 = -23\"} ], response_format=MathReasoning, ) math_reasoning = completion.choices[0].message.parsed output:\n{ \"steps\": [ { \"explanation\": \"Start with the equation 8x + 7 = -23.\", \"output\": \"8x + 7 = -23\" }, { \"explanation\": \"Subtract 7 from both sides to isolate the term with the variable.\", \"output\": \"8x = -23 - 7\" }, { \"explanation\": \"Simplify the right side of the equation.\", \"output\": \"8x = -30\" }, { \"explanation\": \"Divide both sides by 8 to solve for x.\", \"output\": \"x = -30 / 8\" }, { \"explanation\": \"Simplify the fraction.\", \"output\": \"x = -15 / 4\" } ], \"final_answer\": \"x = -15 / 4\" } 相比于之前普通版本的COT：\n在测试阶段，程序化检查中间Chain的中间过程变得更加简单\n更优美的提取最终结果\n限制分析过程中的每一步格式，以提高正确率？\nOpenAI API中提供了两种形式的Structured Outputs\nFunction Calling\n使用 json_schema 响应格式\n在function calling （tool-using）时， 在定义tools时需增加\"strict\": true 字段，如：\ntools = [ { \"type\": \"function\", \"function\": { \"name\": \"get_delivery_date\", \"description\": \"Get the delivery date for a customer's order. Call this whenever you need to know the delivery date, for example when a customer asks 'Where is my package'\", \"parameters\": { \"type\": \"object\", \"properties\": { \"order_id\": { \"type\": \"string\", \"description\": \"The customer's order ID.\", }, }, \"required\": [\"order_id\"], \"additionalProperties\": False, }, }, \"strict\": True, } ] 注意：\"strict\": true,会产生一定的延迟（10s以下）\nStructured Outputs功能引入了一个新的字段refusal，用于在模型拒绝执行请求时提供反馈。当用户生成的输入时，模型可能会因为安全原因拒绝履行请求，此时API响应会包含一个名为“refusal”的新字段来指示模型拒绝了请求。当API响应中出现refusal字段时，开发者可以程序化地检测到模型生成了拒绝而不是符合模式的输出。\nConstrained Decoding What Is Constrained Decoding constrained decoding is a technique that manipulates a generative model’s token generation process to constrain its next-token predictions to only tokens that do not violate the required output structure.\n仅对严格需要生成的输出部分，从模型的下一个Token概率分布中的兼容Token集进行采样。\n简单来说，对于LLM的输出过程，模型会根据之前的词语序列，计算出下一个词可能出现的概率，并根据这个概率生成下一个词。这一过程会不断重复，直到生成完整的句子或段落（或遇到[EOS]标记）。在普通的生成过程中，模型的概率空间是所有可能的Token。\n相对而言，在引导生成（Guided Generation）过程中，模型的输出会受到额外的引导或约束，以确保生成的内容更加符合某些特定的要求或目标。这种引导可以通过调整概率分布、加入上下文信息、或施加额外规则来实现。\n具体来说， 对于给定的输入序列 $\\tilde{S}_t$ 和模型参数 $\\theta$，\n模型首先计算出一个未加约束的概率分布 $\\alpha$，表示下一个Token $\\tilde{s}_{t+1}$ 的可能性 ，\n$$ \\alpha = \\text{LM}(\\tilde{S}_t, \\theta) $$\n为了引入约束或限制，构造一个布尔掩码 $m$，这个掩码将限制下一个Token的选择范围。掩码函数 $m(\\tilde{S}_t)$将原始分布中的部分不符合约束条件的Token概率置为0，形成一个新的受限分布 $\\tilde{\\alpha}$：\n$$ \\tilde{\\alpha} = m(\\tilde{S}_t) \\odot \\alpha $$\n即在原始分布$\\alpha$ 上应用掩码 $m$，只保留那些满足约束条件的Token的概率，其他Token的概率被置为0。\n接下来，模型根据受限分布 $\\tilde{\\alpha}$ 进行采样，选择下一个Token $\\tilde{s}_{t+1}$\n$$ \\tilde{s}_{t+1} \\sim \\text{Categorical}(\\tilde{\\alpha}) $$\n这个步骤意味着模型只会从符合约束条件的Token集合中选择下一个Token，确保生成的输出遵循预定的规则或格式。\n以上内容出自 outlines的paper：Efficient Guided Generation for Large Language Model 具体内容可自行查看。\n以常见的Json格式约束为例（Fast JSON Decoding for Local LLMs with Compressed Finite State Machine），\n有多种框架可以利用本地模型实现约束解码， 如： outlines，SGLang等。\nvllm+outlines 实现结构化输出 依赖环境：\n! pip install vllm ! pip install openai ! pip install instructor 注意：需要使用到GPU，建议使用colab\n启动vllm模型服务，选择适合GPU显存大小的模型：\n#! vllm serve Qwen/Qwen1.5-4B-Chat --max_model_len=10000 ! vllm serve Qwen/Qwen1.5-1.8B --max_model_len=10000 引导生成json结构：\nfrom openai import OpenAI # Set OpenAI's API key and API base to use vLLM's API server. openai_api_key = \"EMPTY\" openai_api_base = \"http://localhost:8000/v1\" api_client = OpenAI(api_key='YOUR_API_KEY', base_url='http://localhost:8000/v1') model_name = api_client.models.list().data[0].id json_schema = { \"type\": \"object\", \"properties\": { \"thought\": {\"type\": \"string\"}, \"answer\": {\"type\": \"string\"} }, \"required\": [\"thought\", \"answer\"] } query = \"What is the capital of China?\" # Feed the random question into the existing query system_prompt = \"Respond only with a json object containing the following fields and nothing else: thought, answer.\" completion = api_client.chat.completions.create( model=model_name, messages=[ {\"role\": \"system\", \"content\": system_prompt}, {\"role\": \"user\", \"content\": query} ], extra_body={ \"stop_token_ids\": [128009], \"response_format\": {\"type\": \"json_object\"}, \"guided_json\": json_schema } ) 输出：\nprint(completion.choices[0].message.content.strip()) # {\"thought\": \"What is the capital of China?\", \"answer\": \"Beijing\"} 另一个例子， 引导生成符合结构的《Harry Potter》角色属性：\n定义角色属性结构\nfrom openai import OpenAI from pydantic import BaseModel, Field import base64 import instructor import time from enum import Enum from typing import List from glob import glob class Property(BaseModel): key: str = Field(description=\"Must be snake case\") value: str class House(Enum): Griffindor = \"gryffindor\" Hufflepuff = \"hufflepuff\" Ravenclaw = \"ravenclaw\" Slytherin = \"slytherin\" Targaryen = \"targaryen\" # This schema is what guides generation class Character(BaseModel): name: str age: int house: House properties: List[Property] api_client = OpenAI(api_key='YOUR_API_KEY', base_url='http://localhost:8000/v1') client = instructor.from_openai(api_client, mode=instructor.Mode.MD_JSON) model_name = api_client.models.list().data[0].id system_prompt = \"\"\"\\ You are a highly creative assistant tasked with generating fictional characters for a fantasy novel. Each character belongs to a specific house, and their properties should reflect their house's traits. However, ensure that the characters are entirely original and do not directly reference or resemble any characters, events, or settings from the Harry Potter series. Avoid using names, events, or any elements that would make the character too similar to existing Harry Potter content. The goal is to create unique and novel characters that can stand on their own in a fantasy world. \"\"\" def run(name): try: response = client.chat.completions.create( model=model_name, response_model=Character, messages=[ { 'role': 'system', 'content': system_prompt }, { 'role': 'user', 'content': name } ], temperature=0.1, # Adjust temperature for creativity ) return response except Exception as e: print(f\"An error occurred: {e}\") return None # Example usage character_name = \"Voldemort\" character = run(character_name) if character: print(character) else: print(\"Failed to generate character.\") # name='Voldemort' age=50 house=",
  "wordCount" : "2262",
  "inLanguage": "en",
  "image": "http://localhost:1313/images/papermod-cover.png","datePublished": "2024-08-21T14:49:00+08:00",
  "dateModified": "2024-08-21T14:49:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Theme PaperMod"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "http://localhost:1313/posts/llm-%E8%BE%93%E5%87%BA%E9%99%90%E5%88%B6structured-outputs%E5%8F%97%E9%99%90%E7%BC%96%E7%A0%81%E5%92%8C%E6%8F%90%E7%A4%BA%E8%AF%8D%E5%B7%A5%E7%A8%8B/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LZY Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "http://localhost:1313/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="http://localhost:1313/" accesskey="h" title="LZY Blog (Alt + H)">LZY Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="http://localhost:1313/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/posts/" title="AI">
                    <span>AI</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/musik/" title="Musik!">
                    <span>Musik!</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/monthly/" title="月刊">
                    <span>月刊</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/essay/" title="杂文">
                    <span>杂文</span>
                </a>
            </li>
            <li>
                <a href="http://localhost:1313/travel/" title="游记">
                    <span>游记</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="http://localhost:1313/">Home</a>&nbsp;»&nbsp;<a href="http://localhost:1313/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      LLM 输出限制：Structured Outputs、受限编码和提示词工程
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
    </h1>
    <div class="post-meta"><span title='2024-08-21 14:49:00 +0800 CST'>August 21, 2024</span>&nbsp;·&nbsp;11 min&nbsp;·&nbsp;Theme PaperMod

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#json-mode" aria-label="Json Mode">Json Mode</a></li>
                <li>
                    <a href="#structured-outputs" aria-label="Structured Outputs">Structured Outputs</a><ul>
                        
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8" aria-label="如何使用">如何使用</a></li></ul>
                </li>
                <li>
                    <a href="#constrained-decoding" aria-label="Constrained Decoding">Constrained Decoding</a><ul>
                        
                <li>
                    <a href="#what-is-constrained-decoding" aria-label="What Is Constrained Decoding">What Is Constrained Decoding</a></li>
                <li>
                    <a href="#vllmoutlines-%e5%ae%9e%e7%8e%b0%e7%bb%93%e6%9e%84%e5%8c%96%e8%be%93%e5%87%ba" aria-label="vllm&#43;outlines 实现结构化输出">vllm+outlines 实现结构化输出</a></li></ul>
                </li>
                <li>
                    <a href="#prompt-based-methods" aria-label="Prompt-based Methods">Prompt-based Methods</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="参考">参考</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>在使用大型语言模型（LLM）时，我们常常面临一个挑战：如何从模型输出中准确提取自己所需的信息。例如，当我们希望模型输出 JSON 格式的数据时，由于模型生成的内容并不总是稳定，可能需要额外编写大量的正则表达式来匹配并提取其中的有效信息。然而，由于 LLM 的能力，导致其输出结构并不永远可靠。</p>
<p>现阶段， 让LLM按要求生成特定格式文本的主要方法有几种种：</p>
<ul>
<li>
<p>微调：使模型的输出遵循特定格式</p>
</li>
<li>
<p><strong>OpenAI Json-mode/Structured Outputs/function-calling:</strong> 这些功能允许模型生成更严格、结构化的输出，但受限于openAI平台。</p>
</li>
<li>
<p><strong>格式约束</strong>：在decoding阶段进行约束，限制模型的输出，</p>
</li>
<li>
<p><strong>Prompt Engineering</strong>： 最简单的办法，但不稳定。</p>
</li>
<li>
<p>多阶段prompting： 通过多个步骤的提示逐步引导模型生成所需的格式。</p>
</li>
</ul>
<p>本文将聚焦在Structured Outputs， 受限编码， 和prompt-engineering的角度，探讨它们在生成特定格式文本中的应用和效果。</p>
<h2 id="json-mode">Json Mode<a hidden class="anchor" aria-hidden="true" href="#json-mode">#</a></h2>
<p>仅特定模型和平台支持</p>
<p>以openAI 为例， 在<code>openai.chat.completions.create</code> 参数中增加<code>response_format={&quot;type&quot;:&quot;json_object&quot;}</code> 即可（具体参见：<a href="https://platform.openai.com/docs/api-reference/chat/create#chat-create-response_format">response_format</a> ）。</p>
<ul>
<li>
<p>需要在prompt中要求输出json格式</p>
</li>
<li>
<p>不能保证完全按要求的格式结构输出</p>
</li>
<li>
<p>但非100%成功率，存在一些需要额外检测和适当处理的edge case。</p>
</li>
</ul>
<details>
  <summary>Handling edge cases</summary>
  <details>
    <summary>根据OpenAI官方文档提供的处理方案</summary>
    https://platform.openai.com/docs/guides/structured-outputs/json-mode
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">      <span class="n">we_did_not_specify_stop_tokens</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gpt-3.5-turbo-0125&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                  <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;You are a helpful assistant designed to output JSON.&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">                  <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Who won the world series in 2020? Please respond in the format {winner: ...}&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="p">],</span>
</span></span><span class="line"><span class="cl">              <span class="n">response_format</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;json_object&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">)</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">          <span class="c1"># Check if the conversation was too long for the context window, resulting in incomplete JSON </span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">finish_reason</span> <span class="o">==</span> <span class="s2">&#34;length&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># your code should handle this error case</span>
</span></span><span class="line"><span class="cl">              <span class="k">pass</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">          <span class="c1"># Check if the OpenAI safety system refused the request and generated a refusal instead</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;refusal&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># your code should handle this error case</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># In this case, the .content field will contain the explanation (if any) that the model generated for why it is refusing</span>
</span></span><span class="line"><span class="cl">              <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;refusal&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">          <span class="c1"># Check if the model&#39;s output included restricted content, so the generation of JSON was halted and may be partial</span>
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">finish_reason</span> <span class="o">==</span> <span class="s2">&#34;content_filter&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># your code should handle this error case</span>
</span></span><span class="line"><span class="cl">              <span class="k">pass</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">          <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">finish_reason</span> <span class="o">==</span> <span class="s2">&#34;stop&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># In this case the model has either successfully finished generating the JSON object according to your schema, or the model generated one of the tokens you provided as a &#34;stop token&#34;</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="n">we_did_not_specify_stop_tokens</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="c1"># If you didn&#39;t specify any stop tokens, then the generation is complete and the content key will contain the serialized JSON object</span>
</span></span><span class="line"><span class="cl">                  <span class="c1"># This is guaranteed to parse successfully and should now contain  &#34;{&#34;winner&#34;: &#34;Los Angeles Dodgers&#34;}&#34;</span>
</span></span><span class="line"><span class="cl">                  <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                  <span class="c1"># Check if the response.choices[0].message.content ends with one of your stop tokens and handle appropriately</span>
</span></span><span class="line"><span class="cl">                  <span class="k">pass</span>
</span></span><span class="line"><span class="cl">      <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="c1"># Your code should handle errors here, for example a network error calling the API</span>
</span></span><span class="line"><span class="cl">          <span class="nb">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</span></span></code></pre></div>  </details>
  <details>
    <summary>使用pydantic的方案</summary>
    使用pydantic的方案
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">      <span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">EmailStr</span><span class="p">,</span> <span class="n">ValidationError</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="c1"># 定义你期望的 JSON 数据模型</span>
</span></span><span class="line"><span class="cl">      <span class="k">class</span> <span class="nc">UserModel</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">          <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">          <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">          <span class="n">email</span><span class="p">:</span> <span class="n">EmailStr</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="c1"># 检查 JSON 是否符合模型的函数</span>
</span></span><span class="line"><span class="cl">      <span class="k">def</span> <span class="nf">validate_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">          <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">              <span class="c1"># 将输入的 JSON 字符串转换为 UserModel 实例</span>
</span></span><span class="line"><span class="cl">              <span class="n">user</span> <span class="o">=</span> <span class="n">UserModel</span><span class="o">.</span><span class="n">parse_raw</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              
</span></span><span class="line"><span class="cl">              <span class="c1"># 如果验证通过，返回字典</span>
</span></span><span class="line"><span class="cl">              <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">dict</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">          <span class="k">except</span> <span class="n">ValidationError</span> <span class="k">as</span> <span class="n">ve</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">              <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;JSON validation error: </span><span class="si">{</span><span class="n">ve</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">              <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="c1"># 示例用法</span>
</span></span><span class="line"><span class="cl">      <span class="n">json_str</span> <span class="o">=</span> <span class="s1">&#39;{&#34;name&#34;: &#34;John Doe&#34;, &#34;email&#34;: &#34;john.doe@example.com&#34;}&#39;</span>
</span></span><span class="line"><span class="cl">      <span class="n">validated_json</span> <span class="o">=</span> <span class="n">validate_json</span><span class="p">(</span><span class="n">json_str</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="n">validated_json</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;JSON is valid and conforms to the schema:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">          <span class="nb">print</span><span class="p">(</span><span class="n">validated_json</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">          <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;JSON is invalid.&#34;</span><span class="p">)</span>
</span></span></code></pre></div>  </details>
</details>
<p>Json-Mode 更多是对于输出json的格式进行检查(即Json格式的有效性)</p>
<h2 id="structured-outputs">Structured Outputs<a hidden class="anchor" aria-hidden="true" href="#structured-outputs">#</a></h2>
<p>在模型升级到2024-08-06版本后， OpenAI增加了<a href="https://platform.openai.com/docs/guides/structured-outputs/introduction">Structured Outputs</a>功能。</p>
<p>其旨在保证模型始终生成符合所提供的JSON Schema的响应，而无需处理edge case，以及json内容错误。</p>
<p>其优势在于：</p>
<ul>
<li>
<p>无需验证或重试格式不正确的响应</p>
</li>
<li>
<p>可通过编程检测模型是否安全生成（在API返回结果中增加了&quot;refusal”字段）</p>
</li>
<li>
<p>无需复杂的prompt用于限制输出结构</p>
</li>
</ul>
<p>相较于Json-Mode， 虽然两者都确保生成有效的JSON，但只有<strong>Structured Outputs能</strong>确保输出json-schema的一致性。因此理论上无需额外的json-schema检查的代码步骤。</p>
<h3 id="如何使用">如何使用<a hidden class="anchor" aria-hidden="true" href="#如何使用">#</a></h3>
<p>以官方文档所提供的`<strong><a href="https://platform.openai.com/docs/guides/structured-outputs/structured-data-extraction">Structured data extraction</a></strong>`为例：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ResearchPaperExtraction</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">authors</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">abstract</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">keywords</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gpt-4o-2024-08-06&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;You are an expert at structured data extraction. You will be given unstructured text from a research paper and should convert it into the given structure.&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;...&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">response_format</span><span class="o">=</span><span class="n">ResearchPaperExtraction</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">research_paper</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">parsed</span>
</span></span></code></pre></div><details>
    <summary>output</summary>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">   <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="s2">&#34;title&#34;</span><span class="p">:</span> <span class="s2">&#34;Application of Quantum Algorithms in Interstellar Navigation: A New Frontier&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="s2">&#34;authors&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;Dr. Stella Voyager&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;Dr. Nova Star&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;Dr. Lyra Hunter&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">],</span>
</span></span><span class="line"><span class="cl">     <span class="s2">&#34;abstract&#34;</span><span class="p">:</span> <span class="s2">&#34;This paper investigates the utilization of quantum algorithms to improve interstellar navigation systems. By leveraging quantum superposition and entanglement, our proposed navigation system can calculate optimal travel paths through space-time anomalies more efficiently than classical methods. Experimental simulations suggest a significant reduction in travel time and fuel consumption for interstellar missions.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">     <span class="s2">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;Quantum algorithms&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;interstellar navigation&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;space-time anomalies&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;quantum superposition&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;quantum entanglement&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="s2">&#34;space travel&#34;</span>
</span></span><span class="line"><span class="cl">     <span class="p">]</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span></code></pre></div></details>
和在LLM输出的结果中通过`pydantic`进行格式检查类似，只是直接将格式要求传给了模型，减少了额外工作。
<p>等价于</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">...</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;response_format&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;json_schema&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;json_schema&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;research_paper_extraction&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;schema&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;title&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;authors&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;array&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;items&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;abstract&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;keywords&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;array&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="s2">&#34;items&#34;</span><span class="p">:</span> <span class="p">{</span> <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;title&#34;</span><span class="p">,</span> <span class="s2">&#34;authors&#34;</span><span class="p">,</span> <span class="s2">&#34;abstract&#34;</span><span class="p">,</span> <span class="s2">&#34;keywords&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;additionalProperties&#34;</span><span class="p">:</span> <span class="n">false</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;strict&#34;</span><span class="p">:</span> <span class="n">true</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span></code></pre></div><p>此外， 文档中还提供了COT的<strong>Structured Outputs</strong>例子</p>
<p><strong><a href="https://platform.openai.com/docs/guides/structured-outputs/chain-of-thought">Chain of thought</a></strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">   <span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span>
</span></span><span class="line"><span class="cl">   <span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="k">class</span> <span class="nc">Step</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">       <span class="n">explanation</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">       <span class="n">output</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="k">class</span> <span class="nc">MathReasoning</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">       <span class="n">steps</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Step</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">       <span class="n">final_answer</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">beta</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">       <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gpt-4o-2024-08-06&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">       <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">           <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;You are a helpful math tutor. Guide the user through the solution step by step.&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">           <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;how can I solve 8x + 7 = -23&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="p">],</span>
</span></span><span class="line"><span class="cl">       <span class="n">response_format</span><span class="o">=</span><span class="n">MathReasoning</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">   <span class="p">)</span>
</span></span><span class="line"><span class="cl">   
</span></span><span class="line"><span class="cl">   <span class="n">math_reasoning</span> <span class="o">=</span> <span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">parsed</span>
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;steps&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;explanation&#34;</span><span class="p">:</span> <span class="s2">&#34;Start with the equation 8x + 7 = -23.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;output&#34;</span><span class="p">:</span> <span class="s2">&#34;8x + 7 = -23&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;explanation&#34;</span><span class="p">:</span> <span class="s2">&#34;Subtract 7 from both sides to isolate the term with the variable.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;output&#34;</span><span class="p">:</span> <span class="s2">&#34;8x = -23 - 7&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;explanation&#34;</span><span class="p">:</span> <span class="s2">&#34;Simplify the right side of the equation.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;output&#34;</span><span class="p">:</span> <span class="s2">&#34;8x = -30&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;explanation&#34;</span><span class="p">:</span> <span class="s2">&#34;Divide both sides by 8 to solve for x.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;output&#34;</span><span class="p">:</span> <span class="s2">&#34;x = -30 / 8&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;explanation&#34;</span><span class="p">:</span> <span class="s2">&#34;Simplify the fraction.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;output&#34;</span><span class="p">:</span> <span class="s2">&#34;x = -15 / 4&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">],</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;final_answer&#34;</span><span class="p">:</span> <span class="s2">&#34;x = -15 / 4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>相比于之前普通版本的COT：</p>
<ul>
<li>
<p>在测试阶段，程序化检查中间Chain的中间过程变得更加简单</p>
</li>
<li>
<p>更优美的提取最终结果</p>
</li>
<li>
<p>限制分析过程中的每一步格式，以提高正确率？</p>
</li>
</ul>
<p>OpenAI API中提供了两种形式的<strong>Structured Outputs</strong></p>
<ul>
<li>
<p>Function Calling</p>
</li>
<li>
<p>使用 <strong><code>json_schema</code></strong> 响应格式</p>
</li>
</ul>
<p>在function calling （tool-using）时， 在定义tools时需增加<code>&quot;strict&quot;: true</code> 字段，如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;get_delivery_date&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Get the delivery date for a customer&#39;s order. Call this whenever you need to know the delivery date, for example when a customer asks &#39;Where is my package&#39;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;order_id&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The customer&#39;s order ID.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;order_id&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;additionalProperties&#34;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;strict&#34;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>注意：<strong><code>&quot;strict&quot;: true</code></strong>,会产生一定的延迟（10s以下）</p>
<p>Structured Outputs功能引入了一个新的字段<code>refusal</code>，用于在模型拒绝执行请求时提供反馈。当用户生成的输入时，模型可能会因为安全原因拒绝履行请求，此时API响应会包含一个名为“refusal”的新字段来指示模型拒绝了请求。当API响应中出现<code>refusal</code>字段时，开发者可以程序化地检测到模型生成了拒绝而不是符合模式的输出。</p>
<h2 id="constrained-decoding">Constrained Decoding<a hidden class="anchor" aria-hidden="true" href="#constrained-decoding">#</a></h2>
<h3 id="what-is-constrained-decoding"><strong>What Is Constrained Decoding</strong><a hidden class="anchor" aria-hidden="true" href="#what-is-constrained-decoding">#</a></h3>
<blockquote>
<p>constrained decoding is a technique that manipulates a generative model&rsquo;s token generation process to <em>constrain</em> its next-token predictions to only tokens that do not violate the required output structure.</p>
</blockquote>
<p>仅对严格需要生成的输出部分，从模型的下一个Token概率分布中的兼容Token集进行采样。</p>
<p>简单来说，对于LLM的输出过程，模型会根据之前的词语序列，计算出下一个词可能出现的概率，并根据这个概率生成下一个词。这一过程会不断重复，直到生成完整的句子或段落（或遇到[EOS]标记）。在普通的生成过程中，模型的概率空间是所有可能的Token。</p>
<p>相对而言，在引导生成（Guided Generation）过程中，模型的输出会受到额外的引导或约束，以确保生成的内容更加符合某些特定的要求或目标。这种引导可以通过调整概率分布、加入上下文信息、或施加额外规则来实现。</p>
<p>具体来说， 对于给定的输入序列 $\tilde{S}_t$ 和模型参数 $\theta$，</p>
<p>模型首先计算出一个未加约束的概率分布 $\alpha$，表示下一个Token $\tilde{s}_{t+1}$ 的可能性 ，</p>
<p>$$
\alpha = \text{LM}(\tilde{S}_t, \theta)
$$</p>
<p>为了引入约束或限制，构造一个布尔掩码 $m$，这个掩码将限制下一个Token的选择范围。掩码函数 $m(\tilde{S}_t)$将原始分布中的部分不符合约束条件的Token概率置为0，形成一个新的受限分布 $\tilde{\alpha}$：</p>
<p>$$
\tilde{\alpha} = m(\tilde{S}_t) \odot \alpha
$$</p>
<p>即在原始分布$\alpha$ 上应用掩码 $m$，只保留那些满足约束条件的Token的概率，其他Token的概率被置为0。</p>
<p>接下来，模型根据受限分布 $\tilde{\alpha}$ 进行采样，选择下一个Token $\tilde{s}_{t+1}$</p>
<p>$$
\tilde{s}_{t+1} \sim \text{Categorical}(\tilde{\alpha})
$$</p>
<p>这个步骤意味着模型只会从符合约束条件的Token集合中选择下一个Token，确保生成的输出遵循预定的规则或格式。</p>
<p>以上内容出自 outlines的paper：<strong><a href="https://arxiv.org/abs/2307.09702?ref=aidancooper.co.uk">Efficient Guided Generation for Large Language Model</a></strong> 具体内容可自行查看。</p>
<p>以常见的Json格式约束为例（<strong><a href="https://lmsys.org/blog/2024-02-05-compressed-fsm/?ref=aidancooper.co.uk">Fast JSON Decoding for Local LLMs with Compressed Finite State Machine</a></strong>），</p>
<p>有多种框架可以利用本地模型实现约束解码， 如： outlines，SGLang等。</p>
<h3 id="vllmoutlines-实现结构化输出">vllm+outlines 实现结构化输出<a hidden class="anchor" aria-hidden="true" href="#vllmoutlines-实现结构化输出">#</a></h3>
<p>依赖环境：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">vllm</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">openai</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span> <span class="n">pip</span> <span class="n">install</span> <span class="n">instructor</span>
</span></span></code></pre></div><p>注意：需要使用到GPU，建议使用colab</p>
<p>启动vllm模型服务，选择适合GPU显存大小的模型：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="ch">#! vllm serve Qwen/Qwen1.5-4B-Chat --max_model_len=10000</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span> <span class="n">vllm</span> <span class="n">serve</span> <span class="n">Qwen</span><span class="o">/</span><span class="n">Qwen1</span><span class="mf">.5</span><span class="o">-</span><span class="mf">1.8</span><span class="n">B</span> <span class="o">--</span><span class="n">max_model_len</span><span class="o">=</span><span class="mi">10000</span>  
</span></span></code></pre></div><p>引导生成json结构：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Set OpenAI&#39;s API key and API base to use vLLM&#39;s API server.</span>
</span></span><span class="line"><span class="cl"><span class="n">openai_api_key</span> <span class="o">=</span> <span class="s2">&#34;EMPTY&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">openai_api_base</span> <span class="o">=</span> <span class="s2">&#34;http://localhost:8000/v1&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">api_client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;YOUR_API_KEY&#39;</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8000/v1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">model_name</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">list</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl"><span class="n">json_schema</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;thought&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;answer&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;thought&#34;</span><span class="p">,</span> <span class="s2">&#34;answer&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">query</span> <span class="o">=</span> <span class="s2">&#34;What is the capital of China?&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Feed the random question into the existing query</span>
</span></span><span class="line"><span class="cl"><span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&#34;Respond only with a json object containing the following fields and nothing else: thought, answer.&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">completion</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="n">system_prompt</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="n">query</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">extra_body</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;stop_token_ids&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mi">128009</span><span class="p">],</span> 
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;response_format&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;json_object&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;guided_json&#34;</span><span class="p">:</span> <span class="n">json_schema</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="c1"># {&#34;thought&#34;: &#34;What is the capital of China?&#34;, &#34;answer&#34;: &#34;Beijing&#34;}</span>
</span></span></code></pre></div><p>另一个例子， 引导生成符合结构的《Harry Potter》角色属性：</p>
<p>定义角色属性结构</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pydantic</span> <span class="kn">import</span> <span class="n">BaseModel</span><span class="p">,</span> <span class="n">Field</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">base64</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">instructor</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">time</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">enum</span> <span class="kn">import</span> <span class="n">Enum</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Property</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Must be snake case&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">House</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">Griffindor</span> <span class="o">=</span> <span class="s2">&#34;gryffindor&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Hufflepuff</span> <span class="o">=</span> <span class="s2">&#34;hufflepuff&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Ravenclaw</span> <span class="o">=</span> <span class="s2">&#34;ravenclaw&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Slytherin</span> <span class="o">=</span> <span class="s2">&#34;slytherin&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Targaryen</span> <span class="o">=</span> <span class="s2">&#34;targaryen&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># This schema is what guides generation</span>
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Character</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">age</span><span class="p">:</span> <span class="nb">int</span>
</span></span><span class="line"><span class="cl">    <span class="n">house</span><span class="p">:</span> <span class="n">House</span>
</span></span><span class="line"><span class="cl">    <span class="n">properties</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Property</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">api_client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;YOUR_API_KEY&#39;</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="s1">&#39;http://localhost:8000/v1&#39;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">instructor</span><span class="o">.</span><span class="n">from_openai</span><span class="p">(</span><span class="n">api_client</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="n">instructor</span><span class="o">.</span><span class="n">Mode</span><span class="o">.</span><span class="n">MD_JSON</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">model_name</span> <span class="o">=</span> <span class="n">api_client</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">list</span><span class="p">()</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">system_prompt</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;</span><span class="se">\
</span></span></span><span class="line"><span class="cl"><span class="se"></span><span class="s2">You are a highly creative assistant tasked with generating fictional characters for a fantasy novel. 
</span></span></span><span class="line"><span class="cl"><span class="s2">Each character belongs to a specific house, and their properties should reflect their house&#39;s traits. 
</span></span></span><span class="line"><span class="cl"><span class="s2">However, ensure that the characters are entirely original and do not directly reference or resemble any characters, 
</span></span></span><span class="line"><span class="cl"><span class="s2">events, or settings from the Harry Potter series. Avoid using names, events, or any elements that would make the 
</span></span></span><span class="line"><span class="cl"><span class="s2">character too similar to existing Harry Potter content. The goal is to create unique and novel characters that 
</span></span></span><span class="line"><span class="cl"><span class="s2">can stand on their own in a fantasy world.
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">model</span><span class="o">=</span><span class="n">model_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">response_model</span><span class="o">=</span><span class="n">Character</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">system_prompt</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="n">name</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="n">temperature</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># Adjust temperature for creativity</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;An error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="kc">None</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="c1"># Example usage</span>
</span></span><span class="line"><span class="cl"><span class="n">character_name</span> <span class="o">=</span> <span class="s2">&#34;Voldemort&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">character</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">character_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">character</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">character</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Failed to generate character.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># name=&#39;Voldemort&#39; age=50 house=&lt;House.Slytherin: &#39;slytherin&#39;&gt; properties=[Property(key=&#39;power&#39;, value=&#39;dark magic&#39;), Property(key=&#39;reputation&#39;, value=&#39;evil&#39;), Property(key=&#39;history&#39;, value=&#39;murdered his parents and became the Dark Lord&#39;)]</span>
</span></span></code></pre></div><h2 id="prompt-based-methods">Prompt-based Methods<a hidden class="anchor" aria-hidden="true" href="#prompt-based-methods">#</a></h2>
<p>根据奥卡姆剃刀法制，“如无必要，勿增实体”， 或许使用prompt也可以实现， 避免引入不必要的复杂性。</p>
<p>使用Prompt Engineering 要求LLM输出符合格式要求的json（或者其他）时， 可能可以用的一些小Tips：</p>
<ol>
<li>
<p><strong>明确的指令和提示，并提供具体的例子:</strong> 往往LLM的few-shot learning 的能力还行， 模仿个简单的json格式基本不在话下。</p>
</li>
<li>
<p><strong>使用占位符：</strong> 为具体的json元素标注数据类型和格式，便于LLM理解。这一步骤类似于给json定义一个schema。如</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-json" data-lang="json"><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;示例用户&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;id&#34;</span><span class="p">:</span> <span class="mi">12345</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="nt">&#34;items&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="nt">&#34;item_name&#34;</span><span class="p">:</span> <span class="s2">&#34;示例物品1&#34;</span><span class="p">,</span> <span class="nt">&#34;quantity&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="nt">&#34;item_name&#34;</span><span class="p">:</span> <span class="s2">&#34;示例物品2&#34;</span><span class="p">,</span> <span class="nt">&#34;quantity&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>而不是一句“将结果输出成json格式”</p>
</li>
<li>
<p><strong>调整温度：</strong> 采用较低的温度设置</p>
</li>
<li>
<p><strong>分步骤生成：</strong> 对于复杂的JSON结构，可以要求模型逐步生成每个部分，然后将它们组合起来； 或先生成JSON的高层结构，然后再深入生成每个子部分。</p>
</li>
<li>
<p><strong>让LLM自己检查</strong>：类似“三段式翻译” 之类的prompt， LLM首先生成第一版json，而后LLM对LLM进行检查，并提出修改建议， 最后基于建议和初版输出生成最终版结果。</p>
</li>
<li>
<p><strong>格式有效性检查</strong>： 使用如Pydantic等工具进行验证和解析，如果模型生成了不正确的JSON，可以通过循环过程直到输出有效的JSON为止；或使用一些第三方库修复json, 如json_repair。</p>
</li>
</ol>
<p>这里推荐一个开源项目， <a href="https://github.com/microsoft/TypeChat">TypeChat</a>， 一个由微软开发，用于让LLM输出类型定义的结果。TypeChat 自动处理生成提示、验证 LLM 输出是否符合定义的类型，并在必要时修复不符合的输出。</p>
<p>其核心是通过prompt的方式，要求LLM按特定要求输出。</p>
<p>以官方提供的<a href="https://github.com/microsoft/TypeChat/tree/main/python/examples/calendar">Calendar</a>例子为例：</p>
<p>其实现功能即，将自然语言转换成json格式， 用于后续的代办事项的工具使用。</p>
<p>如输入：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">📅&gt; I need to get my tires changed from 12:00 to 2:00 pm on Friday March 15, <span class="m">2024</span>
</span></span></code></pre></div><p>则会输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;actions&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">    <span class="o">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;actionType&#34;</span>: <span class="s2">&#34;add event&#34;</span>,
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;event&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;day&#34;</span>: <span class="s2">&#34;Friday March 15, 2024&#34;</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;timeRange&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;startTime&#34;</span>: <span class="s2">&#34;12:00 pm&#34;</span>,
</span></span><span class="line"><span class="cl">          <span class="s2">&#34;endTime&#34;</span>: <span class="s2">&#34;2:00 pm&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;description&#34;</span>: <span class="s2">&#34;get my tires changed&#34;</span>
</span></span><span class="line"><span class="cl">      <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>
</span></span><span class="line"><span class="cl">  <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span></code></pre></div><p>首先需要事先定义具体且复杂的schema，如 <code>schema.py</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">typing_extensions</span> <span class="kn">import</span> <span class="n">Literal</span><span class="p">,</span> <span class="n">NotRequired</span><span class="p">,</span> <span class="n">TypedDict</span><span class="p">,</span> <span class="n">Annotated</span><span class="p">,</span> <span class="n">Doc</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">UnknownAction</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    if the user types text that can not easily be understood as a calendar action, this action is used
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">actionType</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&#34;Unknown&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">text</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;text typed by the user that the system did not understand&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EventTimeRange</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">startTime</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">endTime</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">duration</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Event</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">day</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;date (example: March 22, 2024) or relative date (example: after EventReference)&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeRange</span><span class="p">:</span> <span class="n">EventTimeRange</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">location</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">participants</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;a list of people or named groups like &#39;team&#39;&#34;</span><span class="p">)]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">EventReference</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    properties used by the requester in referring to an event
</span></span></span><span class="line"><span class="cl"><span class="s2">    these properties are only specified if given directly by the requester
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">day</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;date (example: March 22, 2024) or relative date (example: after EventReference)&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">dayRange</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;(examples: this month, this week, in the next two days)&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeRange</span><span class="p">:</span> <span class="n">EventTimeRange</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">location</span><span class="p">:</span> <span class="nb">str</span>
</span></span><span class="line"><span class="cl">    <span class="n">participants</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">FindEventsAction</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">actionType</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&#34;find events&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventReference</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">EventReference</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;one or more event properties to use to search for matching events&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ChangeDescriptionAction</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">actionType</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&#34;change description&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventReference</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Annotated</span><span class="p">[</span><span class="n">EventReference</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;event to be changed&#34;</span><span class="p">)]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">description</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;new description for the event&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">ChangeTimeRangeAction</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">actionType</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&#34;change time range&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventReference</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Annotated</span><span class="p">[</span><span class="n">EventReference</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;event to be changed&#34;</span><span class="p">)]]</span>
</span></span><span class="line"><span class="cl">    <span class="n">timeRange</span><span class="p">:</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">EventTimeRange</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;new time range for the event&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AddParticipantsAction</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">actionType</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&#34;add participants&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventReference</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">Annotated</span><span class="p">[</span><span class="n">EventReference</span><span class="p">,</span> <span class="n">Doc</span><span class="p">(</span><span class="s2">&#34;event to be augmented; if not specified assume last event discussed&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">participants</span><span class="p">:</span> <span class="n">NotRequired</span><span class="p">[</span><span class="n">Annotated</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="s2">&#34;new participants (one or more)&#34;</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">RemoveEventAction</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">actionType</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&#34;remove event&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">eventReference</span><span class="p">:</span> <span class="n">EventReference</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">AddEventAction</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">actionType</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&#34;add event&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">event</span><span class="p">:</span> <span class="n">Event</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Actions</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">AddEventAction</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">RemoveEventAction</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">AddParticipantsAction</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">ChangeTimeRangeAction</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">ChangeDescriptionAction</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">FindEventsAction</span>
</span></span><span class="line"><span class="cl">    <span class="o">|</span> <span class="n">UnknownAction</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">CalendarActions</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">actions</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Actions</span><span class="p">]</span>
</span></span></code></pre></div><p>这些类表示各种日历操作，每个操作类都有一个actionType字段，确定操作类型：</p>
<p>• FindEventsAction：查找事件，包含一个eventReference字段，用于指定要查找的事件属性。</p>
<p>• ChangeDescriptionAction：更改事件描述，包含eventReference（可选）和新的description字段。</p>
<p>• ChangeTimeRangeAction：更改事件的时间范围，包含eventReference（可选）和新的timeRange字段。</p>
<p>• AddParticipantsAction：为事件添加参与者，包含eventReference（可选）和参与者列表participants（可选）。</p>
<p>• RemoveEventAction：删除事件，包含一个eventReference字段。</p>
<p>• AddEventAction：添加新事件，包含一个event字段。</p>
<p>在TypeChat的核心 prompt如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">You are a service that translates user requests into JSON objects of type &#34;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_type_name</span><span class="si">}</span><span class="s2">&#34; according to the following TypeScript definitions:
</span></span></span><span class="line"><span class="cl"><span class="s2">```
</span></span></span><span class="line"><span class="cl"><span class="s2"></span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_schema_str</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">```
</span></span></span><span class="line"><span class="cl"><span class="s2">The following is a user request:
</span></span></span><span class="line"><span class="cl"><span class="s2">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2"></span><span class="si">{</span><span class="n">intent</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#39;&#39;&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">The following is the user request translated into a JSON object with 2 spaces of indentation and no properties with the value undefined:
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>以上面的例子，最终生成的prompt：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">You are a service that translates user requests into JSON objects of type &#34;CalendarActions&#34; according to the following TypeScript definitions:
</span></span></span><span class="line"><span class="cl"><span class="s2">```
</span></span></span><span class="line"><span class="cl"><span class="s2">interface CalendarActions {
</span></span></span><span class="line"><span class="cl"><span class="s2">    actions: Array&lt;
</span></span></span><span class="line"><span class="cl"><span class="s2">        | AddEventAction
</span></span></span><span class="line"><span class="cl"><span class="s2">        | RemoveEventAction
</span></span></span><span class="line"><span class="cl"><span class="s2">        | AddParticipantsAction
</span></span></span><span class="line"><span class="cl"><span class="s2">        | ChangeTimeRangeAction
</span></span></span><span class="line"><span class="cl"><span class="s2">        | ChangeDescriptionAction
</span></span></span><span class="line"><span class="cl"><span class="s2">        | FindEventsAction
</span></span></span><span class="line"><span class="cl"><span class="s2">        | UnknownAction
</span></span></span><span class="line"><span class="cl"><span class="s2">    &gt;;
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">// if the user types text that can not easily be understood as a calendar action, this action is used
</span></span></span><span class="line"><span class="cl"><span class="s2">interface UnknownAction {
</span></span></span><span class="line"><span class="cl"><span class="s2">    actionType: &#34;Unknown&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // text typed by the user that the system did not understand
</span></span></span><span class="line"><span class="cl"><span class="s2">    text: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">interface FindEventsAction {
</span></span></span><span class="line"><span class="cl"><span class="s2">    actionType: &#34;find events&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // one or more event properties to use to search for matching events
</span></span></span><span class="line"><span class="cl"><span class="s2">    eventReference: EventReference;
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">// properties used by the requester in referring to an event
</span></span></span><span class="line"><span class="cl"><span class="s2">// these properties are only specified if given directly by the requester
</span></span></span><span class="line"><span class="cl"><span class="s2">interface EventReference {
</span></span></span><span class="line"><span class="cl"><span class="s2">    // date (example: March 22, 2024) or relative date (example: after EventReference)
</span></span></span><span class="line"><span class="cl"><span class="s2">    day?: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // (examples: this month, this week, in the next two days)
</span></span></span><span class="line"><span class="cl"><span class="s2">    dayRange?: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    timeRange?: EventTimeRange;
</span></span></span><span class="line"><span class="cl"><span class="s2">    description?: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    location?: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    participants?: string[];
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">interface EventTimeRange {
</span></span></span><span class="line"><span class="cl"><span class="s2">    startTime?: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    endTime?: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    duration?: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">interface ChangeDescriptionAction {
</span></span></span><span class="line"><span class="cl"><span class="s2">    actionType: &#34;change description&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // event to be changed
</span></span></span><span class="line"><span class="cl"><span class="s2">    eventReference?: EventReference;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // new description for the event
</span></span></span><span class="line"><span class="cl"><span class="s2">    description: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">interface ChangeTimeRangeAction {
</span></span></span><span class="line"><span class="cl"><span class="s2">    actionType: &#34;change time range&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // event to be changed
</span></span></span><span class="line"><span class="cl"><span class="s2">    eventReference?: EventReference;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // new time range for the event
</span></span></span><span class="line"><span class="cl"><span class="s2">    timeRange: EventTimeRange;
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">interface AddParticipantsAction {
</span></span></span><span class="line"><span class="cl"><span class="s2">    actionType: &#34;add participants&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // event to be augmented; if not specified assume last event discussed
</span></span></span><span class="line"><span class="cl"><span class="s2">    eventReference?: EventReference;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // new participants (one or more)
</span></span></span><span class="line"><span class="cl"><span class="s2">    participants?: string[];
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">interface RemoveEventAction {
</span></span></span><span class="line"><span class="cl"><span class="s2">    actionType: &#34;remove event&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    eventReference: EventReference;
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">interface AddEventAction {
</span></span></span><span class="line"><span class="cl"><span class="s2">    actionType: &#34;add event&#34;;
</span></span></span><span class="line"><span class="cl"><span class="s2">    event: Event;
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">interface Event {
</span></span></span><span class="line"><span class="cl"><span class="s2">    // date (example: March 22, 2024) or relative date (example: after EventReference)
</span></span></span><span class="line"><span class="cl"><span class="s2">    day: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    timeRange: EventTimeRange;
</span></span></span><span class="line"><span class="cl"><span class="s2">    description: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    location?: string;
</span></span></span><span class="line"><span class="cl"><span class="s2">    // a list of people or named groups like &#39;team&#39;
</span></span></span><span class="line"><span class="cl"><span class="s2">    participants?: string[];
</span></span></span><span class="line"><span class="cl"><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">```
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">The following is a user request:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">I need to get my tires changed from 12:00 to 2:00 pm on Friday March 15, 2024
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">The following is the user request translated into a JSON object with 2 spaces of indentation and no properties with the value undefined:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><hr>
<h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<p><strong><a href="https://www.aidancooper.co.uk/constrained-decoding/">A Guide to Structured Generation Using Constrained Decoding</a></strong></p>
<p><strong><a href="https://huggingface.co/blog/zh/constrained-beam-search">在 🤗 Transformers 中使用约束波束搜索引导文本生成</a></strong></p>
<p><strong><a href="https://platform.openai.com/docs/guides/structured-outputs/structured-outputs">Structured Outputs</a></strong></p>
<p><strong><a href="https://cookbook.openai.com/examples/structured_outputs_intro">Introduction to Structured Outputs</a></strong></p>
<p><strong><a href="https://platform.openai.com/docs/guides/function-calling/function-calling">Function calling</a></strong></p>
<p><strong><a href="https://cookbook.openai.com/examples/structured_outputs_multi_agent">Structured Outputs for Multi-Agent Systems</a></strong></p>
<p><a href="https://github.com/vllm-project/vllm/pull/2819">Add guided decoding for OpenAI API server</a></p>
<p><a href="https://outlines-dev.github.io/outlines/reference/serve/vllm/">outlines: Serve with vLLM</a></p>
<p><a href="https://mp.weixin.qq.com/s/C49FM6HqxHyl9gUZx8VgYA">如何正确约束输出格式，Deepmind最新：让LLM精准生成任何格式的文本，COLM2024</a></p>
<p><a href="https://blog.dottxt.co/coalescence.html?ref=aidancooper.co.uk">Coalescence: making LLM inference 5x faster</a></p>
<p><strong><a href="https://arxiv.org/abs/2307.09702?ref=aidancooper.co.uk">Efficient Guided Generation for Large Language Models</a></strong></p>
<p><strong><a href="https://lmsys.org/blog/2024-02-05-compressed-fsm/?ref=aidancooper.co.uk">Fast JSON Decoding for Local LLMs with Compressed Finite State Machine</a></strong></p>
<p><strong><a href="https://zhuanlan.zhihu.com/p/702473140">通过Typechat控制LLM的输出</a></strong></p>
<p><a href="https://zhuanlan.zhihu.com/p/707144349">大模型 JSON 格式化输出小技巧</a></p>
<p><a href="https://github.com/Dan-wanna-M/formatron">Formatron</a></p>
<p><a href="https://github.com/outlines-dev/outlines">Outlines 〰️</a></p>
<p><a href="https://github.com/sgl-project/sglang">SGLang</a></p>
<p><strong><a href="https://github.com/microsoft/TypeChat">TypeChat</a></strong></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="http://localhost:1313/tags/agent/">Agent</a></li>
      <li><a href="http://localhost:1313/tags/llm/">LLM</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="http://localhost:1313/posts/rag%E5%B7%A5%E5%85%B7%E7%AE%B1query-enhancement/">
    <span class="title">« Prev</span>
    <br>
    <span>RAG工具箱：Query Enhancement</span>
  </a>
  <a class="next" href="http://localhost:1313/posts/rag%E6%A3%80%E7%B4%A2/">
    <span class="title">Next »</span>
    <br>
    <span>RAG工具箱：检索</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share LLM 输出限制：Structured Outputs、受限编码和提示词工程 on x"
            href="https://x.com/intent/tweet/?text=LLM%20%e8%be%93%e5%87%ba%e9%99%90%e5%88%b6%ef%bc%9aStructured%20Outputs%e3%80%81%e5%8f%97%e9%99%90%e7%bc%96%e7%a0%81%e5%92%8c%e6%8f%90%e7%a4%ba%e8%af%8d%e5%b7%a5%e7%a8%8b&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fllm-%25E8%25BE%2593%25E5%2587%25BA%25E9%2599%2590%25E5%2588%25B6structured-outputs%25E5%258F%2597%25E9%2599%2590%25E7%25BC%2596%25E7%25A0%2581%25E5%2592%258C%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%25B7%25A5%25E7%25A8%258B%2f&amp;hashtags=Agent%2cLLM">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share LLM 输出限制：Structured Outputs、受限编码和提示词工程 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fllm-%25E8%25BE%2593%25E5%2587%25BA%25E9%2599%2590%25E5%2588%25B6structured-outputs%25E5%258F%2597%25E9%2599%2590%25E7%25BC%2596%25E7%25A0%2581%25E5%2592%258C%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%25B7%25A5%25E7%25A8%258B%2f&amp;title=LLM%20%e8%be%93%e5%87%ba%e9%99%90%e5%88%b6%ef%bc%9aStructured%20Outputs%e3%80%81%e5%8f%97%e9%99%90%e7%bc%96%e7%a0%81%e5%92%8c%e6%8f%90%e7%a4%ba%e8%af%8d%e5%b7%a5%e7%a8%8b&amp;summary=LLM%20%e8%be%93%e5%87%ba%e9%99%90%e5%88%b6%ef%bc%9aStructured%20Outputs%e3%80%81%e5%8f%97%e9%99%90%e7%bc%96%e7%a0%81%e5%92%8c%e6%8f%90%e7%a4%ba%e8%af%8d%e5%b7%a5%e7%a8%8b&amp;source=http%3a%2f%2flocalhost%3a1313%2fposts%2fllm-%25E8%25BE%2593%25E5%2587%25BA%25E9%2599%2590%25E5%2588%25B6structured-outputs%25E5%258F%2597%25E9%2599%2590%25E7%25BC%2596%25E7%25A0%2581%25E5%2592%258C%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%25B7%25A5%25E7%25A8%258B%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share LLM 输出限制：Structured Outputs、受限编码和提示词工程 on reddit"
            href="https://reddit.com/submit?url=http%3a%2f%2flocalhost%3a1313%2fposts%2fllm-%25E8%25BE%2593%25E5%2587%25BA%25E9%2599%2590%25E5%2588%25B6structured-outputs%25E5%258F%2597%25E9%2599%2590%25E7%25BC%2596%25E7%25A0%2581%25E5%2592%258C%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%25B7%25A5%25E7%25A8%258B%2f&title=LLM%20%e8%be%93%e5%87%ba%e9%99%90%e5%88%b6%ef%bc%9aStructured%20Outputs%e3%80%81%e5%8f%97%e9%99%90%e7%bc%96%e7%a0%81%e5%92%8c%e6%8f%90%e7%a4%ba%e8%af%8d%e5%b7%a5%e7%a8%8b">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share LLM 输出限制：Structured Outputs、受限编码和提示词工程 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=http%3a%2f%2flocalhost%3a1313%2fposts%2fllm-%25E8%25BE%2593%25E5%2587%25BA%25E9%2599%2590%25E5%2588%25B6structured-outputs%25E5%258F%2597%25E9%2599%2590%25E7%25BC%2596%25E7%25A0%2581%25E5%2592%258C%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%25B7%25A5%25E7%25A8%258B%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share LLM 输出限制：Structured Outputs、受限编码和提示词工程 on whatsapp"
            href="https://api.whatsapp.com/send?text=LLM%20%e8%be%93%e5%87%ba%e9%99%90%e5%88%b6%ef%bc%9aStructured%20Outputs%e3%80%81%e5%8f%97%e9%99%90%e7%bc%96%e7%a0%81%e5%92%8c%e6%8f%90%e7%a4%ba%e8%af%8d%e5%b7%a5%e7%a8%8b%20-%20http%3a%2f%2flocalhost%3a1313%2fposts%2fllm-%25E8%25BE%2593%25E5%2587%25BA%25E9%2599%2590%25E5%2588%25B6structured-outputs%25E5%258F%2597%25E9%2599%2590%25E7%25BC%2596%25E7%25A0%2581%25E5%2592%258C%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%25B7%25A5%25E7%25A8%258B%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share LLM 输出限制：Structured Outputs、受限编码和提示词工程 on telegram"
            href="https://telegram.me/share/url?text=LLM%20%e8%be%93%e5%87%ba%e9%99%90%e5%88%b6%ef%bc%9aStructured%20Outputs%e3%80%81%e5%8f%97%e9%99%90%e7%bc%96%e7%a0%81%e5%92%8c%e6%8f%90%e7%a4%ba%e8%af%8d%e5%b7%a5%e7%a8%8b&amp;url=http%3a%2f%2flocalhost%3a1313%2fposts%2fllm-%25E8%25BE%2593%25E5%2587%25BA%25E9%2599%2590%25E5%2588%25B6structured-outputs%25E5%258F%2597%25E9%2599%2590%25E7%25BC%2596%25E7%25A0%2581%25E5%2592%258C%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%25B7%25A5%25E7%25A8%258B%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share LLM 输出限制：Structured Outputs、受限编码和提示词工程 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=LLM%20%e8%be%93%e5%87%ba%e9%99%90%e5%88%b6%ef%bc%9aStructured%20Outputs%e3%80%81%e5%8f%97%e9%99%90%e7%bc%96%e7%a0%81%e5%92%8c%e6%8f%90%e7%a4%ba%e8%af%8d%e5%b7%a5%e7%a8%8b&u=http%3a%2f%2flocalhost%3a1313%2fposts%2fllm-%25E8%25BE%2593%25E5%2587%25BA%25E9%2599%2590%25E5%2588%25B6structured-outputs%25E5%258F%2597%25E9%2599%2590%25E7%25BC%2596%25E7%25A0%2581%25E5%2592%258C%25E6%258F%2590%25E7%25A4%25BA%25E8%25AF%258D%25E5%25B7%25A5%25E7%25A8%258B%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
<div id="utterances">
  <script src="https://utteranc.es/client.js"
        repo="https://github.com/Niraya666/niraya666.github.io.git"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>
</div>


<script type="text/javascript" id="MathJax-script" async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']],
      packages: {'[+]': ['ams']}
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2025 <a href="http://localhost:1313/">LZY Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
