<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Agent学习笔记：OpenAI Function Calling完全指南 | LZY Blog</title>
<meta name="keywords" content="Agent, tool-using">
<meta name="description" content="写在最开始
当我们在讨论基于大型语言模型（LLM-based）的智能代理（agent）时，我们究竟在谈论什么？根据Lilian W在其文章《LLM Powered Autonomous Agents》中的讨论，一个智能代理需要具备几个核心能力：规划（Planning）、记忆（Memory）、以及工具使用（Tool use）。特别地，工具使用方面的进展，得益于OpenAI在API中提供的function calling功能，为我们开启了新的可能性。


OpenAI function calling，作为智能代理与外部工具交互的基本方式，对于每位从业者来说都是必备技能。随着技术的发展，我们期望的不只是能与我们对话的LLM，而是能够辅助我们使用各种工具、做出决策的智能伙伴。
不过需要特别指出的是，最近OpenAI在Chat Completions API中已经废弃了“函数（function）”的使用，转而采用“工具（tool）”。这一变更旨在拓宽LLM集成的功能范围，为更复杂的交互模式铺平道路，如构建能够相互作用的多代理系统。




尽管如此，由于语言习惯的原因，本文中仍然会使用function calling的术语来描述OpenAI的tool using功能，因为“function calling”的说法已经深入人心了。
核心内容概览


Function Calling的定义：解释什么是function calling，以及它在智能代理工作中的作用。


OpenAI Cookbook示例：提供实际的function calling示例，帮助读者理解其在实际应用中的用途。


开源LLM的Tool Using：探索如何在开源大型语言模型中实现工具使用，以及LLM在tool using的时候经历了什么。


评价与训练：讨论如何评价开源模型的工具使用能力，以及如何训练LLM进行有效的工具使用。


鉴于整理笔记的速度远赶不上更新的速度， 会将第四部份作为单独的部分整理。
何为function calling
一句话解释：function calling从本质上并不是严格的工具调用， 而是作为工具调用的前奏，它通过更加结构化的方式指导LLM输出，为在本地执行具体函数提供了参数，铺平了道路。
具体来说，function calling允许LLM在执行过程中通过指定的参数来调用并执行一个特定的函数。这种方式不仅实现了代码的重用和模块化处理，而且能够从模型中获取更可靠的结构化数据回应。在API调用过程中，开发者可以描述想要执行的功能，并让模型智能地选择输出包含所需参数的JSON对象。这个过程中，Chat Completions API本身不直接执行任何函数调用，而是生成了可以在开发者代码中实现函数调用的JSON。
function calling的应用范围广泛，如


创建智能助手：通过调用外部API回答问题。


转换指令：将自然语言指令转换成API调用指令。


数据提取：从文本中提取结构化数据。


function calling的过程涵盖了从定义函数集、通过模型生成遵循自定义模式的JSON对象字符串，到在代码中解析这个字符串并调用相应函数的全过程。这一连串操作不仅自动化了交互过程，还确保了执行操作的安全性和准确性。
一些常见的问题
JSON mode
json mode 和tool-using 有什么关系？有了json mode 还需要用到tool-using吗？
从json mode 的本质， 更多的是在system prompt 增加一句类似“请以json格式输出”之类的话，然后在LLM输出时增加json结果检查和格式转换。在使用时只需要在client.chat.completions.create 中 增加response_format={ &quot;type&quot;: &quot;json_object&quot; } 即可。">
<meta name="author" content="Theme PaperMod">
<link rel="canonical" href="https://niraya666.github.io/posts/agent%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0openai-function-calling%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://niraya666.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://niraya666.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://niraya666.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://niraya666.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://niraya666.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://niraya666.github.io/posts/agent%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0openai-function-calling%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Agent学习笔记：OpenAI Function Calling完全指南" />
<meta property="og:description" content="写在最开始
当我们在讨论基于大型语言模型（LLM-based）的智能代理（agent）时，我们究竟在谈论什么？根据Lilian W在其文章《LLM Powered Autonomous Agents》中的讨论，一个智能代理需要具备几个核心能力：规划（Planning）、记忆（Memory）、以及工具使用（Tool use）。特别地，工具使用方面的进展，得益于OpenAI在API中提供的function calling功能，为我们开启了新的可能性。


OpenAI function calling，作为智能代理与外部工具交互的基本方式，对于每位从业者来说都是必备技能。随着技术的发展，我们期望的不只是能与我们对话的LLM，而是能够辅助我们使用各种工具、做出决策的智能伙伴。
不过需要特别指出的是，最近OpenAI在Chat Completions API中已经废弃了“函数（function）”的使用，转而采用“工具（tool）”。这一变更旨在拓宽LLM集成的功能范围，为更复杂的交互模式铺平道路，如构建能够相互作用的多代理系统。




尽管如此，由于语言习惯的原因，本文中仍然会使用function calling的术语来描述OpenAI的tool using功能，因为“function calling”的说法已经深入人心了。
核心内容概览


Function Calling的定义：解释什么是function calling，以及它在智能代理工作中的作用。


OpenAI Cookbook示例：提供实际的function calling示例，帮助读者理解其在实际应用中的用途。


开源LLM的Tool Using：探索如何在开源大型语言模型中实现工具使用，以及LLM在tool using的时候经历了什么。


评价与训练：讨论如何评价开源模型的工具使用能力，以及如何训练LLM进行有效的工具使用。


鉴于整理笔记的速度远赶不上更新的速度， 会将第四部份作为单独的部分整理。
何为function calling
一句话解释：function calling从本质上并不是严格的工具调用， 而是作为工具调用的前奏，它通过更加结构化的方式指导LLM输出，为在本地执行具体函数提供了参数，铺平了道路。
具体来说，function calling允许LLM在执行过程中通过指定的参数来调用并执行一个特定的函数。这种方式不仅实现了代码的重用和模块化处理，而且能够从模型中获取更可靠的结构化数据回应。在API调用过程中，开发者可以描述想要执行的功能，并让模型智能地选择输出包含所需参数的JSON对象。这个过程中，Chat Completions API本身不直接执行任何函数调用，而是生成了可以在开发者代码中实现函数调用的JSON。
function calling的应用范围广泛，如


创建智能助手：通过调用外部API回答问题。


转换指令：将自然语言指令转换成API调用指令。


数据提取：从文本中提取结构化数据。


function calling的过程涵盖了从定义函数集、通过模型生成遵循自定义模式的JSON对象字符串，到在代码中解析这个字符串并调用相应函数的全过程。这一连串操作不仅自动化了交互过程，还确保了执行操作的安全性和准确性。
一些常见的问题
JSON mode
json mode 和tool-using 有什么关系？有了json mode 还需要用到tool-using吗？
从json mode 的本质， 更多的是在system prompt 增加一句类似“请以json格式输出”之类的话，然后在LLM输出时增加json结果检查和格式转换。在使用时只需要在client.chat.completions.create 中 增加response_format={ &quot;type&quot;: &quot;json_object&quot; } 即可。" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://niraya666.github.io/posts/agent%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0openai-function-calling%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/" />
<meta property="og:image" content="https://niraya666.github.io/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-28T15:00:00+08:00" />
<meta property="article:modified_time" content="2024-04-28T15:00:00+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://niraya666.github.io/images/papermod-cover.png" />
<meta name="twitter:title" content="Agent学习笔记：OpenAI Function Calling完全指南"/>
<meta name="twitter:description" content="写在最开始
当我们在讨论基于大型语言模型（LLM-based）的智能代理（agent）时，我们究竟在谈论什么？根据Lilian W在其文章《LLM Powered Autonomous Agents》中的讨论，一个智能代理需要具备几个核心能力：规划（Planning）、记忆（Memory）、以及工具使用（Tool use）。特别地，工具使用方面的进展，得益于OpenAI在API中提供的function calling功能，为我们开启了新的可能性。


OpenAI function calling，作为智能代理与外部工具交互的基本方式，对于每位从业者来说都是必备技能。随着技术的发展，我们期望的不只是能与我们对话的LLM，而是能够辅助我们使用各种工具、做出决策的智能伙伴。
不过需要特别指出的是，最近OpenAI在Chat Completions API中已经废弃了“函数（function）”的使用，转而采用“工具（tool）”。这一变更旨在拓宽LLM集成的功能范围，为更复杂的交互模式铺平道路，如构建能够相互作用的多代理系统。




尽管如此，由于语言习惯的原因，本文中仍然会使用function calling的术语来描述OpenAI的tool using功能，因为“function calling”的说法已经深入人心了。
核心内容概览


Function Calling的定义：解释什么是function calling，以及它在智能代理工作中的作用。


OpenAI Cookbook示例：提供实际的function calling示例，帮助读者理解其在实际应用中的用途。


开源LLM的Tool Using：探索如何在开源大型语言模型中实现工具使用，以及LLM在tool using的时候经历了什么。


评价与训练：讨论如何评价开源模型的工具使用能力，以及如何训练LLM进行有效的工具使用。


鉴于整理笔记的速度远赶不上更新的速度， 会将第四部份作为单独的部分整理。
何为function calling
一句话解释：function calling从本质上并不是严格的工具调用， 而是作为工具调用的前奏，它通过更加结构化的方式指导LLM输出，为在本地执行具体函数提供了参数，铺平了道路。
具体来说，function calling允许LLM在执行过程中通过指定的参数来调用并执行一个特定的函数。这种方式不仅实现了代码的重用和模块化处理，而且能够从模型中获取更可靠的结构化数据回应。在API调用过程中，开发者可以描述想要执行的功能，并让模型智能地选择输出包含所需参数的JSON对象。这个过程中，Chat Completions API本身不直接执行任何函数调用，而是生成了可以在开发者代码中实现函数调用的JSON。
function calling的应用范围广泛，如


创建智能助手：通过调用外部API回答问题。


转换指令：将自然语言指令转换成API调用指令。


数据提取：从文本中提取结构化数据。


function calling的过程涵盖了从定义函数集、通过模型生成遵循自定义模式的JSON对象字符串，到在代码中解析这个字符串并调用相应函数的全过程。这一连串操作不仅自动化了交互过程，还确保了执行操作的安全性和准确性。
一些常见的问题
JSON mode
json mode 和tool-using 有什么关系？有了json mode 还需要用到tool-using吗？
从json mode 的本质， 更多的是在system prompt 增加一句类似“请以json格式输出”之类的话，然后在LLM输出时增加json结果检查和格式转换。在使用时只需要在client.chat.completions.create 中 增加response_format={ &quot;type&quot;: &quot;json_object&quot; } 即可。"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://niraya666.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Agent学习笔记：OpenAI Function Calling完全指南",
      "item": "https://niraya666.github.io/posts/agent%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0openai-function-calling%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Agent学习笔记：OpenAI Function Calling完全指南",
  "name": "Agent学习笔记：OpenAI Function Calling完全指南",
  "description": "写在最开始 当我们在讨论基于大型语言模型（LLM-based）的智能代理（agent）时，我们究竟在谈论什么？根据Lilian W在其文章《LLM Powered Autonomous Agents》中的讨论，一个智能代理需要具备几个核心能力：规划（Planning）、记忆（Memory）、以及工具使用（Tool use）。特别地，工具使用方面的进展，得益于OpenAI在API中提供的function calling功能，为我们开启了新的可能性。\nOpenAI function calling，作为智能代理与外部工具交互的基本方式，对于每位从业者来说都是必备技能。随着技术的发展，我们期望的不只是能与我们对话的LLM，而是能够辅助我们使用各种工具、做出决策的智能伙伴。\n不过需要特别指出的是，最近OpenAI在Chat Completions API中已经废弃了“函数（function）”的使用，转而采用“工具（tool）”。这一变更旨在拓宽LLM集成的功能范围，为更复杂的交互模式铺平道路，如构建能够相互作用的多代理系统。\n尽管如此，由于语言习惯的原因，本文中仍然会使用function calling的术语来描述OpenAI的tool using功能，因为“function calling”的说法已经深入人心了。\n核心内容概览\nFunction Calling的定义：解释什么是function calling，以及它在智能代理工作中的作用。\nOpenAI Cookbook示例：提供实际的function calling示例，帮助读者理解其在实际应用中的用途。\n开源LLM的Tool Using：探索如何在开源大型语言模型中实现工具使用，以及LLM在tool using的时候经历了什么。\n评价与训练：讨论如何评价开源模型的工具使用能力，以及如何训练LLM进行有效的工具使用。\n鉴于整理笔记的速度远赶不上更新的速度， 会将第四部份作为单独的部分整理。\n何为function calling 一句话解释：function calling从本质上并不是严格的工具调用， 而是作为工具调用的前奏，它通过更加结构化的方式指导LLM输出，为在本地执行具体函数提供了参数，铺平了道路。\n具体来说，function calling允许LLM在执行过程中通过指定的参数来调用并执行一个特定的函数。这种方式不仅实现了代码的重用和模块化处理，而且能够从模型中获取更可靠的结构化数据回应。在API调用过程中，开发者可以描述想要执行的功能，并让模型智能地选择输出包含所需参数的JSON对象。这个过程中，Chat Completions API本身不直接执行任何函数调用，而是生成了可以在开发者代码中实现函数调用的JSON。\nfunction calling的应用范围广泛，如\n创建智能助手：通过调用外部API回答问题。\n转换指令：将自然语言指令转换成API调用指令。\n数据提取：从文本中提取结构化数据。\nfunction calling的过程涵盖了从定义函数集、通过模型生成遵循自定义模式的JSON对象字符串，到在代码中解析这个字符串并调用相应函数的全过程。这一连串操作不仅自动化了交互过程，还确保了执行操作的安全性和准确性。\n一些常见的问题 JSON mode json mode 和tool-using 有什么关系？有了json mode 还需要用到tool-using吗？\n从json mode 的本质， 更多的是在system prompt 增加一句类似“请以json格式输出”之类的话，然后在LLM输出时增加json结果检查和格式转换。在使用时只需要在client.chat.completions.create 中 增加response_format={ \u0026quot;type\u0026quot;: \u0026quot;json_object\u0026quot; } 即可。\n",
  "keywords": [
    "Agent", "tool-using"
  ],
  "articleBody": "写在最开始 当我们在讨论基于大型语言模型（LLM-based）的智能代理（agent）时，我们究竟在谈论什么？根据Lilian W在其文章《LLM Powered Autonomous Agents》中的讨论，一个智能代理需要具备几个核心能力：规划（Planning）、记忆（Memory）、以及工具使用（Tool use）。特别地，工具使用方面的进展，得益于OpenAI在API中提供的function calling功能，为我们开启了新的可能性。\nOpenAI function calling，作为智能代理与外部工具交互的基本方式，对于每位从业者来说都是必备技能。随着技术的发展，我们期望的不只是能与我们对话的LLM，而是能够辅助我们使用各种工具、做出决策的智能伙伴。\n不过需要特别指出的是，最近OpenAI在Chat Completions API中已经废弃了“函数（function）”的使用，转而采用“工具（tool）”。这一变更旨在拓宽LLM集成的功能范围，为更复杂的交互模式铺平道路，如构建能够相互作用的多代理系统。\n尽管如此，由于语言习惯的原因，本文中仍然会使用function calling的术语来描述OpenAI的tool using功能，因为“function calling”的说法已经深入人心了。\n核心内容概览\nFunction Calling的定义：解释什么是function calling，以及它在智能代理工作中的作用。\nOpenAI Cookbook示例：提供实际的function calling示例，帮助读者理解其在实际应用中的用途。\n开源LLM的Tool Using：探索如何在开源大型语言模型中实现工具使用，以及LLM在tool using的时候经历了什么。\n评价与训练：讨论如何评价开源模型的工具使用能力，以及如何训练LLM进行有效的工具使用。\n鉴于整理笔记的速度远赶不上更新的速度， 会将第四部份作为单独的部分整理。\n何为function calling 一句话解释：function calling从本质上并不是严格的工具调用， 而是作为工具调用的前奏，它通过更加结构化的方式指导LLM输出，为在本地执行具体函数提供了参数，铺平了道路。\n具体来说，function calling允许LLM在执行过程中通过指定的参数来调用并执行一个特定的函数。这种方式不仅实现了代码的重用和模块化处理，而且能够从模型中获取更可靠的结构化数据回应。在API调用过程中，开发者可以描述想要执行的功能，并让模型智能地选择输出包含所需参数的JSON对象。这个过程中，Chat Completions API本身不直接执行任何函数调用，而是生成了可以在开发者代码中实现函数调用的JSON。\nfunction calling的应用范围广泛，如\n创建智能助手：通过调用外部API回答问题。\n转换指令：将自然语言指令转换成API调用指令。\n数据提取：从文本中提取结构化数据。\nfunction calling的过程涵盖了从定义函数集、通过模型生成遵循自定义模式的JSON对象字符串，到在代码中解析这个字符串并调用相应函数的全过程。这一连串操作不仅自动化了交互过程，还确保了执行操作的安全性和准确性。\n一些常见的问题 JSON mode json mode 和tool-using 有什么关系？有了json mode 还需要用到tool-using吗？\n从json mode 的本质， 更多的是在system prompt 增加一句类似“请以json格式输出”之类的话，然后在LLM输出时增加json结果检查和格式转换。在使用时只需要在client.chat.completions.create 中 增加response_format={ \"type\": \"json_object\" } 即可。\n那么json mode 什么时候会用到呢？一般在做文本提取，内容提取时可以使用；以RAG场景为例， 当我们希望LLM能够帮我们对用户的query进行改写时，我们肯定是希望模型能够返回干净的json格式改写结果，这样的结果可以直接使用，而不是在模型输出一些内容后，如：\n\"\"\" 好的，以下是我的改写内容： ``` real-rewrite-query ``` \"\"\" 其中包含了一些模型喜欢输出的客套话，此时我们需要通过正则匹配等方法将真正希望使用内容提取出来。而这时候json mode可以直接输出需要的内容， 而跳过了额外的提取步骤。在json mode 出现之前，这样的处理我们也尝试使用过tool-using 的模式，但有点大材小用了。\n很显然， tool-using的真正强大之处并不只是对输出格式进行处理， 而是能够让模型从提供的多个tools中选择需要使用的。\n如何使用OpenAI function calling 天气查询的简单示例 环境配置\n首先，我们需要安装一些必要的Python库。这些库将帮助我们与OpenAI的API进行交互，以及完成一些辅助功能。\n!pip install scipy --quiet !pip install tenacity --quiet !pip install tiktoken --quiet !pip install termcolor --quiet !pip install openai --quiet os.environ[\"OPENAI_API_KEY\"] = \"...\" from openai import OpenAI from tenacity import retry, wait_random_exponential, stop_after_attempt from termcolor import colored client = OpenAI() 工具函数定义\n接下来，我们定义一些实用函数，这些函数旨在方便我们向Chat Completions API发送请求，并管理与跟踪对话状态。\n@retry(wait=wait_random_exponential(multiplier=1, max=40), stop=stop_after_attempt(3)) def chat_completion_request(messages, tools=None, tool_choice=None, model=\"gpt-3.5-turbo\"): try: response = client.chat.completions.create( model=model, messages=messages, tools=tools, tool_choice=tool_choice, ) return response except Exception as e: print(\"Unable to generate ChatCompletion response\") print(f\"Exception: {e}\") return e def pretty_print_conversation(messages): role_to_color = { \"system\": \"red\", \"user\": \"green\", \"assistant\": \"blue\", \"function\": \"magenta\", } for message in messages: if message[\"role\"] == \"system\": print(colored(f\"system: {message['content']}\\n\", role_to_color[message[\"role\"]])) elif message[\"role\"] == \"user\": print(colored(f\"user: {message['content']}\\n\", role_to_color[message[\"role\"]])) elif message[\"role\"] == \"assistant\" and message.get(\"function_call\"): print(colored(f\"assistant: {message['function_call']}\\n\", role_to_color[message[\"role\"]])) elif message[\"role\"] == \"assistant\" and not message.get(\"function_call\"): print(colored(f\"assistant: {message['content']}\\n\", role_to_color[message[\"role\"]])) elif message[\"role\"] == \"function\": print(colored(f\"function ({message['name']}): {message['content']}\\n\", role_to_color[message[\"role\"]])) 函数规范定义\n我们还需要创建一些函数规范，以接口化与假设的天气API的交互。\ntools = [ { \"type\": \"function\", \"function\": { \"name\": \"get_current_weather\", \"description\": \"Get the current weather\", \"parameters\": { \"type\": \"object\", \"properties\": { \"location\": { \"type\": \"string\", \"description\": \"The city and state, e.g. San Francisco, CA\", }, \"format\": { \"type\": \"string\", \"enum\": [\"celsius\", \"fahrenheit\"], \"description\": \"The temperature unit to use. Infer this from the users location.\", }, }, \"required\": [\"location\", \"format\"], }, } }, { \"type\": \"function\", \"function\": { \"name\": \"get_n_day_weather_forecast\", \"description\": \"Get an N-day weather forecast\", \"parameters\": { \"type\": \"object\", \"properties\": { \"location\": { \"type\": \"string\", \"description\": \"The city and state, e.g. San Francisco, CA\", }, \"format\": { \"type\": \"string\", \"enum\": [\"celsius\", \"fahrenheit\"], \"description\": \"The temperature unit to use. Infer this from the users location.\", }, \"num_days\": { \"type\": \"integer\", \"description\": \"The number of days to forecast\", } }, \"required\": [\"location\", \"format\", \"num_days\"] }, } }, ] 对话示例\n当我们请求当前天气时， LLM会要求澄清问题，如地址等参数信息：\nmessages = [] messages.append({\"role\": \"system\", \"content\": \"Don't make assumptions about what values to plug into functions. Ask for clarification if a user request is ambiguous.\"}) messages.append({\"role\": \"user\", \"content\": \"What's the weather like today\"}) chat_response = chat_completion_request( messages, tools=tools ) assistant_message = chat_response.choices[0].message messages.append(assistant_message) assistant_message output:\nChatCompletionMessage(content='Sure, may I know your current location?', role='assistant', function_call=None, tool_calls=None) 当补充缺失的信息后， LLM将生成适当的函数参数\nmessages.append({\"role\": \"user\", \"content\": \"I'm in Shanghai, China.\"}) chat_response = chat_completion_request( messages, tools=tools ) assistant_message = chat_response.choices[0].message messages.append(assistant_message) assistant_message output:\nChatCompletionMessage(content=None, role='assistant', function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_VdqOOMp9pagf5ho39Y2HmYV4', function=Function(arguments='{\\n \"location\": \"San Francisco, CA\",\\n \"format\": \"celsius\",\\n \"num_days\": 4\\n}', name='get_n_day_weather_forecast'), type='function')]) 完整流程如下：\nmessages = [] messages.append({\"role\": \"system\", \"content\": \"Don't make assumptions about what values to plug into functions. Ask for clarification if a user request is ambiguous.\"}) messages.append({\"role\": \"user\", \"content\": \"what is the weather going to be like in Glasgow, Scotland over the next x days\"}) messages.append({\"role\": \"user\", \"content\": \"in 5 days\"}) chat_response = chat_completion_request( messages, tools=tools ) assistant_message = chat_response.choices[0].message messages.append(assistant_message) assistant_message 当然， 我们也可以强制要求使用特定的函数\nmessages = [] messages.append({\"role\": \"system\", \"content\": \"Don't make assumptions about what values to plug into functions. Ask for clarification if a user request is ambiguous.\"}) messages.append({\"role\": \"user\", \"content\": \"Give me a weather report for Toronto, Canada.\"}) chat_response = chat_completion_request( messages, tools=tools, tool_choice={\"type\": \"function\", \"function\": {\"name\": \"get_n_day_weather_forecast\"}} ) chat_response.choices[0].message output:\nChatCompletionMessage(content=None, role='assistant', function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_0ldecDpV8Vdq8mGPoUewlue3', function=Function(arguments='{\\n \"location\": \"Toronto, Canada\",\\n \"format\": \"celsius\",\\n \"num_days\": 1\\n}', name='get_n_day_weather_forecast'), type='function')]) 并行函数调用\n对于一些特定模型，如**gpt-4-turbo-preview**, gpt-4-0125-preview, gpt-4-1106-preview, gpt-3.5-turbo-0125, and **gpt-3.5-turbo-1106**支持并行函数调用， 允许我们在单个回合中调用多个函数。\nmessages = [] messages.append({\"role\": \"system\", \"content\": \"Don't make assumptions about what values to plug into functions. Ask for clarification if a user request is ambiguous.\"}) messages.append({\"role\": \"user\", \"content\": \"what is the weather going to be like in San Francisco and Glasgow over the next 4 days\"}) chat_response = chat_completion_request( messages, tools=tools ) assistant_message = chat_response.choices[0].message.tool_calls assistant_message output:\n[ChatCompletionMessageToolCall(id='call_tfl8eTCW64sHvHjiiatoYzku', function=Function(arguments='{\"location\": \"San Francisco, CA\", \"format\": \"fahrenheit\", \"num_days\": 4}', name='get_n_day_weather_forecast'), type='function'), ChatCompletionMessageToolCall(id='call_bAqj55RygP2Y1T85RHqgskku', function=Function(arguments='{\"location\": \"Glasgow, UK\", \"format\": \"celsius\", \"num_days\": 4}', name='get_n_day_weather_forecast'), type='function')] 实现本地函数调用\n首先我们需要构造两个用于演示的假function\nimport json def get_current_weather(location, format=\"fahrenheit\"): \"\"\" Simulates getting the current weather for a given location. The response is hardcoded for demonstration purposes. Args: location (str): The city and state, e.g., San Francisco, CA. format (str, optional): The temperature unit to use. Defaults to \"fahrenheit\". Returns: str: JSON string with the current weather data. \"\"\" if \"tokyo\" in location.lower(): return json.dumps({\"location\": \"Tokyo\", \"temperature\": \"10\", \"format\": format, \"description\": \"Partly Cloudy\"}) elif \"san francisco\" in location.lower(): return json.dumps({\"location\": \"San Francisco\", \"temperature\": \"72\", \"format\": format, \"description\": \"Sunny\"}) elif \"paris\" in location.lower(): return json.dumps({\"location\": \"Paris\", \"temperature\": \"22\", \"format\": format, \"description\": \"Rainy\"}) else: return json.dumps({\"location\": location, \"temperature\": \"unknown\", \"format\": format, \"description\": \"Data Unavailable\"}) def get_n_day_weather_forecast(location, num_days, format=\"fahrenheit\"): \"\"\" Simulates getting an N-day weather forecast for a given location. The response is hardcoded for demonstration purposes. Args: location (str): The city and state, e.g., San Francisco, CA. num_days (int): The number of days to forecast. format (str, optional): The temperature unit to use. Defaults to \"fahrenheit\". Returns: str: JSON string with the N-day weather forecast data. \"\"\" # This example just returns a fixed response regardless of the input. # In a real scenario, the response would depend on the location, num_days, and format. forecast = [ {\"day\": 1, \"temperature\": \"22\", \"format\": format, \"description\": \"Sunny\"}, {\"day\": 2, \"temperature\": \"18\", \"format\": format, \"description\": \"Cloudy\"}, {\"day\": 3, \"temperature\": \"15\", \"format\": format, \"description\": \"Rainy\"} ] # Return only the forecast for the requested number of days. return json.dumps(forecast[:num_days]) available_functions = { \"get_current_weather\": get_current_weather, \"get_n_day_weather_forecast\": get_n_day_weather_forecast, } 尝试请求天气\nmessages = [] messages.append({\"role\": \"user\", \"content\": \"What's the weather like in Tokyo!\"}) chat_response = chat_completion_request(messages, tools=tools, tool_choice=\"auto\") assistant_message = chat_response.choices[0].message assistant_message = json.loads(assistant_message.model_dump_json()) assistant_message[\"content\"] = str(assistant_message[\"tool_calls\"][0][\"function\"]) #a temporary patch but this should be handled differently # remove \"function_call\" from assistant message del assistant_message[\"function_call\"] assistant_message \"\"\" {'content': '{\\'arguments\\': \\'{\\\\n \"location\": \"Tokyo\",\\\\n \"format\": \"celsius\"\\\\n}\\', \\'name\\': \\'get_current_weather\\'}', 'role': 'assistant', 'tool_calls': [{'id': 'call_Tz8S1HgvnaBzf6CFZP1u4d1J', 'function': {'arguments': '{\\n \"location\": \"Tokyo\",\\n \"format\": \"celsius\"\\n}', 'name': 'get_current_weather'}, 'type': 'function'}]} \"\"\" messages.append(assistant_message) 可以看到，LLM返回了json格式的参数信息（其实是str）以及需要调用的function名称， 拥有这些信息之后就可以调用之前定义的函数了\n# get the weather information to pass back to the model function_name_to_call = assistant_message['tool_calls'][0]['function']['name'] function_arguments = assistant_message['tool_calls'][0]['function']['arguments'] weather = available_functions[function_name_to_call](function_arguments) 将函数执行结果和对话历史返回给LLM\nmessages.append({\"role\": \"tool\", \"tool_call_id\": assistant_message[\"tool_calls\"][0][\"id\"], \"name\": assistant_message[\"tool_calls\"][0][\"function\"][\"name\"], \"content\": weather}) messages \"\"\" [{'role': 'user', 'content': \"What's the weather like in Tokyo!\"}, {'content': '{\\'arguments\\': \\'{\\\\n \"location\": \"Tokyo\",\\\\n \"format\": \"celsius\"\\\\n}\\', \\'name\\': \\'get_current_weather\\'}', 'role': 'assistant', 'tool_calls': [{'id': 'call_Tz8S1HgvnaBzf6CFZP1u4d1J', 'function': {'arguments': '{\\n \"location\": \"Tokyo\",\\n \"format\": \"celsius\"\\n}', 'name': 'get_current_weather'}, 'type': 'function'}]}, {'role': 'tool', 'tool_call_id': 'call_Tz8S1HgvnaBzf6CFZP1u4d1J', 'name': 'get_current_weather', 'content': '{\"location\": \"Tokyo\", \"temperature\": \"10\", \"format\": \"fahrenheit\"}'}] \"\"\" 最终输出结果（for user）\nfinal_response = chat_completion_request(messages, tools=tools) final_response.choices[0].message.content output：\n'The current weather in Tokyo is partly cloudy with a temperature of 10°C (50°F).' 通过function calling 实现sql执行 下载演示所用的sqlite数据\n!wget https://www.sqlitetutorial.net/wp-content/uploads/2018/03/chinook.zip -O chinook.zip !unzip chinook.zip 连接数据库，和定义一些function\nimport sqlite3 conn = sqlite3.connect(\"/content/chinook.db\") print(\"Opened database successfully\") def get_table_names(conn): \"\"\"Return a list of table names.\"\"\" table_names = [] tables = conn.execute(\"SELECT name FROM sqlite_master WHERE type='table';\") for table in tables.fetchall(): table_names.append(table[0]) return table_names def get_column_names(conn, table_name): \"\"\"Return a list of column names.\"\"\" column_names = [] columns = conn.execute(f\"PRAGMA table_info('{table_name}');\").fetchall() for col in columns: column_names.append(col[1]) return column_names def get_database_info(conn): \"\"\"Return a list of dicts containing the table name and columns for each table in the database.\"\"\" table_dicts = [] for table_name in get_table_names(conn): columns_names = get_column_names(conn, table_name) table_dicts.append({\"table_name\": table_name, \"column_names\": columns_names}) return table_dicts 获取db 的schema\ndatabase_schema_dict = get_database_info(conn) database_schema_string = \"\\n\".join( [ f\"Table: {table['table_name']}\\nColumns: {', '.join(table['column_names'])}\" for table in database_schema_dict ] ) 定义tools工具列表\ntools = [ { \"type\": \"function\", \"function\": { \"name\": \"ask_database\", \"description\": \"Use this function to answer user questions about music. Input should be a fully formed SQL query.\", \"parameters\": { \"type\": \"object\", \"properties\": { \"query\": { \"type\": \"string\", \"description\": f\"\"\" SQL query extracting info to answer the user's question. SQL should be written using this database schema: {database_schema_string} The query should be returned in plain text, not in JSON. \"\"\", } }, \"required\": [\"query\"], }, } } ] 定义用于执行sql的function\ndef ask_database(conn, query): \"\"\"Function to query SQLite database with a provided SQL query.\"\"\" try: results = str(conn.execute(query).fetchall()) except Exception as e: results = f\"query failed with error: {e}\" return results def execute_function_call(message): if message.tool_calls[0].function.name == \"ask_database\": query = json.loads(message.tool_calls[0].function.arguments)[\"query\"] results = ask_database(conn, query) else: results = f\"Error: function {message.tool_calls[0].function.name} does not exist\" return results messages = [] messages.append({\"role\": \"system\", \"content\": \"Answer user questions by generating SQL queries against the Chinook Music Database.\"}) messages.append({\"role\": \"user\", \"content\": \"Hi, who are the top 5 artists by number of tracks?\"}) chat_response = chat_completion_request(messages, tools) assistant_message = chat_response.choices[0].message messages.append(assistant_message) if assistant_message.tool_calls: results = execute_function_call(assistant_message) messages.append({\"role\": \"tool\", \"tool_call_id\": assistant_message.tool_calls[0].id, \"name\": assistant_message.tool_calls[0].function.name, \"content\": results}) 此时的messages\n[{'role': 'system', 'content': 'Answer user questions by generating SQL queries against the Chinook Music Database.'}, {'role': 'user', 'content': 'Hi, who are the top 5 artists by number of tracks?'}, ChatCompletionMessage(content='Function(arguments=\\'{\\\\n \"query\": \"SELECT artists.Name, COUNT(tracks.TrackId) AS num_tracks FROM artists JOIN albums ON artists.ArtistId = albums.ArtistId JOIN tracks ON albums.AlbumId = tracks.AlbumId GROUP BY artists.ArtistId ORDER BY num_tracks DESC LIMIT 5\"\\\\n}\\', name=\\'ask_database\\')', role='assistant', function_call=None, tool_calls=[ChatCompletionMessageToolCall(id='call_vSLysEQncbGvMgXGhttIow6v', function=Function(arguments='{\\n \"query\": \"SELECT artists.Name, COUNT(tracks.TrackId) AS num_tracks FROM artists JOIN albums ON artists.ArtistId = albums.ArtistId JOIN tracks ON albums.AlbumId = tracks.AlbumId GROUP BY artists.ArtistId ORDER BY num_tracks DESC LIMIT 5\"\\n}', name='ask_database'), type='function')]), {'role': 'tool', 'tool_call_id': 'call_vSLysEQncbGvMgXGhttIow6v', 'name': 'ask_database', 'content': \"[('Iron Maiden', 213), ('U2', 135), ('Led Zeppelin', 114), ('Metallica', 112), ('Deep Purple', 92)]\"}] 最终输出：\nfinal_response = chat_completion_request(messages, tools=tools) final_response.choices[0].message.content # output \"\"\" The top 5 artists by number of tracks are: 1. Iron Maiden - 213 tracks 2. U2 - 135 tracks 3. Led Zeppelin - 114 tracks 4. Metallica - 112 tracks 5. Deep Purple - 92 tracks \"\"\" 基于function calling构建智能代理：自动获取与深度解析arXiv学术文章 在这一节中将介绍如何构建一个能够从arXiv上查找论文， 下载分析并总结学术论文的Agent。这个Agent不仅可以帮助用户快速了解特定领域的最新研究动态，而且还能深入分析和总结选定文章的核心内容。\nAgent核心功能\n获取arXiv文章 get_articles 代理通过**arxiv**库搜索关于特定主题的文章，为用户提供简要的文章摘要和链接。\n阅读并总结文章 read_article_and_summarize 利用**PyPDF2**库读取选中文章的PDF文件，代理能够提炼出文章的主要论点、支撑证据和结论。\n环境配置\n!pip install scipy --quiet !pip install tenacity --quiet !pip install tiktoken==0.3.3 --quiet !pip install termcolor --quiet !pip install openai --quiet !pip install arxiv --quiet !pip install pandas --quiet !pip install PyPDF2 --quiet !pip install tqdm --quiet import os import arxiv import ast import concurrent import json import os import pandas as pd import tiktoken from csv import writer from IPython.display import display, Markdown, Latex from openai import OpenAI from PyPDF2 import PdfReader from scipy import spatial from tenacity import retry, wait_random_exponential, stop_after_attempt from tqdm import tqdm from termcolor import colored GPT_MODEL = \"gpt-3.5-turbo-0613\" EMBEDDING_MODEL = \"text-embedding-ada-002\" client = OpenAI() 所有下载的论文都被存储在本地**./data/papers目录中，并且每篇文章的详细信息（包括其嵌入向量）都记录在arxiv_library.csv**文件中。\ndirectory = './data/papers' # Check if the directory already exists if not os.path.exists(directory): # If the directory doesn't exist, create it and any necessary intermediate directories os.makedirs(directory) print(f\"Directory '{directory}' created successfully.\") else: # If the directory already exists, print a message indicating it print(f\"Directory '{directory}' already exists.\") # Set a directory to store downloaded papers data_dir = os.path.join(os.curdir, \"data\", \"papers\") paper_dir_filepath = \"./data/arxiv_library.csv\" # Generate a blank dataframe where we can store downloaded files df = pd.DataFrame(list()) df.to_csv(paper_dir_filepath) 我们将定义一些utils function用于：\n文章获取与存储：通过**get_articles**函数查询主题相关的文章，系统自动下载文章并记录重要信息及embedding向量。\n文章选择与内容提取：根据用户的查询，系统通过计算embedding向量的相似度来选择最相关的文章，并提取出文章的文本内容。\n内容分块与总结：长文本被分割成多个较小的块，每个块被独立总结。\n汇总总结：所有独立块的总结被汇总成一篇全面的总结，更好地回应用户的查询。\n@retry(wait=wait_random_exponential(min=1, max=40), stop=stop_after_attempt(3)) def embedding_request(text): response = client.embeddings.create(input=text, model=EMBEDDING_MODEL) return response @retry(wait=wait_random_exponential(min=1, max=40), stop=stop_after_attempt(3)) def get_articles(query, library=paper_dir_filepath, top_k=5): \"\"\"This function gets the top_k articles based on a user's query, sorted by relevance. It also downloads the files and stores them in arxiv_library.csv to be retrieved by the read_article_and_summarize. \"\"\" client = arxiv.Client() search = arxiv.Search( query = query, max_results = top_k, sort_by = arxiv.SortCriterion.SubmittedDate ) result_list = [] for result in client.results(search): result_dict = {} result_dict.update({\"title\": result.title}) result_dict.update({\"summary\": result.summary}) # Taking the first url provided result_dict.update({\"article_url\": [x.href for x in result.links][0]}) result_dict.update({\"pdf_url\": [x.href for x in result.links][1]}) result_list.append(result_dict) # Store references in library file response = embedding_request(text=result.title) file_reference = [ result.title, result.download_pdf(data_dir), response.data[0].embedding, ] # Write to file with open(library, \"a\") as f_object: writer_object = writer(f_object) writer_object.writerow(file_reference) f_object.close() return result_list def strings_ranked_by_relatedness( query: str, df: pd.DataFrame, relatedness_fn=lambda x, y: 1 - spatial.distance.cosine(x, y), top_n: int = 100, ) -\u003e list[str]: \"\"\"Returns a list of strings and relatednesses, sorted from most related to least.\"\"\" query_embedding_response = embedding_request(query) query_embedding = query_embedding_response.data[0].embedding strings_and_relatednesses = [ (row[\"filepath\"], relatedness_fn(query_embedding, row[\"embedding\"])) for i, row in df.iterrows() ] strings_and_relatednesses.sort(key=lambda x: x[1], reverse=True) strings, relatednesses = zip(*strings_and_relatednesses) return strings[:top_n] def read_pdf(filepath): \"\"\"Takes a filepath to a PDF and returns a string of the PDF's contents\"\"\" # creating a pdf reader object reader = PdfReader(filepath) pdf_text = \"\" page_number = 0 for page in reader.pages: page_number += 1 pdf_text += page.extract_text() + f\"\\nPage Number: {page_number}\" return pdf_text # Split a text into smaller chunks of size n, preferably ending at the end of a sentence def create_chunks(text, n, tokenizer): \"\"\"Returns successive n-sized chunks from provided text.\"\"\" tokens = tokenizer.encode(text) i = 0 while i \u003c len(tokens): # Find the nearest end of sentence within a range of 0.5 * n and 1.5 * n tokens j = min(i + int(1.5 * n), len(tokens)) while j \u003e i + int(0.5 * n): # Decode the tokens and check for full stop or newline chunk = tokenizer.decode(tokens[i:j]) if chunk.endswith(\".\") or chunk.endswith(\"\\n\"): break j -= 1 # If no end of sentence found, use n tokens as the chunk size if j == i + int(0.5 * n): j = min(i + n, len(tokens)) yield tokens[i:j] i = j def extract_chunk(content, template_prompt): \"\"\"This function applies a prompt to some input content. In this case it returns a summarized chunk of text\"\"\" prompt = template_prompt + content response = client.chat.completions.create( model=GPT_MODEL, messages=[{\"role\": \"user\", \"content\": prompt}], temperature=0 ) return response.choices[0].message.content def summarize_text(query): \"\"\"This function does the following: - Reads in the arxiv_library.csv file in including the embeddings - Finds the closest file to the user's query - Scrapes the text out of the file and chunks it - Summarizes each chunk in parallel - Does one final summary and returns this to the user\"\"\" # A prompt to dictate how the recursive summarizations should approach the input paper summary_prompt = \"\"\"Summarize this text from an academic paper. Extract any key points with reasoning.\\n\\nContent:\"\"\" # If the library is empty (no searches have been performed yet), we perform one and download the results library_df = pd.read_csv(paper_dir_filepath).reset_index() if len(library_df) == 0: print(\"No papers searched yet, downloading first.\") get_articles(query) print(\"Papers downloaded, continuing\") library_df = pd.read_csv(paper_dir_filepath).reset_index() library_df.columns = [\"title\", \"filepath\", \"embedding\"] library_df[\"embedding\"] = library_df[\"embedding\"].apply(ast.literal_eval) strings = strings_ranked_by_relatedness(query, library_df, top_n=1) print(\"Chunking text from paper\") pdf_text = read_pdf(strings[0]) # Initialise tokenizer tokenizer = tiktoken.get_encoding(\"cl100k_base\") results = \"\" # Chunk up the document into 1500 token chunks chunks = create_chunks(pdf_text, 1500, tokenizer) text_chunks = [tokenizer.decode(chunk) for chunk in chunks] print(\"Summarizing each chunk of text\") # Parallel process the summaries with concurrent.futures.ThreadPoolExecutor( max_workers=len(text_chunks) ) as executor: futures = [ executor.submit(extract_chunk, chunk, summary_prompt) for chunk in text_chunks ] with tqdm(total=len(text_chunks)) as pbar: for _ in concurrent.futures.as_completed(futures): pbar.update(1) for future in futures: data = future.result() results += data # Final summary print(\"Summarizing into overall summary\") response = client.chat.completions.create( model=GPT_MODEL, messages=[ { \"role\": \"user\", \"content\": f\"\"\"Write a summary collated from this collection of key points extracted from an academic paper. The summary should highlight the core argument, conclusions and evidence, and answer the user's query. User query: {query} The summary should be structured in bulleted lists following the headings Core Argument, Evidence, and Conclusions. Key points:\\n{results}\\nSummary:\\n\"\"\", } ], temperature=0, ) return response 实现一个**Conversation**类，用于支持与API进行多轮对话\n@retry(wait=wait_random_exponential(min=1, max=40), stop=stop_after_attempt(3)) def chat_completion_request(messages, functions=None, model=GPT_MODEL): try: response = client.chat.completions.create( model=model, messages=messages, functions=functions, ) return response except Exception as e: print(\"Unable to generate ChatCompletion response\") print(f\"Exception: {e}\") return e class Conversation: def __init__(self): self.conversation_history = [] def add_message(self, role, content): message = {\"role\": role, \"content\": content} self.conversation_history.append(message) def display_conversation(self, detailed=False): role_to_color = { \"system\": \"red\", \"user\": \"green\", \"assistant\": \"blue\", \"function\": \"magenta\", } for message in self.conversation_history: print( colored( f\"{message['role']}: {message['content']}\\n\\n\", role_to_color[message[\"role\"]], ) ) 完成以上基本工作， 接下来是agent的核心内容\n定义工具列表 tools\narxiv_functions = [ { \"name\": \"get_articles\", \"description\": \"\"\"Use this function to get academic papers from arXiv to answer user questions.\"\"\", \"parameters\": { \"type\": \"object\", \"properties\": { \"query\": { \"type\": \"string\", \"description\": f\"\"\" User query in JSON. Responses should be summarized and should include the article URL reference \"\"\", } }, \"required\": [\"query\"], }, }, { \"name\": \"read_article_and_summarize\", \"description\": \"\"\"Use this function to read whole papers and provide a summary for users. You should NEVER call this function before get_articles has been called in the conversation.\"\"\", \"parameters\": { \"type\": \"object\", \"properties\": { \"query\": { \"type\": \"string\", \"description\": f\"\"\" Description of the article in plain text based on the user's query \"\"\", } }, \"required\": [\"query\"], }, } ] 定义function用于工具调用\ndef chat_completion_with_function_execution(messages, functions=[None]): \"\"\"This function makes a ChatCompletion API call with the option of adding functions\"\"\" response = chat_completion_request(messages, functions) full_message = response.choices[0] if full_message.finish_reason == \"function_call\": print(f\"Function generation requested, calling function\") return call_arxiv_function(messages, full_message) else: print(f\"Function not required, responding to user\") return response def call_arxiv_function(messages, full_message): \"\"\"Function calling function which executes function calls when the model believes it is necessary. Currently extended by adding clauses to this if statement.\"\"\" if full_message.message.function_call.name == \"get_articles\": try: parsed_output = json.loads( full_message.message.function_call.arguments ) print(\"Getting search results\") results = get_articles(parsed_output[\"query\"]) except Exception as e: print(parsed_output) print(f\"Function execution failed\") print(f\"Error message: {e}\") messages.append( { \"role\": \"function\", \"name\": full_message.message.function_call.name, \"content\": str(results), } ) try: print(\"Got search results, summarizing content\") response = chat_completion_request(messages) return response except Exception as e: print(type(e)) raise Exception(\"Function chat request failed\") elif ( full_message.message.function_call.name == \"read_article_and_summarize\" ): parsed_output = json.loads( full_message.message.function_call.arguments ) print(\"Finding and reading paper\") summary = summarize_text(parsed_output[\"query\"]) return summary else: raise Exception(\"Function does not exist and cannot be called\") arXiv conversation, Start with a system message\npaper_system_message = \"\"\"You are arXivGPT, a helpful assistant pulls academic papers to answer user questions. You summarize the papers clearly so the customer can decide which to read to answer their question. You always provide the article_url and title so the user can understand the name of the paper and click through to access it. Begin!\"\"\" paper_conversation = Conversation() paper_conversation.add_message(\"system\", paper_system_message) # Add a user message paper_conversation.add_message(\"user\", \"Hi, how does PPO reinforcement learning work?\") chat_response = chat_completion_with_function_execution( paper_conversation.conversation_history, functions=arxiv_functions ) assistant_message = chat_response.choices[0].message.content paper_conversation.add_message(\"assistant\", assistant_message) display(Markdown(assistant_message)) output:\nFunction generation requested, calling function Getting search results Got search results, summarizing content I found several papers related to PPO reinforcement learning. Here are a few summaries: Title: \"Bandit Profit-maximization for Targeted Marketing\" Summary: This paper presents near-optimal algorithms for optimizing profit over multiple demand curves, which are dependent on different ancillary variables while maintaining the same price. It is relevant to PPO reinforcement learning as it tackles a sequential profit-maximization problem. Article URL: Link Title: \"Inferring potential landscapes: A Schrödinger bridge approach to Maximum Caliber\" Summary: This work extends Schrödinger bridges to account for integral constraints along paths, specifically in the context of Maximum Caliber, a Maximum Entropy principle applied in a dynamic context. While not directly related to PPO reinforcement learning, it can provide insights into stochastic dynamics and inference of time-varying potential landscapes. Article URL: Link Title: \"a-DCF: an architecture agnostic metric with application to spoofing-robust speaker verification\" Summary: This paper proposes an architecture-agnostic detection cost function (a-DCF) for evaluating spoofing-robust automatic speaker verification (ASV) systems. Although it does not focus on PPO reinforcement learning, it provides a metric for evaluating ASV systems in the presence of spoofing attacks. Article URL: Link These papers should provide insights into different aspects of reinforcement learning and related topics. Add another user message to induce our system to use the second tool\npaper_conversation.add_message( \"user\", \"Can you read the PPO sequence generation paper for me and give me a summary\", ) updated_response = chat_completion_with_function_execution( paper_conversation.conversation_history, functions=arxiv_functions ) display(Markdown(updated_response.choices[0].message.content)) output:\nFunction generation requested, calling function Finding and reading paper Chunking text from paper Summarizing each chunk of text 100%|██████████| 4/4 [00:04\u003c00:00, 1.11s/it] Summarizing into overall summary Core Argument: The paper discusses the potential of using a general-purpose large language model (LLM) to learn the structural biophysics of DNA. The authors show that fine-tuning a LLM, specifically chatGPT 3.5-turbo, can enhance its ability to analyze and design DNA sequences and their structures. The study focuses on the formation of secondary structures in DNA, which are governed by base pairing and stacking bonds. The authors propose a method that involves chaining together models fine-tuned for subtasks and using a chain-of-thought approach to improve the model's performance. Evidence: The authors use the NUPACK software suite to provide data for training and validation. The expert pipeline approach involves using models that have been fine-tuned for subtasks and feeding their outputs into each other. The models perform better when they explicitly consider the nearest neighbor window and the reverse complement of the sequences. The pipeline approach, where a separate model determines the reverse complement and feeds it to another model for secondary structure prediction, enhances the accuracy of the predictions. The performance of the models improves with larger training sets. Conclusions: The study demonstrates the potential of using LLMs to learn DNA structural biophysics. Integrating experimental data and machine learning is important in scientific research. The expert pipeline approach and breaking down the problem into smaller subtasks improve the performance of the models in DNA sequence analysis. The combination of chain-of-thought and model pipeline provides the best results in analysis tasks. The CoT approach, combined with the reverse complement transformation, yields the highest accuracy in design tasks. The addition of an error checking layer further improves accuracy in design tasks. Sequence design is more challenging than analysis, but error correction can compensate for the increased difficulty. Larger training sets benefit design tasks more. Future research directions include exploring chaining smaller models for performance improvement and using an LLM architecture involving both an encoder and decoder for direct sequence comparison. Function calling via open source LLMs 在考虑成本和隐私性的背景下，我们可能会倾向于在开源的大型语言模型（LLM）上实现函数调用功能。目前，有几个框架支持以类似OpenAI API的形式调用工具（tools call）：\nXinference\nText Generation Inference (TGI)\n而在开源大型语言模型（LLM）方面，支持工具调用的主要有：\nLlama-3\nMixtral-8x7B-Instruct-v0.1\nqwent\nchatGLM-6B\nNexusRaven-13B\ngorilla-openfunctions-v1\n等等\n以下以Xinference和chatGLM-6B为例，探索如何通过OpenAI API的形式调用开源模型的函数调用功能。\n环境\n%pip install -U -q xinference[transformers] openai langchain !pip install typing-extensions --upgrade ## Start Local Server !nohup xinference-local \u003e xinference.log 2\u003e\u00261 \u0026 模型加载\n!xinference launch -u my-llm --model-name chatglm3 --size-in-billions 6 --model-format pytorch ## Interact with the running model import openai messages=[ { \"role\": \"user\", \"content\": \"Who are you?\" } ] client = openai.Client(api_key=\"empty\", base_url=f\"http://0.0.0.0:9997/v1\") client.chat.completions.create( model=\"my-llm\", messages=messages, ) # ChatCompletion(id='chatda6056ac-da01-11ee-b92e-0242ac1c000c', choices=[Choice(finish_reason='stop', index=0, logprobs=None, message=ChatCompletionMessage(content=\"I am an AI assistant named ChatGLM3-6B, which is developed based on the language model jointly trained by Tsinghua University KEG Lab and Zhipu AI Company in 2023. My job is to provide appropriate answers and support to users' questions and requests.\", role='assistant', function_call=None, tool_calls=None))], created=1709541198, model='my-llm', object='chat.completion', system_fingerprint=None, usage=CompletionUsage(completion_tokens=-1, prompt_tokens=-1, total_tokens=-1)) without tool using\ncompletion = client.chat.completions.create( model=\"my-llm\", messages=[{\"role\": \"user\", \"content\": \"What is the weather like in London?\"}] ) # print(handle_response(completion)) print(completion.choices[0].message.content) \"\"\" London has a temperate climate with warm summers and cool winters. The average temperature during the summer months (June to August) is around 18°C, while the winter months (December to February) are around 6°C. The city experiences heavy rainfall throughout the year, with an annual precipitation of around 350 mm. The average precipitation on the weekends is around 40 mm. London's cloudy skies are common throughout the year, but they are especially prevalent in December and January. \"\"\" tool using\ntools = [ { \"type\": \"function\", \"function\": { \"name\": \"get_current_weather\", \"description\": \"Get the current weather in a given location\", \"parameters\": { \"type\": \"object\", \"properties\": { \"location\": { \"type\": \"string\", \"description\": \"The city and state, e.g. San Francisco, CA\", }, \"unit\": { \"type\": \"string\", \"enum\": [\"celsius\", \"fahrenheit\"]}, }, \"required\": [\"location\"], }, }, } ] def get_completion(messages, model=\"my-llm\", temperature=0, max_tokens=500, tools=None, tool_choice=None): response = client.chat.completions.create( model=model, messages=messages, temperature=temperature, max_tokens=max_tokens, tools=tools, tool_choice=tool_choice ) return response.choices[0].message # Defines a dummy function to get the current weather def get_current_weather(location, unit=\"fahrenheit\"): \"\"\"Get the current weather in a given location\"\"\" weather = { \"location\": location, \"temperature\": \"50\", \"unit\": unit, } return json.dumps(weather) messages = [] messages.append({\"role\": \"user\", \"content\": \"What's the weather like in Boston!\"}) assistant_message = get_completion(messages, tools=tools, tool_choice=\"auto\") assistant_message = json.loads(assistant_message.model_dump_json()) assistant_message[\"content\"] = str(assistant_message[\"tool_calls\"][0][\"function\"]) #a temporary patch but this should be handled differently # remove \"function_call\" from assistant message del assistant_message[\"function_call\"] messages.append(assistant_message) # get the weather information to pass back to the model weather = get_current_weather(messages[1][\"tool_calls\"][0][\"function\"][\"arguments\"]) messages.append({\"role\": \"tool\", \"tool_call_id\": assistant_message[\"tool_calls\"][0][\"id\"], \"name\": assistant_message[\"tool_calls\"][0][\"function\"][\"name\"], \"content\": weather}) final_response = get_completion(messages, tools=tools) final_response \"\"\" ChatCompletionMessage(content='The current weather in Boston is 50 degrees Fahrenheit.', role='assistant', function_call=None, tool_calls=[]) \"\"\" LLM 在执行function calling时经历了什么 可惜我们并不能看到openAI的模型在服务器端发生了什么，但是根据开源的模型和推理框架，我们某种程度上，也能对LLM在执行function calling的背后逻辑一探究竟。\n这部分内容可以从推理框架和开源模型的源码中找到答案。\n根据xinference 的源码：https://github.com/xorbitsai/inference/blob/main/xinference/model/llm/utils.py#L42\n我们主要关注ChatGLM3 和Qwen\n当我们使用以下假设对话时：\nmessages=[ { \"role\": \"user\", \"content\": \"今天北京的天气怎么样？\" } ] tools = [ { \"name\": \"get_current_weather\", \"description\": \"Get the current weather in a given location\", \"parameters\": { \"type\": \"object\", \"properties\": { \"location\": { \"type\": \"string\", \"description\": \"The city and state, e.g. San Francisco, CA\", }, \"unit\": {\"type\": \"string\"}, }, \"required\": [\"location\"], }, } ] 根据GLM的官方文档，则最终给到ChatGLM3模型的prompt应该长这样：\n\u003c|system|\u003e Answer the following questions as best as you can. You have access to the following tools: [ { \"name\": \"get_current_weather\", \"description\": \"Get the current weather in a given location\", \"parameters\": { \"type\": \"object\", \"properties\": { \"location\": { \"type\": \"string\", \"description\": \"The city and state, e.g. San Francisco, CA\", }, \"unit\": {\"type\": \"string\"}, }, \"required\": [\"location\"], }, } ] \u003c|user|\u003e 今天北京的天气怎么样？ \u003c|assistant|\u003e 好的，让我们来查看今天的天气 \u003c|assistant|\u003eget_current_weather ```python tool_call(location=\"beijing\", unit=\"celsius\") ``` \u003c|observation|\u003e {\"temperature\": 22} \u003c|assistant|\u003e 根据查询结果，今天北京的气温为 22 摄氏度。 根据xinference 中有关qwen的代码\nelif prompt_style.style_name == \"QWEN\": if tools: tool_desc = \"\"\"{name_for_model}: Call this tool to interact with the {name_for_human} API. What is the {name_for_human} API useful for? {description_for_model} Parameters: {parameters} Format the arguments as a JSON object.\"\"\" react_instruction = \"\"\"Answer the following questions as best you can. You have access to the following APIs: {tools_text} Use the following format: Question: the input question you must answer Thought: you should always think about what to do Action: the action to take, should be one of [{tools_name_text}] Action Input: the input to the action Observation: the result of the action ... (this Thought/Action/Action Input/Observation can be repeated zero or more times) Thought: I now know the final answer Final Answer: the final answer to the original input question Begin!\"\"\" tools_text = [] tools_name_text = [] for func_info in tools: parameters = [] required_parameters = func_info[\"function\"][\"parameters\"].get( \"required\", [] ) for name, p in func_info[\"function\"][\"parameters\"][ \"properties\" ].items(): param = dict({\"name\": name}, **p) if name in required_parameters: param[\"required\"] = True parameters.append(param) name = func_info[\"function\"][\"name\"] desc = func_info[\"function\"][\"description\"] tool_string = tool_desc.format( name_for_model=name, name_for_human=name, # Hint: You can add the following format requirements in description: # \"Format the arguments as a JSON object.\" # \"Enclose the code within triple backticks (`) at the beginning and end of the code.\" description_for_model=desc, parameters=json.dumps(parameters, ensure_ascii=False), ) tools_text.append(tool_string) tools_name_text.append(name) tools_text_string = \"\\n\\n\".join(tools_text) tools_name_text_string = \", \".join(tools_name_text) tool_system = react_instruction.format( tools_text=tools_text_string, tools_name_text=tools_name_text_string, ) else: tool_system = \"\" ret = f\"\u003c|im_start|\u003esystem\\n{prompt_style.system_prompt}\u003c|im_end|\u003e\" for message in chat_history: role = get_role(message[\"role\"]) content = message[\"content\"] ret += prompt_style.intra_message_sep if tools: if role == \"user\": if tool_system: content = tool_system + f\"\\n\\nQuestion: {content}\" tool_system = \"\" else: content = f\"Question: {content}\" elif role == \"assistant\": tool_calls = message.get(\"tool_calls\") if tool_calls: func_call = tool_calls[0][\"function\"] f_name, f_args = ( func_call[\"name\"], func_call[\"arguments\"], ) content = f\"Thought: I can use {f_name}.\\nAction: {f_name}\\nAction Input: {f_args}\" elif content: content = f\"Thought: I now know the final answer.\\nFinal answer: {content}\" elif role == \"tool\": role = \"function\" content = f\"Observation: {content}\" else: raise Exception(f\"Unsupported message role: {role}\") if content: content = content.lstrip(\"\\n\").rstrip() ret += f\"\u003c|im_start|\u003e{role}\\n{content}\u003c|im_end|\u003e\" else: ret += f\"\u003c|im_start|\u003e{role}\\n\" return ret 会稍微复杂一些， 利用了react的COT方式（代码中的react_instruction），要求模型以一系列的**Thought（思考）、Action（行动）、Action Input（行动输入）和Observation**（观察结果）步骤，最终给出问题的答案，以增加正确性。\n假设使用以下工具列表和对话历史：\n# 工具列表 tools = [ { \"function\": { \"name\": \"geo_lookup\", \"description\": \"Retrieves geographical information.\", \"parameters\": { \"required\": [\"query\"], \"properties\": { \"query\": { \"type\": \"string\", \"description\": \"The query to lookup.\" } } } } } ] chat_history = [ { \"role\": \"user\", \"content\": \"What is the population of Tokyo?\" }, { \"role\": \"assistant\", \"tool_calls\": [ { \"function\": \"geo_lookup\", \"arguments\": { \"query\": \"Tokyo\" } } ], \"content\": \"The population of Tokyo is about 14 million.\" } ] 可以推断出，最终输入Qwen的prompt应该长这样：\nsystem Answer the following questions as best you can. You have access to the following APIs: geo_lookup: Call this tool to interact with the geo_lookup API. What is the geo_lookup API useful for? Retrieves geographical information. Parameters: [{\"name\": \"query\", \"type\": \"string\", \"description\": \"The query to lookup.\", \"required\": true}] Format the arguments as a JSON object. Use the following format: Question: the input question you must answer Thought: you should always think about what to do Action: the action to take, should be one of [geo_lookup] Action Input: the input to the action Observation: the result of the action ... (this Thought/Action/Action Input/Observation can be repeated zero or more times) Thought: I now know the final answer Final Answer: the final answer to the original input question Begin! user Question: What is the population of Tokyo? assistant Thought: I can use geo_lookup to find the information. Action: geo_lookup Action Input: {\"query\": \"Tokyo\"} Observation: The population of Tokyo is about 14 million. Thought: I now know the final answer. Final answer: The population of Tokyo is about 14 million. 在这个例子中，用户询问东京的人口数量。助手利用**geo_lookup**工具进行查询，具体的行动步骤包括：\n思考：助手决定可以使用**geo_lookup**工具来查找信息。\n行动：实际调用**geo_lookup**工具。\n行动输入：向工具传递的参数，即查询**\"Tokyo\"**。\n观察：观察到的结果，这里是东京的人口大约为1400万。\n最终思考：基于观察结果，助手得出了最终答案。\n最终答案：向用户提供的答案，即东京的人口数量。\n更详细的内容，建议看这篇知乎文章：Qwen Function Calling 的对话模板及训练方法总结; 以及qwen的官方文档：ReAct Prompting 示例\n参考 openAI function calling\nHow to call functions with chat models\nHow_to_call_functions_for_knowledge_retrieval\nQwen Function Calling 的对话模板及训练方法总结\nqwen的官方文档\nGLM的官方文档\ntool-using via Groq API\nJson mode in Groq\nOpenAI JSON Mode \u0026 Seeding\nOpenAI API Guide: Using JSON Mode\n",
  "wordCount" : "4726",
  "inLanguage": "en",
  "image": "https://niraya666.github.io/images/papermod-cover.png","datePublished": "2024-04-28T15:00:00+08:00",
  "dateModified": "2024-04-28T15:00:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Theme PaperMod"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://niraya666.github.io/posts/agent%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0openai-function-calling%E5%AE%8C%E5%85%A8%E6%8C%87%E5%8D%97/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LZY Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://niraya666.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://niraya666.github.io/" accesskey="h" title="LZY Blog (Alt + H)">LZY Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://niraya666.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/musik/" title="musik!">
                    <span>musik!</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/monthly/" title="月刊">
                    <span>月刊</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/essay/" title="杂文">
                    <span>杂文</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/travel/" title="游记">
                    <span>游记</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://niraya666.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://niraya666.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Agent学习笔记：OpenAI Function Calling完全指南
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
    </h1>
    <div class="post-meta"><span title='2024-04-28 15:00:00 +0800 CST'>April 28, 2024</span>&nbsp;·&nbsp;23 min&nbsp;·&nbsp;Theme PaperMod

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e5%86%99%e5%9c%a8%e6%9c%80%e5%bc%80%e5%a7%8b" aria-label="写在最开始">写在最开始</a></li>
                <li>
                    <a href="#%e4%bd%95%e4%b8%bafunction-calling" aria-label="何为function calling">何为function calling</a></li>
                <li>
                    <a href="#%e4%b8%80%e4%ba%9b%e5%b8%b8%e8%a7%81%e7%9a%84%e9%97%ae%e9%a2%98" aria-label="一些常见的问题">一些常见的问题</a><ul>
                        
                <li>
                    <a href="#json-mode" aria-label="JSON mode">JSON mode</a></li></ul>
                </li>
                <li>
                    <a href="#%e5%a6%82%e4%bd%95%e4%bd%bf%e7%94%a8openai-function-calling" aria-label="如何使用OpenAI function calling">如何使用OpenAI function calling</a><ul>
                        
                <li>
                    <a href="#%e5%a4%a9%e6%b0%94%e6%9f%a5%e8%af%a2%e7%9a%84%e7%ae%80%e5%8d%95%e7%a4%ba%e4%be%8b" aria-label="天气查询的简单示例">天气查询的简单示例</a></li>
                <li>
                    <a href="#%e9%80%9a%e8%bf%87function-calling-%e5%ae%9e%e7%8e%b0sql%e6%89%a7%e8%a1%8c" aria-label="通过function calling 实现sql执行">通过function calling 实现sql执行</a></li>
                <li>
                    <a href="#%e5%9f%ba%e4%ba%8efunction-calling%e6%9e%84%e5%bb%ba%e6%99%ba%e8%83%bd%e4%bb%a3%e7%90%86%e8%87%aa%e5%8a%a8%e8%8e%b7%e5%8f%96%e4%b8%8e%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90arxiv%e5%ad%a6%e6%9c%af%e6%96%87%e7%ab%a0" aria-label="基于function calling构建智能代理：自动获取与深度解析arXiv学术文章">基于function calling构建智能代理：自动获取与深度解析arXiv学术文章</a></li></ul>
                </li>
                <li>
                    <a href="#function-calling-via-open-source-llms" aria-label="Function calling via open source LLMs">Function calling via open source LLMs</a></li>
                <li>
                    <a href="#llm-%e5%9c%a8%e6%89%a7%e8%a1%8cfunction-calling%e6%97%b6%e7%bb%8f%e5%8e%86%e4%ba%86%e4%bb%80%e4%b9%88" aria-label="LLM 在执行function calling时经历了什么">LLM 在执行function calling时经历了什么</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="参考">参考</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="写在最开始">写在最开始<a hidden class="anchor" aria-hidden="true" href="#写在最开始">#</a></h2>
<p>当我们在讨论基于大型语言模型（LLM-based）的智能代理（agent）时，我们究竟在谈论什么？根据Lilian W在其文章《LLM Powered Autonomous Agents》中的讨论，一个智能代理需要具备几个核心能力：规划（Planning）、记忆（Memory）、以及工具使用（Tool use）。特别地，工具使用方面的进展，得益于OpenAI在API中提供的function calling功能，为我们开启了新的可能性。</p>
<p><img loading="lazy" src="https://lilianweng.github.io/posts/2023-06-23-agent/agent-overview.png" alt="AGI"  />
</p>
<p>OpenAI function calling，作为智能代理与外部工具交互的基本方式，对于每位从业者来说都是必备技能。随着技术的发展，我们期望的不只是能与我们对话的LLM，而是能够辅助我们使用各种工具、做出决策的智能伙伴。</p>
<p>不过需要特别指出的是，最近OpenAI在Chat Completions API中已经废弃了“函数（function）”的使用，转而采用“工具（tool）”。这一变更旨在拓宽LLM集成的功能范围，为更复杂的交互模式铺平道路，如构建能够相互作用的多代理系统。</p>
<p><img loading="lazy" src="/img/Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/tool-using/%e6%88%aa%e5%b1%8f2024-03-28%2015.16.54.png" alt="截屏2024-03-28 15.16.54.png"  />
</p>
<p><img loading="lazy" src="/img/Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0/tool-using/%e6%88%aa%e5%b1%8f2024-03-28%2015.17.38.png" alt="截屏2024-03-28 15.17.38.png"  />
</p>
<p>尽管如此，由于语言习惯的原因，本文中仍然会使用function calling的术语来描述OpenAI的tool using功能，因为“function calling”的说法已经深入人心了。</p>
<p><strong>核心内容概览</strong></p>
<ol>
<li>
<p><strong>Function Calling的定义</strong>：解释什么是function calling，以及它在智能代理工作中的作用。</p>
</li>
<li>
<p><strong>OpenAI Cookbook示例</strong>：提供实际的function calling示例，帮助读者理解其在实际应用中的用途。</p>
</li>
<li>
<p><strong>开源LLM的Tool Using</strong>：探索如何在开源大型语言模型中实现工具使用，以及LLM在tool using的时候经历了什么。</p>
</li>
<li>
<p><strong><del>评价与训练</del></strong><del>：讨论如何评价开源模型的工具使用能力，以及如何训练LLM进行有效的工具使用。</del></p>
</li>
</ol>
<p>鉴于整理笔记的速度远赶不上更新的速度， 会将第四部份作为单独的部分整理。</p>
<h2 id="何为function-calling">何为function calling<a hidden class="anchor" aria-hidden="true" href="#何为function-calling">#</a></h2>
<p>一句话解释：<strong>function calling从本质上并不是严格的工具调用， 而是作为工具调用的前奏，它通过更加结构化的方式指导LLM输出，为在本地执行具体函数提供了参数，铺平了道路。</strong></p>
<p>具体来说，function calling允许LLM在执行过程中通过指定的参数来调用并执行一个特定的函数。这种方式不仅实现了代码的重用和模块化处理，而且能够从模型中获取更可靠的结构化数据回应。在API调用过程中，开发者可以描述想要执行的功能，并让模型智能地选择输出包含所需参数的JSON对象。<strong>这个过程中，Chat Completions API本身不直接执行任何函数调用，而是生成了可以在开发者代码中实现函数调用的JSON。</strong></p>
<p>function calling的应用范围广泛，如</p>
<ul>
<li>
<p>创建智能助手：通过调用外部API回答问题。</p>
</li>
<li>
<p>转换指令：将自然语言指令转换成API调用指令。</p>
</li>
<li>
<p>数据提取：从文本中提取结构化数据。</p>
</li>
</ul>
<p>function calling的过程涵盖了从定义函数集、通过模型生成遵循自定义模式的JSON对象字符串，到在代码中解析这个字符串并调用相应函数的全过程。这一连串操作不仅自动化了交互过程，还确保了执行操作的安全性和准确性。</p>
<h2 id="一些常见的问题">一些常见的问题<a hidden class="anchor" aria-hidden="true" href="#一些常见的问题">#</a></h2>
<h3 id="json-mode">JSON mode<a hidden class="anchor" aria-hidden="true" href="#json-mode">#</a></h3>
<p>json mode 和tool-using 有什么关系？有了json mode 还需要用到tool-using吗？</p>
<p>从json mode 的本质， 更多的是在system prompt 增加一句类似“请以json格式输出”之类的话，然后在LLM输出时增加json结果检查和格式转换。在使用时只需要在<code>client.chat.completions.create </code>中 增加<code>response_format={ &quot;type&quot;: &quot;json_object&quot; }</code> 即可。</p>
<p>那么json mode 什么时候会用到呢？一般在做文本提取，内容提取时可以使用；以RAG场景为例， 当我们希望LLM能够帮我们对用户的query进行改写时，我们肯定是希望模型能够返回干净的json格式改写结果，这样的结果可以直接使用，而不是在模型输出一些内容后，如：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">好的，以下是我的改写内容：
</span></span></span><span class="line"><span class="cl"><span class="s2">```
</span></span></span><span class="line"><span class="cl"><span class="s2">real-rewrite-query
</span></span></span><span class="line"><span class="cl"><span class="s2">```
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>其中包含了一些模型喜欢输出的客套话，此时我们需要通过正则匹配等方法将真正希望使用内容提取出来。而这时候json mode可以直接输出需要的内容， 而跳过了额外的提取步骤。在json mode 出现之前，这样的处理我们也尝试使用过tool-using 的模式，但有点大材小用了。</p>
<p>很显然， tool-using的真正强大之处并不只是对输出格式进行处理， 而是能够让模型从提供的多个tools中选择需要使用的。</p>
<h2 id="如何使用openai-function-calling">如何使用OpenAI function calling<a hidden class="anchor" aria-hidden="true" href="#如何使用openai-function-calling">#</a></h2>
<h3 id="天气查询的简单示例">天气查询的简单示例<a hidden class="anchor" aria-hidden="true" href="#天气查询的简单示例">#</a></h3>
<p><strong>环境配置</strong></p>
<p>首先，我们需要安装一些必要的Python库。这些库将帮助我们与OpenAI的API进行交互，以及完成一些辅助功能。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">scipy</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">tenacity</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">tiktoken</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">termcolor</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">openai</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&#34;OPENAI_API_KEY&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&#34;...&#34;</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">wait_random_exponential</span><span class="p">,</span> <span class="n">stop_after_attempt</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>
</span></span></code></pre></div><p><strong>工具函数定义</strong></p>
<p>接下来，我们定义一些实用函数，这些函数旨在方便我们向Chat Completions API发送请求，并管理与跟踪对话状态。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@retry</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="n">multiplier</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">chat_completion_request</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&#34;gpt-3.5-turbo&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Unable to generate ChatCompletion response&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">pretty_print_conversation</span><span class="p">(</span><span class="n">messages</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">role_to_color</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;system&#34;</span><span class="p">:</span> <span class="s2">&#34;red&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;green&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;assistant&#34;</span><span class="p">:</span> <span class="s2">&#34;blue&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="s2">&#34;magenta&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">messages</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;system&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;system: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">role_to_color</span><span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]]))</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;user&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;user: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">role_to_color</span><span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]]))</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;assistant&#34;</span> <span class="ow">and</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;function_call&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;assistant: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;function_call&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">role_to_color</span><span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]]))</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;assistant&#34;</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;function_call&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;assistant: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">role_to_color</span><span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]]))</span>
</span></span><span class="line"><span class="cl">        <span class="k">elif</span> <span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&#34;function&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">colored</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;function (</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">): </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">,</span> <span class="n">role_to_color</span><span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]]))</span>
</span></span></code></pre></div><p><strong>函数规范定义</strong></p>
<p>我们还需要创建一些函数规范，以接口化与假设的天气API的交互。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;get_current_weather&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Get the current weather&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The city and state, e.g. San Francisco, CA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;enum&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;celsius&#34;</span><span class="p">,</span> <span class="s2">&#34;fahrenheit&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The temperature unit to use. Infer this from the users location.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;location&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;get_n_day_weather_forecast&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Get an N-day weather forecast&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The city and state, e.g. San Francisco, CA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;enum&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;celsius&#34;</span><span class="p">,</span> <span class="s2">&#34;fahrenheit&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The temperature unit to use. Infer this from the users location.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;num_days&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;integer&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The number of days to forecast&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;location&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">,</span> <span class="s2">&#34;num_days&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p><strong>对话示例</strong></p>
<p>当我们请求当前天气时， LLM会要求澄清问题，如地址等参数信息：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Don&#39;t make assumptions about what values to plug into functions. Ask for clarification if a user request is ambiguous.&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;What&#39;s the weather like today&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span>
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ChatCompletionMessage<span class="o">(</span><span class="nv">content</span><span class="o">=</span><span class="s1">&#39;Sure, may I know your current location?&#39;</span>, <span class="nv">role</span><span class="o">=</span><span class="s1">&#39;assistant&#39;</span>, <span class="nv">function_call</span><span class="o">=</span>None, <span class="nv">tool_calls</span><span class="o">=</span>None<span class="o">)</span>
</span></span></code></pre></div><p>当补充缺失的信息后， LLM将生成适当的函数参数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;I&#39;m in Shanghai, China.&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span>
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ChatCompletionMessage<span class="o">(</span><span class="nv">content</span><span class="o">=</span>None, <span class="nv">role</span><span class="o">=</span><span class="s1">&#39;assistant&#39;</span>, <span class="nv">function_call</span><span class="o">=</span>None, <span class="nv">tool_calls</span><span class="o">=[</span>ChatCompletionMessageToolCall<span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="s1">&#39;call_VdqOOMp9pagf5ho39Y2HmYV4&#39;</span>, <span class="k">function</span><span class="o">=</span>Function<span class="o">(</span><span class="nv">arguments</span><span class="o">=</span><span class="s1">&#39;{\n  &#34;location&#34;: &#34;San Francisco, CA&#34;,\n  &#34;format&#34;: &#34;celsius&#34;,\n  &#34;num_days&#34;: 4\n}&#39;</span>, <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;get_n_day_weather_forecast&#39;</span><span class="o">)</span>, <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="o">)])</span>
</span></span></code></pre></div><p>完整流程如下：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Don&#39;t make assumptions about what values to plug into functions. Ask for clarification if a user request is ambiguous.&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;what is the weather going to be like in Glasgow, Scotland over the next x days&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;in 5 days&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span>
</span></span></code></pre></div><p>当然， 我们也可以强制要求使用特定的函数</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Don&#39;t make assumptions about what values to plug into functions. Ask for clarification if a user request is ambiguous.&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Give me a weather report for Toronto, Canada.&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;function&#34;</span><span class="p">,</span> <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;get_n_day_weather_forecast&#34;</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">ChatCompletionMessage<span class="o">(</span><span class="nv">content</span><span class="o">=</span>None, <span class="nv">role</span><span class="o">=</span><span class="s1">&#39;assistant&#39;</span>, <span class="nv">function_call</span><span class="o">=</span>None, <span class="nv">tool_calls</span><span class="o">=[</span>ChatCompletionMessageToolCall<span class="o">(</span><span class="nv">id</span><span class="o">=</span><span class="s1">&#39;call_0ldecDpV8Vdq8mGPoUewlue3&#39;</span>, <span class="k">function</span><span class="o">=</span>Function<span class="o">(</span><span class="nv">arguments</span><span class="o">=</span><span class="s1">&#39;{\n  &#34;location&#34;: &#34;Toronto, Canada&#34;,\n  &#34;format&#34;: &#34;celsius&#34;,\n  &#34;num_days&#34;: 1\n}&#39;</span>, <span class="nv">name</span><span class="o">=</span><span class="s1">&#39;get_n_day_weather_forecast&#39;</span><span class="o">)</span>, <span class="nv">type</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="o">)])</span>
</span></span></code></pre></div><p><strong>并行函数调用</strong></p>
<p>对于一些特定模型，如**<code>gpt-4-turbo-preview</code>**, <strong><code>gpt-4-0125-preview</code></strong>, <strong><code>gpt-4-1106-preview</code></strong>, <strong><code>gpt-3.5-turbo-0125</code></strong>, and **<code>gpt-3.5-turbo-1106</code>**支持并行函数调用， 允许我们在单个回合中调用多个函数。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Don&#39;t make assumptions about what values to plug into functions. Ask for clarification if a user request is ambiguous.&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;what is the weather going to be like in San Francisco and Glasgow over the next 4 days&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span>
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">[</span><span class="n">ChatCompletionMessageToolCall</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;call_tfl8eTCW64sHvHjiiatoYzku&#39;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">Function</span><span class="p">(</span><span class="n">arguments</span><span class="o">=</span><span class="s1">&#39;{&#34;location&#34;: &#34;San Francisco, CA&#34;, &#34;format&#34;: &#34;fahrenheit&#34;, &#34;num_days&#34;: 4}&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_n_day_weather_forecast&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"> <span class="n">ChatCompletionMessageToolCall</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;call_bAqj55RygP2Y1T85RHqgskku&#39;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">Function</span><span class="p">(</span><span class="n">arguments</span><span class="o">=</span><span class="s1">&#39;{&#34;location&#34;: &#34;Glasgow, UK&#34;, &#34;format&#34;: &#34;celsius&#34;, &#34;num_days&#34;: 4}&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;get_n_day_weather_forecast&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)]</span>
</span></span></code></pre></div><p>实现本地函数调用</p>
<p>首先我们需要构造两个用于演示的假function</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_current_weather</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&#34;fahrenheit&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Simulates getting the current weather for a given location.
</span></span></span><span class="line"><span class="cl"><span class="s2">    The response is hardcoded for demonstration purposes.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        location (str): The city and state, e.g., San Francisco, CA.
</span></span></span><span class="line"><span class="cl"><span class="s2">        format (str, optional): The temperature unit to use. Defaults to &#34;fahrenheit&#34;.
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        str: JSON string with the current weather data.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="s2">&#34;tokyo&#34;</span> <span class="ow">in</span> <span class="n">location</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="s2">&#34;Tokyo&#34;</span><span class="p">,</span> <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;10&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Partly Cloudy&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="s2">&#34;san francisco&#34;</span> <span class="ow">in</span> <span class="n">location</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="s2">&#34;San Francisco&#34;</span><span class="p">,</span> <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;72&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Sunny&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="s2">&#34;paris&#34;</span> <span class="ow">in</span> <span class="n">location</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="s2">&#34;Paris&#34;</span><span class="p">,</span> <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;22&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Rainy&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span> <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;unknown&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Data Unavailable&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_n_day_weather_forecast</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">num_days</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&#34;fahrenheit&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    Simulates getting an N-day weather forecast for a given location.
</span></span></span><span class="line"><span class="cl"><span class="s2">    The response is hardcoded for demonstration purposes.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        location (str): The city and state, e.g., San Francisco, CA.
</span></span></span><span class="line"><span class="cl"><span class="s2">        num_days (int): The number of days to forecast.
</span></span></span><span class="line"><span class="cl"><span class="s2">        format (str, optional): The temperature unit to use. Defaults to &#34;fahrenheit&#34;.
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        str: JSON string with the N-day weather forecast data.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># This example just returns a fixed response regardless of the input.</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># In a real scenario, the response would depend on the location, num_days, and format.</span>
</span></span><span class="line"><span class="cl">    <span class="n">forecast</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;day&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;22&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Sunny&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;day&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;18&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Cloudy&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;day&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;15&#34;</span><span class="p">,</span> <span class="s2">&#34;format&#34;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Rainy&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="c1"># Return only the forecast for the requested number of days.</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">forecast</span><span class="p">[:</span><span class="n">num_days</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">available_functions</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;get_current_weather&#34;</span><span class="p">:</span> <span class="n">get_current_weather</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;get_n_day_weather_forecast&#34;</span><span class="p">:</span> <span class="n">get_n_day_weather_forecast</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><p>尝试请求天气</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;What&#39;s the weather like in Tokyo!&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&#34;auto&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">assistant_message</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;content&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;tool_calls&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;function&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#a temporary patch but this should be handled differently</span>
</span></span><span class="line"><span class="cl"><span class="c1"># remove &#34;function_call&#34; from assistant message</span>
</span></span><span class="line"><span class="cl"><span class="k">del</span> <span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;function_call&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;content&#39;: &#39;{</span><span class="se">\&#39;</span><span class="s2">arguments</span><span class="se">\&#39;</span><span class="s2">: </span><span class="se">\&#39;</span><span class="s2">{</span><span class="se">\\</span><span class="s2">n  &#34;location&#34;: &#34;Tokyo&#34;,</span><span class="se">\\</span><span class="s2">n  &#34;format&#34;: &#34;celsius&#34;</span><span class="se">\\</span><span class="s2">n}</span><span class="se">\&#39;</span><span class="s2">, </span><span class="se">\&#39;</span><span class="s2">name</span><span class="se">\&#39;</span><span class="s2">: </span><span class="se">\&#39;</span><span class="s2">get_current_weather</span><span class="se">\&#39;</span><span class="s2">}&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#39;role&#39;: &#39;assistant&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2"> &#39;tool_calls&#39;: [{&#39;id&#39;: &#39;call_Tz8S1HgvnaBzf6CFZP1u4d1J&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">   &#39;function&#39;: {&#39;arguments&#39;: &#39;{</span><span class="se">\n</span><span class="s2">  &#34;location&#34;: &#34;Tokyo&#34;,</span><span class="se">\n</span><span class="s2">  &#34;format&#34;: &#34;celsius&#34;</span><span class="se">\n</span><span class="s2">}&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#39;name&#39;: &#39;get_current_weather&#39;},
</span></span></span><span class="line"><span class="cl"><span class="s2">   &#39;type&#39;: &#39;function&#39;}]}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">)</span>
</span></span></code></pre></div><p>可以看到，LLM返回了json格式的参数信息（其实是str）以及需要调用的function名称， 拥有这些信息之后就可以调用之前定义的函数了</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># get the weather information to pass back to the model</span>
</span></span><span class="line"><span class="cl"><span class="n">function_name_to_call</span> <span class="o">=</span> <span class="n">assistant_message</span><span class="p">[</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;function&#39;</span><span class="p">][</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">function_arguments</span> <span class="o">=</span> <span class="n">assistant_message</span><span class="p">[</span><span class="s1">&#39;tool_calls&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;function&#39;</span><span class="p">][</span><span class="s1">&#39;arguments&#39;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">weather</span> <span class="o">=</span> <span class="n">available_functions</span><span class="p">[</span><span class="n">function_name_to_call</span><span class="p">](</span><span class="n">function_arguments</span><span class="p">)</span>
</span></span></code></pre></div><p>将函数执行结果和对话历史返回给LLM</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;tool&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="s2">&#34;tool_call_id&#34;</span><span class="p">:</span> <span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;tool_calls&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;id&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                 <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;tool_calls&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;function&#34;</span><span class="p">][</span><span class="s2">&#34;name&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                 <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="n">weather</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">messages</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">[{&#39;role&#39;: &#39;user&#39;, &#39;content&#39;: &#34;What&#39;s the weather like in Tokyo!&#34;},
</span></span></span><span class="line"><span class="cl"><span class="s2"> {&#39;content&#39;: &#39;{</span><span class="se">\&#39;</span><span class="s2">arguments</span><span class="se">\&#39;</span><span class="s2">: </span><span class="se">\&#39;</span><span class="s2">{</span><span class="se">\\</span><span class="s2">n  &#34;location&#34;: &#34;Tokyo&#34;,</span><span class="se">\\</span><span class="s2">n  &#34;format&#34;: &#34;celsius&#34;</span><span class="se">\\</span><span class="s2">n}</span><span class="se">\&#39;</span><span class="s2">, </span><span class="se">\&#39;</span><span class="s2">name</span><span class="se">\&#39;</span><span class="s2">: </span><span class="se">\&#39;</span><span class="s2">get_current_weather</span><span class="se">\&#39;</span><span class="s2">}&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">  &#39;role&#39;: &#39;assistant&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">  &#39;tool_calls&#39;: [{&#39;id&#39;: &#39;call_Tz8S1HgvnaBzf6CFZP1u4d1J&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#39;function&#39;: {&#39;arguments&#39;: &#39;{</span><span class="se">\n</span><span class="s2">  &#34;location&#34;: &#34;Tokyo&#34;,</span><span class="se">\n</span><span class="s2">  &#34;format&#34;: &#34;celsius&#34;</span><span class="se">\n</span><span class="s2">}&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">     &#39;name&#39;: &#39;get_current_weather&#39;},
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#39;type&#39;: &#39;function&#39;}]},
</span></span></span><span class="line"><span class="cl"><span class="s2"> {&#39;role&#39;: &#39;tool&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">  &#39;tool_call_id&#39;: &#39;call_Tz8S1HgvnaBzf6CFZP1u4d1J&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">  &#39;name&#39;: &#39;get_current_weather&#39;,
</span></span></span><span class="line"><span class="cl"><span class="s2">  &#39;content&#39;: &#39;{&#34;location&#34;: &#34;Tokyo&#34;, &#34;temperature&#34;: &#34;10&#34;, &#34;format&#34;: &#34;fahrenheit&#34;}&#39;}]
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>最终输出结果（for user）</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">final_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">final_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span></span></code></pre></div><p>output：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="s1">&#39;The current weather in Tokyo is partly cloudy with a temperature of 10°C (50°F).&#39;</span>
</span></span></code></pre></div><hr>
<h3 id="通过function-calling-实现sql执行">通过function calling 实现sql执行<a hidden class="anchor" aria-hidden="true" href="#通过function-calling-实现sql执行">#</a></h3>
<p>下载演示所用的sqlite数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">!wget https://www.sqlitetutorial.net/wp-content/uploads/2018/03/chinook.zip -O chinook.zip
</span></span><span class="line"><span class="cl">!unzip chinook.zip
</span></span></code></pre></div><p>连接数据库，和定义一些function</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">sqlite3</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&#34;/content/chinook.db&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Opened database successfully&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_table_names</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Return a list of table names.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">table_names</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">tables</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&#34;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">table_names</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_column_names</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table_name</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Return a list of column names.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">column_names</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="n">columns</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;PRAGMA table_info(&#39;</span><span class="si">{</span><span class="n">table_name</span><span class="si">}</span><span class="s2">&#39;);&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">column_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">col</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">column_names</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_database_info</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Return a list of dicts containing the table name and columns for each table in the database.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">table_dicts</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">table_name</span> <span class="ow">in</span> <span class="n">get_table_names</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">columns_names</span> <span class="o">=</span> <span class="n">get_column_names</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">table_dicts</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;table_name&#34;</span><span class="p">:</span> <span class="n">table_name</span><span class="p">,</span> <span class="s2">&#34;column_names&#34;</span><span class="p">:</span> <span class="n">columns_names</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">table_dicts</span>
</span></span></code></pre></div><p>获取db 的schema</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">database_schema_dict</span> <span class="o">=</span> <span class="n">get_database_info</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">database_schema_string</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="sa">f</span><span class="s2">&#34;Table: </span><span class="si">{</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;table_name&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n</span><span class="s2">Columns: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;column_names&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">database_schema_dict</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>定义tools工具列表</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;ask_database&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Use this function to answer user questions about music. Input should be a fully formed SQL query.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                                SQL query extracting info to answer the user&#39;s question.
</span></span></span><span class="line"><span class="cl"><span class="s2">                                SQL should be written using this database schema:
</span></span></span><span class="line"><span class="cl"><span class="s2">                                </span><span class="si">{</span><span class="n">database_schema_string</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                                The query should be returned in plain text, not in JSON.
</span></span></span><span class="line"><span class="cl"><span class="s2">                                &#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;query&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>定义用于执行sql的function</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">ask_database</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Function to query SQLite database with a provided SQL query.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">fetchall</span><span class="p">())</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;query failed with error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">results</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">execute_function_call</span><span class="p">(</span><span class="n">message</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;ask_database&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">query</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">arguments</span><span class="p">)[</span><span class="s2">&#34;query&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="n">ask_database</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">results</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;Error: function </span><span class="si">{</span><span class="n">message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> does not exist&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">results</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Answer user questions by generating SQL queries against the Chinook Music Database.&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Hi, who are the top 5 artists by number of tracks?&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="n">assistant_message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="n">execute_function_call</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;tool&#34;</span><span class="p">,</span> <span class="s2">&#34;tool_call_id&#34;</span><span class="p">:</span> <span class="n">assistant_message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="n">assistant_message</span><span class="o">.</span><span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">function</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="n">results</span><span class="p">})</span>
</span></span></code></pre></div><p>此时的messages</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="p">[{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;system&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Answer user questions by generating SQL queries against the Chinook Music Database.&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s1">&#39;Hi, who are the top 5 artists by number of tracks?&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"> <span class="n">ChatCompletionMessage</span><span class="p">(</span><span class="n">content</span><span class="o">=</span><span class="s1">&#39;Function(arguments=</span><span class="se">\&#39;</span><span class="s1">{</span><span class="se">\\</span><span class="s1">n  &#34;query&#34;: &#34;SELECT artists.Name, COUNT(tracks.TrackId) AS num_tracks FROM artists JOIN albums ON artists.ArtistId = albums.ArtistId JOIN tracks ON albums.AlbumId = tracks.AlbumId GROUP BY artists.ArtistId ORDER BY num_tracks DESC LIMIT 5&#34;</span><span class="se">\\</span><span class="s1">n}</span><span class="se">\&#39;</span><span class="s1">, name=</span><span class="se">\&#39;</span><span class="s1">ask_database</span><span class="se">\&#39;</span><span class="s1">)&#39;</span><span class="p">,</span> <span class="n">role</span><span class="o">=</span><span class="s1">&#39;assistant&#39;</span><span class="p">,</span> <span class="n">function_call</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tool_calls</span><span class="o">=</span><span class="p">[</span><span class="n">ChatCompletionMessageToolCall</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="s1">&#39;call_vSLysEQncbGvMgXGhttIow6v&#39;</span><span class="p">,</span> <span class="n">function</span><span class="o">=</span><span class="n">Function</span><span class="p">(</span><span class="n">arguments</span><span class="o">=</span><span class="s1">&#39;{</span><span class="se">\n</span><span class="s1">  &#34;query&#34;: &#34;SELECT artists.Name, COUNT(tracks.TrackId) AS num_tracks FROM artists JOIN albums ON artists.ArtistId = albums.ArtistId JOIN tracks ON albums.AlbumId = tracks.AlbumId GROUP BY artists.ArtistId ORDER BY num_tracks DESC LIMIT 5&#34;</span><span class="se">\n</span><span class="s1">}&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;ask_database&#39;</span><span class="p">),</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;function&#39;</span><span class="p">)]),</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span><span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="s1">&#39;tool&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;tool_call_id&#39;</span><span class="p">:</span> <span class="s1">&#39;call_vSLysEQncbGvMgXGhttIow6v&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="s1">&#39;ask_database&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="s1">&#39;content&#39;</span><span class="p">:</span> <span class="s2">&#34;[(&#39;Iron Maiden&#39;, 213), (&#39;U2&#39;, 135), (&#39;Led Zeppelin&#39;, 114), (&#39;Metallica&#39;, 112), (&#39;Deep Purple&#39;, 92)]&#34;</span><span class="p">}]</span>
</span></span></code></pre></div><p>最终输出：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">final_response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">final_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span></span><span class="line"><span class="cl"><span class="c1"># output</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">The top 5 artists by number of tracks are:
</span></span></span><span class="line"><span class="cl"><span class="s2">1. Iron Maiden - 213 tracks
</span></span></span><span class="line"><span class="cl"><span class="s2">2. U2 - 135 tracks
</span></span></span><span class="line"><span class="cl"><span class="s2">3. Led Zeppelin - 114 tracks
</span></span></span><span class="line"><span class="cl"><span class="s2">4. Metallica - 112 tracks
</span></span></span><span class="line"><span class="cl"><span class="s2">5. Deep Purple - 92 tracks
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><hr>
<h3 id="基于function-calling构建智能代理自动获取与深度解析arxiv学术文章"><strong>基于function calling构建智能代理：自动获取与深度解析arXiv学术文章</strong><a hidden class="anchor" aria-hidden="true" href="#基于function-calling构建智能代理自动获取与深度解析arxiv学术文章">#</a></h3>
<p>在这一节中将介绍如何构建一个能够从arXiv上查找论文， 下载分析并总结学术论文的Agent。这个Agent不仅可以帮助用户快速了解特定领域的最新研究动态，而且还能深入分析和总结选定文章的核心内容。</p>
<p><strong>Agent核心功能</strong></p>
<ul>
<li>获取arXiv文章 <code>get_articles</code></li>
</ul>
<p>代理通过**<code>arxiv</code>**库搜索关于特定主题的文章，为用户提供简要的文章摘要和链接。</p>
<ul>
<li>阅读并总结文章 <code>read_article_and_summarize</code></li>
</ul>
<p>利用**<code>PyPDF2</code>**库读取选中文章的PDF文件，代理能够提炼出文章的主要论点、支撑证据和结论。</p>
<p><strong>环境配置</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">scipy</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">tenacity</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">tiktoken</span><span class="o">==</span><span class="mf">0.3.3</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">termcolor</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">openai</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">arxiv</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">pandas</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">PyPDF2</span> <span class="o">--</span><span class="n">quiet</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">tqdm</span> <span class="o">--</span><span class="n">quiet</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">arxiv</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">ast</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">concurrent</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">os</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">tiktoken</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">csv</span> <span class="kn">import</span> <span class="n">writer</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span><span class="p">,</span> <span class="n">Markdown</span><span class="p">,</span> <span class="n">Latex</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">openai</span> <span class="kn">import</span> <span class="n">OpenAI</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">PyPDF2</span> <span class="kn">import</span> <span class="n">PdfReader</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">spatial</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tenacity</span> <span class="kn">import</span> <span class="n">retry</span><span class="p">,</span> <span class="n">wait_random_exponential</span><span class="p">,</span> <span class="n">stop_after_attempt</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
</span></span><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">termcolor</span> <span class="kn">import</span> <span class="n">colored</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">GPT_MODEL</span> <span class="o">=</span> <span class="s2">&#34;gpt-3.5-turbo-0613&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">EMBEDDING_MODEL</span> <span class="o">=</span> <span class="s2">&#34;text-embedding-ada-002&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">OpenAI</span><span class="p">()</span>
</span></span></code></pre></div><p>所有下载的论文都被存储在本地**<code>./data/papers</code><strong>目录中，并且每篇文章的详细信息（包括其嵌入向量）都记录在</strong><code>arxiv_library.csv</code>**文件中。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">directory</span> <span class="o">=</span> <span class="s1">&#39;./data/papers&#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Check if the directory already exists</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">directory</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># If the directory doesn&#39;t exist, create it and any necessary intermediate directories</span>
</span></span><span class="line"><span class="cl">    <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; created successfully.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># If the directory already exists, print a message indicating it</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Directory &#39;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&#39; already exists.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Set a directory to store downloaded papers</span>
</span></span><span class="line"><span class="cl"><span class="n">data_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">curdir</span><span class="p">,</span> <span class="s2">&#34;data&#34;</span><span class="p">,</span> <span class="s2">&#34;papers&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">paper_dir_filepath</span> <span class="o">=</span> <span class="s2">&#34;./data/arxiv_library.csv&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Generate a blank dataframe where we can store downloaded files</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="nb">list</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">paper_dir_filepath</span><span class="p">)</span>
</span></span></code></pre></div><p>我们将定义一些utils function用于：</p>
<ol>
<li>
<p><strong>文章获取与存储</strong>：通过**<code>get_articles</code>**函数查询主题相关的文章，系统自动下载文章并记录重要信息及embedding向量。</p>
</li>
<li>
<p><strong>文章选择与内容提取</strong>：根据用户的查询，系统通过计算embedding向量的相似度来选择最相关的文章，并提取出文章的文本内容。</p>
</li>
<li>
<p><strong>内容分块与总结</strong>：长文本被分割成多个较小的块，每个块被独立总结。</p>
</li>
<li>
<p><strong>汇总总结</strong>：所有独立块的总结被汇总成一篇全面的总结，更好地回应用户的查询。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@retry</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">embedding_request</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">embeddings</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="nb">input</span><span class="o">=</span><span class="n">text</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">EMBEDDING_MODEL</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nd">@retry</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_articles</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">library</span><span class="o">=</span><span class="n">paper_dir_filepath</span><span class="p">,</span> <span class="n">top_k</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;This function gets the top_k articles based on a user&#39;s query, sorted by relevance.
</span></span></span><span class="line"><span class="cl"><span class="s2">    It also downloads the files and stores them in arxiv_library.csv to be retrieved by the read_article_and_summarize.
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">client</span> <span class="o">=</span> <span class="n">arxiv</span><span class="o">.</span><span class="n">Client</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">search</span> <span class="o">=</span> <span class="n">arxiv</span><span class="o">.</span><span class="n">Search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">query</span> <span class="o">=</span> <span class="n">query</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_results</span> <span class="o">=</span> <span class="n">top_k</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">sort_by</span> <span class="o">=</span> <span class="n">arxiv</span><span class="o">.</span><span class="n">SortCriterion</span><span class="o">.</span><span class="n">SubmittedDate</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">result_list</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">client</span><span class="o">.</span><span class="n">results</span><span class="p">(</span><span class="n">search</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">result_dict</span> <span class="o">=</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">        <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&#34;title&#34;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">title</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&#34;summary&#34;</span><span class="p">:</span> <span class="n">result</span><span class="o">.</span><span class="n">summary</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Taking the first url provided</span>
</span></span><span class="line"><span class="cl">        <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&#34;article_url&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">href</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">links</span><span class="p">][</span><span class="mi">0</span><span class="p">]})</span>
</span></span><span class="line"><span class="cl">        <span class="n">result_dict</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&#34;pdf_url&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">href</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">result</span><span class="o">.</span><span class="n">links</span><span class="p">][</span><span class="mi">1</span><span class="p">]})</span>
</span></span><span class="line"><span class="cl">        <span class="n">result_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result_dict</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Store references in library file</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">embedding_request</span><span class="p">(</span><span class="n">text</span><span class="o">=</span><span class="n">result</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">file_reference</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">.</span><span class="n">title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">result</span><span class="o">.</span><span class="n">download_pdf</span><span class="p">(</span><span class="n">data_dir</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">embedding</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="c1"># Write to file</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">library</span><span class="p">,</span> <span class="s2">&#34;a&#34;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f_object</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">writer_object</span> <span class="o">=</span> <span class="n">writer</span><span class="p">(</span><span class="n">f_object</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">writer_object</span><span class="o">.</span><span class="n">writerow</span><span class="p">(</span><span class="n">file_reference</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">f_object</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">result_list</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">strings_ranked_by_relatedness</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">df</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">relatedness_fn</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">spatial</span><span class="o">.</span><span class="n">distance</span><span class="o">.</span><span class="n">cosine</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">top_n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Returns a list of strings and relatednesses, sorted from most related to least.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">query_embedding_response</span> <span class="o">=</span> <span class="n">embedding_request</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">query_embedding</span> <span class="o">=</span> <span class="n">query_embedding_response</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">embedding</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings_and_relatednesses</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&#34;filepath&#34;</span><span class="p">],</span> <span class="n">relatedness_fn</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">row</span><span class="p">[</span><span class="s2">&#34;embedding&#34;</span><span class="p">]))</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings_and_relatednesses</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings</span><span class="p">,</span> <span class="n">relatednesses</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">strings_and_relatednesses</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">strings</span><span class="p">[:</span><span class="n">top_n</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">read_pdf</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Takes a filepath to a PDF and returns a string of the PDF&#39;s contents&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># creating a pdf reader object</span>
</span></span><span class="line"><span class="cl">    <span class="n">reader</span> <span class="o">=</span> <span class="n">PdfReader</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdf_text</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">page_number</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">reader</span><span class="o">.</span><span class="n">pages</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">page_number</span> <span class="o">+=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="n">pdf_text</span> <span class="o">+=</span> <span class="n">page</span><span class="o">.</span><span class="n">extract_text</span><span class="p">()</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">Page Number: </span><span class="si">{</span><span class="n">page_number</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">pdf_text</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Split a text into smaller chunks of size n, preferably ending at the end of a sentence</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">create_chunks</span><span class="p">(</span><span class="n">text</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Returns successive n-sized chunks from provided text.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># Find the nearest end of sentence within a range of 0.5 * n and 1.5 * n tokens</span>
</span></span><span class="line"><span class="cl">        <span class="n">j</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1.5</span> <span class="o">*</span> <span class="n">n</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">while</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="c1"># Decode the tokens and check for full stop or newline</span>
</span></span><span class="line"><span class="cl">            <span class="n">chunk</span> <span class="o">=</span> <span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">chunk</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;.&#34;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">chunk</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="k">break</span>
</span></span><span class="line"><span class="cl">            <span class="n">j</span> <span class="o">-=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># If no end of sentence found, use n tokens as the chunk size</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="n">i</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">n</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">            <span class="n">j</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">n</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">        <span class="k">yield</span> <span class="n">tokens</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">j</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="n">i</span> <span class="o">=</span> <span class="n">j</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">extract_chunk</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">template_prompt</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;This function applies a prompt to some input content. In this case it returns a summarized chunk of text&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">prompt</span> <span class="o">=</span> <span class="n">template_prompt</span> <span class="o">+</span> <span class="n">content</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span><span class="o">=</span><span class="n">GPT_MODEL</span><span class="p">,</span> <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="n">prompt</span><span class="p">}],</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">summarize_text</span><span class="p">(</span><span class="n">query</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;This function does the following:
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Reads in the arxiv_library.csv file in including the embeddings
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Finds the closest file to the user&#39;s query
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Scrapes the text out of the file and chunks it
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Summarizes each chunk in parallel
</span></span></span><span class="line"><span class="cl"><span class="s2">    - Does one final summary and returns this to the user&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># A prompt to dictate how the recursive summarizations should approach the input paper</span>
</span></span><span class="line"><span class="cl">    <span class="n">summary_prompt</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;Summarize this text from an academic paper. Extract any key points with reasoning.</span><span class="se">\n\n</span><span class="s2">Content:&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># If the library is empty (no searches have been performed yet), we perform one and download the results</span>
</span></span><span class="line"><span class="cl">    <span class="n">library_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">paper_dir_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">library_df</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;No papers searched yet, downloading first.&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">get_articles</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Papers downloaded, continuing&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">library_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">paper_dir_filepath</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="n">library_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&#34;title&#34;</span><span class="p">,</span> <span class="s2">&#34;filepath&#34;</span><span class="p">,</span> <span class="s2">&#34;embedding&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="n">library_df</span><span class="p">[</span><span class="s2">&#34;embedding&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="n">library_df</span><span class="p">[</span><span class="s2">&#34;embedding&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">strings</span> <span class="o">=</span> <span class="n">strings_ranked_by_relatedness</span><span class="p">(</span><span class="n">query</span><span class="p">,</span> <span class="n">library_df</span><span class="p">,</span> <span class="n">top_n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Chunking text from paper&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">pdf_text</span> <span class="o">=</span> <span class="n">read_pdf</span><span class="p">(</span><span class="n">strings</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Initialise tokenizer</span>
</span></span><span class="line"><span class="cl">    <span class="n">tokenizer</span> <span class="o">=</span> <span class="n">tiktoken</span><span class="o">.</span><span class="n">get_encoding</span><span class="p">(</span><span class="s2">&#34;cl100k_base&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Chunk up the document into 1500 token chunks</span>
</span></span><span class="line"><span class="cl">    <span class="n">chunks</span> <span class="o">=</span> <span class="n">create_chunks</span><span class="p">(</span><span class="n">pdf_text</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="n">tokenizer</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">text_chunks</span> <span class="o">=</span> <span class="p">[</span><span class="n">tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Summarizing each chunk of text&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Parallel process the summaries</span>
</span></span><span class="line"><span class="cl">    <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_workers</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">text_chunks</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">extract_chunk</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">summary_prompt</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">text_chunks</span>
</span></span><span class="line"><span class="cl">        <span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="k">with</span> <span class="n">tqdm</span><span class="p">(</span><span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">text_chunks</span><span class="p">))</span> <span class="k">as</span> <span class="n">pbar</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">                <span class="n">pbar</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">futures</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">data</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span> <span class="o">+=</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># Final summary</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Summarizing into overall summary&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span><span class="o">=</span><span class="n">GPT_MODEL</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;Write a summary collated from this collection of key points extracted from an academic paper.
</span></span></span><span class="line"><span class="cl"><span class="s2">                        The summary should highlight the core argument, conclusions and evidence, and answer the user&#39;s query.
</span></span></span><span class="line"><span class="cl"><span class="s2">                        User query: </span><span class="si">{</span><span class="n">query</span><span class="si">}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">                        The summary should be structured in bulleted lists following the headings Core Argument, Evidence, and Conclusions.
</span></span></span><span class="line"><span class="cl"><span class="s2">                        Key points:</span><span class="se">\n</span><span class="si">{</span><span class="n">results</span><span class="si">}</span><span class="se">\n</span><span class="s2">Summary:</span><span class="se">\n</span><span class="s2">&#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">response</span>
</span></span></code></pre></div><p>实现一个**<code>Conversation</code>**类，用于支持与API进行多轮对话</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="nd">@retry</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="n">wait_random_exponential</span><span class="p">(</span><span class="nb">min</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">40</span><span class="p">),</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop_after_attempt</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">chat_completion_request</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="n">GPT_MODEL</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">functions</span><span class="o">=</span><span class="n">functions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Unable to generate ChatCompletion response&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Exception: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">e</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">class</span> <span class="nc">Conversation</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">add_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">content</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">message</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="n">role</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="n">content</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">def</span> <span class="nf">display_conversation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detailed</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">role_to_color</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;system&#34;</span><span class="p">:</span> <span class="s2">&#34;red&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;user&#34;</span><span class="p">:</span> <span class="s2">&#34;green&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;assistant&#34;</span><span class="p">:</span> <span class="s2">&#34;blue&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="s2">&#34;magenta&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">colored</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="sa">f</span><span class="s2">&#34;</span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">message</span><span class="p">[</span><span class="s1">&#39;content&#39;</span><span class="p">]</span><span class="si">}</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">role_to_color</span><span class="p">[</span><span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">]],</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span></code></pre></div><p>完成以上基本工作， 接下来是agent的核心内容</p>
<p>定义工具列表 tools</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">arxiv_functions</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;get_articles&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;&#34;Use this function to get academic papers from arXiv to answer user questions.&#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                            User query in JSON. Responses should be summarized and should include the article URL reference
</span></span></span><span class="line"><span class="cl"><span class="s2">                            &#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;query&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;read_article_and_summarize&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;&#34;&#34;Use this function to read whole papers and provide a summary for users.
</span></span></span><span class="line"><span class="cl"><span class="s2">        You should NEVER call this function before get_articles has been called in the conversation.&#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">                            Description of the article in plain text based on the user&#39;s query
</span></span></span><span class="line"><span class="cl"><span class="s2">                            &#34;&#34;&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;query&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>定义function用于工具调用</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">chat_completion_with_function_execution</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">]):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;This function makes a ChatCompletion API call with the option of adding functions&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">functions</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">full_message</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">full_message</span><span class="o">.</span><span class="n">finish_reason</span> <span class="o">==</span> <span class="s2">&#34;function_call&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Function generation requested, calling function&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">call_arxiv_function</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">full_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Function not required, responding to user&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">call_arxiv_function</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">full_message</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Function calling function which executes function calls when the model believes it is necessary.
</span></span></span><span class="line"><span class="cl"><span class="s2">    Currently extended by adding clauses to this if statement.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">full_message</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;get_articles&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">parsed_output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">full_message</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">function_call</span><span class="o">.</span><span class="n">arguments</span>
</span></span><span class="line"><span class="cl">            <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Getting search results&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">results</span> <span class="o">=</span> <span class="n">get_articles</span><span class="p">(</span><span class="n">parsed_output</span><span class="p">[</span><span class="s2">&#34;query&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="n">parsed_output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Function execution failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Error message: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="n">full_message</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">results</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">try</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Got search results, summarizing content&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="n">response</span> <span class="o">=</span> <span class="n">chat_completion_request</span><span class="p">(</span><span class="n">messages</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">response</span>
</span></span><span class="line"><span class="cl">        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="nb">print</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;Function chat request failed&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">elif</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">full_message</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">function_call</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&#34;read_article_and_summarize&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="n">parsed_output</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">full_message</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">function_call</span><span class="o">.</span><span class="n">arguments</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Finding and reading paper&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">summary</span> <span class="o">=</span> <span class="n">summarize_text</span><span class="p">(</span><span class="n">parsed_output</span><span class="p">[</span><span class="s2">&#34;query&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">summary</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&#34;Function does not exist and cannot be called&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>arXiv conversation, Start with a system message</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">paper_system_message</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;You are arXivGPT, a helpful assistant pulls academic papers to answer user questions.
</span></span></span><span class="line"><span class="cl"><span class="s2">You summarize the papers clearly so the customer can decide which to read to answer their question.
</span></span></span><span class="line"><span class="cl"><span class="s2">You always provide the article_url and title so the user can understand the name of the paper and click through to access it.
</span></span></span><span class="line"><span class="cl"><span class="s2">Begin!&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">paper_conversation</span> <span class="o">=</span> <span class="n">Conversation</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">paper_conversation</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&#34;system&#34;</span><span class="p">,</span> <span class="n">paper_system_message</span><span class="p">)</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Add a user message</span>
</span></span><span class="line"><span class="cl"><span class="n">paper_conversation</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;Hi, how does PPO reinforcement learning work?&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">chat_response</span> <span class="o">=</span> <span class="n">chat_completion_with_function_execution</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">paper_conversation</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="n">arxiv_functions</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">chat_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span>
</span></span><span class="line"><span class="cl"><span class="n">paper_conversation</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span><span class="s2">&#34;assistant&#34;</span><span class="p">,</span> <span class="n">assistant_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">))</span>
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">Function generation requested, calling function
</span></span><span class="line"><span class="cl">Getting search results
</span></span><span class="line"><span class="cl">Got search results, summarizing content
</span></span><span class="line"><span class="cl">I found several papers related to PPO reinforcement learning. Here are a few summaries:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Title: &#34;Bandit Profit-maximization for Targeted Marketing&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Summary: This paper presents near-optimal algorithms for optimizing profit over multiple demand curves, which are dependent on different ancillary variables while maintaining the same price. It is relevant to PPO reinforcement learning as it tackles a sequential profit-maximization problem.
</span></span><span class="line"><span class="cl">Article URL: Link
</span></span><span class="line"><span class="cl">Title: &#34;Inferring potential landscapes: A Schrödinger bridge approach to Maximum Caliber&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Summary: This work extends Schrödinger bridges to account for integral constraints along paths, specifically in the context of Maximum Caliber, a Maximum Entropy principle applied in a dynamic context. While not directly related to PPO reinforcement learning, it can provide insights into stochastic dynamics and inference of time-varying potential landscapes.
</span></span><span class="line"><span class="cl">Article URL: Link
</span></span><span class="line"><span class="cl">Title: &#34;a-DCF: an architecture agnostic metric with application to spoofing-robust speaker verification&#34;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Summary: This paper proposes an architecture-agnostic detection cost function (a-DCF) for evaluating spoofing-robust automatic speaker verification (ASV) systems. Although it does not focus on PPO reinforcement learning, it provides a metric for evaluating ASV systems in the presence of spoofing attacks.
</span></span><span class="line"><span class="cl">Article URL: Link
</span></span><span class="line"><span class="cl">These papers should provide insights into different aspects of reinforcement learning and related topics.
</span></span></code></pre></div><p>Add another user message to induce our system to use the second tool</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">paper_conversation</span><span class="o">.</span><span class="n">add_message</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;Can you read the PPO sequence generation paper for me and give me a summary&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">updated_response</span> <span class="o">=</span> <span class="n">chat_completion_with_function_execution</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">paper_conversation</span><span class="o">.</span><span class="n">conversation_history</span><span class="p">,</span> <span class="n">functions</span><span class="o">=</span><span class="n">arxiv_functions</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">display</span><span class="p">(</span><span class="n">Markdown</span><span class="p">(</span><span class="n">updated_response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
</span></span></code></pre></div><p>output:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-markdown" data-lang="markdown"><span class="line"><span class="cl">Function generation requested, calling function
</span></span><span class="line"><span class="cl">Finding and reading paper
</span></span><span class="line"><span class="cl">Chunking text from paper
</span></span><span class="line"><span class="cl">Summarizing each chunk of text
</span></span><span class="line"><span class="cl">100%|██████████| 4/4 [00:04<span class="p">&lt;</span><span class="nt">00:00</span><span class="err">,</span>  <span class="na">1</span><span class="err">.</span><span class="na">11s</span><span class="err">/</span><span class="na">it</span><span class="err">]</span>
</span></span><span class="line"><span class="cl"><span class="na">Summarizing</span> <span class="na">into</span> <span class="na">overall</span> <span class="na">summary</span>
</span></span><span class="line"><span class="cl"><span class="na">Core</span> <span class="na">Argument:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">paper</span> <span class="na">discusses</span> <span class="na">the</span> <span class="na">potential</span> <span class="na">of</span> <span class="na">using</span> <span class="na">a</span> <span class="na">general-purpose</span> <span class="na">large</span> <span class="na">language</span> <span class="na">model</span> <span class="err">(</span><span class="na">LLM</span><span class="err">)</span> <span class="na">to</span> <span class="na">learn</span> <span class="na">the</span> <span class="na">structural</span> <span class="na">biophysics</span> <span class="na">of</span> <span class="na">DNA</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">authors</span> <span class="na">show</span> <span class="na">that</span> <span class="na">fine-tuning</span> <span class="na">a</span> <span class="na">LLM</span><span class="err">,</span> <span class="na">specifically</span> <span class="na">chatGPT</span> <span class="na">3</span><span class="err">.</span><span class="na">5-turbo</span><span class="err">,</span> <span class="na">can</span> <span class="na">enhance</span> <span class="na">its</span> <span class="na">ability</span> <span class="na">to</span> <span class="na">analyze</span> <span class="na">and</span> <span class="na">design</span> <span class="na">DNA</span> <span class="na">sequences</span> <span class="na">and</span> <span class="na">their</span> <span class="na">structures</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">study</span> <span class="na">focuses</span> <span class="na">on</span> <span class="na">the</span> <span class="na">formation</span> <span class="na">of</span> <span class="na">secondary</span> <span class="na">structures</span> <span class="na">in</span> <span class="na">DNA</span><span class="err">,</span> <span class="na">which</span> <span class="na">are</span> <span class="na">governed</span> <span class="na">by</span> <span class="na">base</span> <span class="na">pairing</span> <span class="na">and</span> <span class="na">stacking</span> <span class="na">bonds</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">authors</span> <span class="na">propose</span> <span class="na">a</span> <span class="na">method</span> <span class="na">that</span> <span class="na">involves</span> <span class="na">chaining</span> <span class="na">together</span> <span class="na">models</span> <span class="na">fine-tuned</span> <span class="na">for</span> <span class="na">subtasks</span> <span class="na">and</span> <span class="na">using</span> <span class="na">a</span> <span class="na">chain-of-thought</span> <span class="na">approach</span> <span class="na">to</span> <span class="na">improve</span> <span class="na">the</span> <span class="na">model</span><span class="err">&#39;</span><span class="na">s</span> <span class="na">performance</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">Evidence:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">authors</span> <span class="na">use</span> <span class="na">the</span> <span class="na">NUPACK</span> <span class="na">software</span> <span class="na">suite</span> <span class="na">to</span> <span class="na">provide</span> <span class="na">data</span> <span class="na">for</span> <span class="na">training</span> <span class="na">and</span> <span class="na">validation</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">expert</span> <span class="na">pipeline</span> <span class="na">approach</span> <span class="na">involves</span> <span class="na">using</span> <span class="na">models</span> <span class="na">that</span> <span class="na">have</span> <span class="na">been</span> <span class="na">fine-tuned</span> <span class="na">for</span> <span class="na">subtasks</span> <span class="na">and</span> <span class="na">feeding</span> <span class="na">their</span> <span class="na">outputs</span> <span class="na">into</span> <span class="na">each</span> <span class="na">other</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">models</span> <span class="na">perform</span> <span class="na">better</span> <span class="na">when</span> <span class="na">they</span> <span class="na">explicitly</span> <span class="na">consider</span> <span class="na">the</span> <span class="na">nearest</span> <span class="na">neighbor</span> <span class="na">window</span> <span class="na">and</span> <span class="na">the</span> <span class="na">reverse</span> <span class="na">complement</span> <span class="na">of</span> <span class="na">the</span> <span class="na">sequences</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">pipeline</span> <span class="na">approach</span><span class="err">,</span> <span class="na">where</span> <span class="na">a</span> <span class="na">separate</span> <span class="na">model</span> <span class="na">determines</span> <span class="na">the</span> <span class="na">reverse</span> <span class="na">complement</span> <span class="na">and</span> <span class="na">feeds</span> <span class="na">it</span> <span class="na">to</span> <span class="na">another</span> <span class="na">model</span> <span class="na">for</span> <span class="na">secondary</span> <span class="na">structure</span> <span class="na">prediction</span><span class="err">,</span> <span class="na">enhances</span> <span class="na">the</span> <span class="na">accuracy</span> <span class="na">of</span> <span class="na">the</span> <span class="na">predictions</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">performance</span> <span class="na">of</span> <span class="na">the</span> <span class="na">models</span> <span class="na">improves</span> <span class="na">with</span> <span class="na">larger</span> <span class="na">training</span> <span class="na">sets</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">Conclusions:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">study</span> <span class="na">demonstrates</span> <span class="na">the</span> <span class="na">potential</span> <span class="na">of</span> <span class="na">using</span> <span class="na">LLMs</span> <span class="na">to</span> <span class="na">learn</span> <span class="na">DNA</span> <span class="na">structural</span> <span class="na">biophysics</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">Integrating</span> <span class="na">experimental</span> <span class="na">data</span> <span class="na">and</span> <span class="na">machine</span> <span class="na">learning</span> <span class="na">is</span> <span class="na">important</span> <span class="na">in</span> <span class="na">scientific</span> <span class="na">research</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">expert</span> <span class="na">pipeline</span> <span class="na">approach</span> <span class="na">and</span> <span class="na">breaking</span> <span class="na">down</span> <span class="na">the</span> <span class="na">problem</span> <span class="na">into</span> <span class="na">smaller</span> <span class="na">subtasks</span> <span class="na">improve</span> <span class="na">the</span> <span class="na">performance</span> <span class="na">of</span> <span class="na">the</span> <span class="na">models</span> <span class="na">in</span> <span class="na">DNA</span> <span class="na">sequence</span> <span class="na">analysis</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">combination</span> <span class="na">of</span> <span class="na">chain-of-thought</span> <span class="na">and</span> <span class="na">model</span> <span class="na">pipeline</span> <span class="na">provides</span> <span class="na">the</span> <span class="na">best</span> <span class="na">results</span> <span class="na">in</span> <span class="na">analysis</span> <span class="na">tasks</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">CoT</span> <span class="na">approach</span><span class="err">,</span> <span class="na">combined</span> <span class="na">with</span> <span class="na">the</span> <span class="na">reverse</span> <span class="na">complement</span> <span class="na">transformation</span><span class="err">,</span> <span class="na">yields</span> <span class="na">the</span> <span class="na">highest</span> <span class="na">accuracy</span> <span class="na">in</span> <span class="na">design</span> <span class="na">tasks</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">The</span> <span class="na">addition</span> <span class="na">of</span> <span class="na">an</span> <span class="na">error</span> <span class="na">checking</span> <span class="na">layer</span> <span class="na">further</span> <span class="na">improves</span> <span class="na">accuracy</span> <span class="na">in</span> <span class="na">design</span> <span class="na">tasks</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">Sequence</span> <span class="na">design</span> <span class="na">is</span> <span class="na">more</span> <span class="na">challenging</span> <span class="na">than</span> <span class="na">analysis</span><span class="err">,</span> <span class="na">but</span> <span class="na">error</span> <span class="na">correction</span> <span class="na">can</span> <span class="na">compensate</span> <span class="na">for</span> <span class="na">the</span> <span class="na">increased</span> <span class="na">difficulty</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">Larger</span> <span class="na">training</span> <span class="na">sets</span> <span class="na">benefit</span> <span class="na">design</span> <span class="na">tasks</span> <span class="na">more</span><span class="err">.</span>
</span></span><span class="line"><span class="cl"><span class="na">Future</span> <span class="na">research</span> <span class="na">directions</span> <span class="na">include</span> <span class="na">exploring</span> <span class="na">chaining</span> <span class="na">smaller</span> <span class="na">models</span> <span class="na">for</span> <span class="na">performance</span> <span class="na">improvement</span> <span class="na">and</span> <span class="na">using</span> <span class="na">an</span> <span class="na">LLM</span> <span class="na">architecture</span> <span class="na">involving</span> <span class="na">both</span> <span class="na">an</span> <span class="na">encoder</span> <span class="na">and</span> <span class="na">decoder</span> <span class="na">for</span> <span class="na">direct</span> <span class="na">sequence</span> <span class="na">comparison</span><span class="err">.</span>
</span></span></code></pre></div><h2 id="function-calling-via-open-source-llms">Function calling via open source LLMs<a hidden class="anchor" aria-hidden="true" href="#function-calling-via-open-source-llms">#</a></h2>
<p>在考虑成本和隐私性的背景下，我们可能会倾向于在开源的大型语言模型（LLM）上实现函数调用功能。目前，有几个框架支持以类似OpenAI API的形式调用工具（tools call）：</p>
<ul>
<li>
<p>Xinference</p>
</li>
<li>
<p>Text Generation Inference (TGI)</p>
</li>
</ul>
<p>而在开源大型语言模型（LLM）方面，支持工具调用的主要有：</p>
<ul>
<li>
<p>Llama-3</p>
</li>
<li>
<p>Mixtral-8x7B-Instruct-v0.1</p>
</li>
<li>
<p>qwent</p>
</li>
<li>
<p>chatGLM-6B</p>
</li>
<li>
<p>NexusRaven-13B</p>
</li>
<li>
<p>gorilla-openfunctions-v1</p>
</li>
<li>
<p>等等</p>
</li>
</ul>
<p>以下以Xinference和chatGLM-6B为例，探索如何通过OpenAI API的形式调用开源模型的函数调用功能。</p>
<p>环境</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="o">-</span><span class="n">q</span>  <span class="n">xinference</span><span class="p">[</span><span class="n">transformers</span><span class="p">]</span> <span class="n">openai</span> <span class="n">langchain</span>
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">typing</span><span class="o">-</span><span class="n">extensions</span> <span class="o">--</span><span class="n">upgrade</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">## Start Local Server</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">!</span><span class="n">nohup</span> <span class="n">xinference</span><span class="o">-</span><span class="n">local</span>  <span class="o">&gt;</span> <span class="n">xinference</span><span class="o">.</span><span class="n">log</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="o">&amp;</span>
</span></span></code></pre></div><p>模型加载</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="err">!</span><span class="n">xinference</span> <span class="n">launch</span> <span class="o">-</span><span class="n">u</span> <span class="n">my</span><span class="o">-</span><span class="n">llm</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="n">name</span> <span class="n">chatglm3</span> <span class="o">--</span><span class="n">size</span><span class="o">-</span><span class="ow">in</span><span class="o">-</span><span class="n">billions</span> <span class="mi">6</span> <span class="o">--</span><span class="n">model</span><span class="o">-</span><span class="nb">format</span> <span class="n">pytorch</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1">## Interact with the running model</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">openai</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;Who are you?&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">openai</span><span class="o">.</span><span class="n">Client</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="s2">&#34;empty&#34;</span><span class="p">,</span> <span class="n">base_url</span><span class="o">=</span><span class="sa">f</span><span class="s2">&#34;http://0.0.0.0:9997/v1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;my-llm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># ChatCompletion(id=&#39;chatda6056ac-da01-11ee-b92e-0242ac1c000c&#39;, choices=[Choice(finish_reason=&#39;stop&#39;, index=0, logprobs=None, message=ChatCompletionMessage(content=&#34;I am an AI assistant named ChatGLM3-6B, which is developed based on the language model jointly trained by Tsinghua University KEG Lab and Zhipu AI Company in 2023. My job is to provide appropriate answers and support to users&#39; questions and requests.&#34;, role=&#39;assistant&#39;, function_call=None, tool_calls=None))], created=1709541198, model=&#39;my-llm&#39;, object=&#39;chat.completion&#39;, system_fingerprint=None, usage=CompletionUsage(completion_tokens=-1, prompt_tokens=-1, total_tokens=-1))</span>
</span></span></code></pre></div><p>without tool using</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">completion</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">model</span><span class="o">=</span><span class="s2">&#34;my-llm&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">messages</span><span class="o">=</span><span class="p">[{</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;What is the weather like in London?&#34;</span><span class="p">}]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># print(handle_response(completion))</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">completion</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">London has a temperate climate with warm summers and cool winters. The average temperature during the summer months (June to August) is around 18°C, while the winter months (December to February) are around 6°C. The city experiences heavy rainfall throughout the year, with an annual precipitation of around 350 mm. The average precipitation on the weekends is around 40 mm. London&#39;s cloudy skies are common throughout the year, but they are especially prevalent in December and January.
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>tool using</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;function&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;get_current_weather&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Get the current weather in a given location&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The city and state, e.g. San Francisco, CA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="p">},</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;unit&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;enum&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;celsius&#34;</span><span class="p">,</span> <span class="s2">&#34;fahrenheit&#34;</span><span class="p">]},</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;location&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_completion</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="s2">&#34;my-llm&#34;</span><span class="p">,</span> <span class="n">temperature</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_tokens</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">chat</span><span class="o">.</span><span class="n">completions</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">model</span><span class="o">=</span><span class="n">model</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">messages</span><span class="o">=</span><span class="n">messages</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">temperature</span><span class="o">=</span><span class="n">temperature</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">max_tokens</span><span class="o">=</span><span class="n">max_tokens</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">tool_choice</span><span class="o">=</span><span class="n">tool_choice</span>
</span></span><span class="line"><span class="cl">    <span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">choices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">message</span>
</span></span></code></pre></div><div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Defines a dummy function to get the current weather</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">get_current_weather</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&#34;fahrenheit&#34;</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;Get the current weather in a given location&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">weather</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="n">location</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="s2">&#34;50&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;unit&#34;</span><span class="p">:</span> <span class="n">unit</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">weather</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">messages</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span> <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;What&#39;s the weather like in Boston!&#34;</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">get_completion</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span> <span class="n">tool_choice</span><span class="o">=</span><span class="s2">&#34;auto&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">assistant_message</span><span class="o">.</span><span class="n">model_dump_json</span><span class="p">())</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;content&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;tool_calls&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;function&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#a temporary patch but this should be handled differently</span>
</span></span><span class="line"><span class="cl"><span class="c1"># remove &#34;function_call&#34; from assistant message</span>
</span></span><span class="line"><span class="cl"><span class="k">del</span> <span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;function_call&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">assistant_message</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># get the weather information to pass back to the model</span>
</span></span><span class="line"><span class="cl"><span class="n">weather</span> <span class="o">=</span> <span class="n">get_current_weather</span><span class="p">(</span><span class="n">messages</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="s2">&#34;tool_calls&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;function&#34;</span><span class="p">][</span><span class="s2">&#34;arguments&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">messages</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;tool&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                 <span class="s2">&#34;tool_call_id&#34;</span><span class="p">:</span> <span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;tool_calls&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;id&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                 <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="n">assistant_message</span><span class="p">[</span><span class="s2">&#34;tool_calls&#34;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;function&#34;</span><span class="p">][</span><span class="s2">&#34;name&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                 <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="n">weather</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">final_response</span> <span class="o">=</span> <span class="n">get_completion</span><span class="p">(</span><span class="n">messages</span><span class="p">,</span> <span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">final_response</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">ChatCompletionMessage(content=&#39;The current weather in Boston is 50 degrees Fahrenheit.&#39;, role=&#39;assistant&#39;, function_call=None, tool_calls=[])
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h2 id="llm-在执行function-calling时经历了什么">LLM 在执行function calling时经历了什么<a hidden class="anchor" aria-hidden="true" href="#llm-在执行function-calling时经历了什么">#</a></h2>
<p>可惜我们并不能看到openAI的模型在服务器端发生了什么，但是根据开源的模型和推理框架，我们某种程度上，也能对LLM在执行function calling的背后逻辑一探究竟。</p>
<p>这部分内容可以从推理框架和开源模型的源码中找到答案。</p>
<p>根据xinference 的源码：<a href="https://github.com/xorbitsai/inference/blob/main/xinference/model/llm/utils.py#L42">https://github.com/xorbitsai/inference/blob/main/xinference/model/llm/utils.py#L42</a></p>
<p>我们主要关注ChatGLM3 和Qwen</p>
<p>当我们使用以下假设对话时：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">messages</span><span class="o">=</span><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;今天北京的天气怎么样？&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;get_current_weather&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Get the current weather in a given location&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The city and state, e.g. San Francisco, CA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;unit&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;location&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>根据<a href="https://github.com/THUDM/ChatGLM3/blob/main/PROMPT.md">GLM的官方文档</a>，则最终给到ChatGLM3模型的prompt应该长这样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="o">&lt;|</span><span class="n">system</span><span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">Answer</span> <span class="n">the</span> <span class="n">following</span> <span class="n">questions</span> <span class="k">as</span> <span class="n">best</span> <span class="k">as</span> <span class="n">you</span> <span class="n">can</span><span class="o">.</span> <span class="n">You</span> <span class="n">have</span> <span class="n">access</span> <span class="n">to</span> <span class="n">the</span> <span class="n">following</span> <span class="n">tools</span><span class="p">:</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;get_current_weather&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Get the current weather in a given location&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;object&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;location&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The city and state, e.g. San Francisco, CA&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">},</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;unit&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;location&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;|</span><span class="n">user</span><span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">今天北京的天气怎么样</span><span class="err">？</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;|</span><span class="n">assistant</span><span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">好的</span><span class="err">，</span><span class="n">让我们来查看今天的天气</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;|</span><span class="n">assistant</span><span class="o">|&gt;</span><span class="n">get_current_weather</span>
</span></span><span class="line"><span class="cl"><span class="err">```</span><span class="n">python</span>
</span></span><span class="line"><span class="cl"><span class="n">tool_call</span><span class="p">(</span><span class="n">location</span><span class="o">=</span><span class="s2">&#34;beijing&#34;</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&#34;celsius&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="err">```</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;|</span><span class="n">observation</span><span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="s2">&#34;temperature&#34;</span><span class="p">:</span> <span class="mi">22</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="o">&lt;|</span><span class="n">assistant</span><span class="o">|&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">根据查询结果</span><span class="err">，</span><span class="n">今天北京的气温为</span> <span class="mi">22</span> <span class="n">摄氏度</span><span class="err">。</span>
</span></span></code></pre></div><p>根据xinference 中<a href="https://github.com/xorbitsai/inference/blob/main/xinference/model/llm/utils.py#L42">有关qwen的代码</a></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="k">elif</span> <span class="n">prompt_style</span><span class="o">.</span><span class="n">style_name</span> <span class="o">==</span> <span class="s2">&#34;QWEN&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">tool_desc</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;</span><span class="si">{name_for_model}</span><span class="s2">: Call this tool to interact with the </span><span class="si">{name_for_human}</span><span class="s2"> API. What is the </span><span class="si">{name_for_human}</span><span class="s2"> API useful for? </span><span class="si">{description_for_model}</span><span class="s2"> Parameters: </span><span class="si">{parameters}</span><span class="s2"> Format the arguments as a JSON object.&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">react_instruction</span> <span class="o">=</span> <span class="s2">&#34;&#34;&#34;Answer the following questions as best you can. You have access to the following APIs:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2"></span><span class="si">{tools_text}</span><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Use the following format:
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Question: the input question you must answer
</span></span></span><span class="line"><span class="cl"><span class="s2">Thought: you should always think about what to do
</span></span></span><span class="line"><span class="cl"><span class="s2">Action: the action to take, should be one of [</span><span class="si">{tools_name_text}</span><span class="s2">]
</span></span></span><span class="line"><span class="cl"><span class="s2">Action Input: the input to the action
</span></span></span><span class="line"><span class="cl"><span class="s2">Observation: the result of the action
</span></span></span><span class="line"><span class="cl"><span class="s2">... (this Thought/Action/Action Input/Observation can be repeated zero or more times)
</span></span></span><span class="line"><span class="cl"><span class="s2">Thought: I now know the final answer
</span></span></span><span class="line"><span class="cl"><span class="s2">Final Answer: the final answer to the original input question
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">Begin!&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="n">tools_text</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                <span class="n">tools_name_text</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                <span class="k">for</span> <span class="n">func_info</span> <span class="ow">in</span> <span class="n">tools</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">required_parameters</span> <span class="o">=</span> <span class="n">func_info</span><span class="p">[</span><span class="s2">&#34;function&#34;</span><span class="p">][</span><span class="s2">&#34;parameters&#34;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;required&#34;</span><span class="p">,</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">func_info</span><span class="p">[</span><span class="s2">&#34;function&#34;</span><span class="p">][</span><span class="s2">&#34;parameters&#34;</span><span class="p">][</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;properties&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span></span><span class="line"><span class="cl">                        <span class="n">param</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">({</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="n">name</span><span class="p">},</span> <span class="o">**</span><span class="n">p</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">required_parameters</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">param</span><span class="p">[</span><span class="s2">&#34;required&#34;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span></span><span class="line"><span class="cl">                        <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                    <span class="n">name</span> <span class="o">=</span> <span class="n">func_info</span><span class="p">[</span><span class="s2">&#34;function&#34;</span><span class="p">][</span><span class="s2">&#34;name&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">desc</span> <span class="o">=</span> <span class="n">func_info</span><span class="p">[</span><span class="s2">&#34;function&#34;</span><span class="p">][</span><span class="s2">&#34;description&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tool_string</span> <span class="o">=</span> <span class="n">tool_desc</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                        <span class="n">name_for_model</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">name_for_human</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="c1"># Hint: You can add the following format requirements in description:</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">#   &#34;Format the arguments as a JSON object.&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="c1">#   &#34;Enclose the code within triple backticks (`) at the beginning and end of the code.&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">description_for_model</span><span class="o">=</span><span class="n">desc</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="n">parameters</span><span class="o">=</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">                    <span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tools_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tool_string</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tools_name_text</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">tools_text_string</span> <span class="o">=</span> <span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">&#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tools_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">tools_name_text_string</span> <span class="o">=</span> <span class="s2">&#34;, &#34;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tools_name_text</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="n">tool_system</span> <span class="o">=</span> <span class="n">react_instruction</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tools_text</span><span class="o">=</span><span class="n">tools_text_string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                    <span class="n">tools_name_text</span><span class="o">=</span><span class="n">tools_name_text_string</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">tool_system</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">            <span class="n">ret</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;&lt;|im_start|&gt;system</span><span class="se">\n</span><span class="si">{</span><span class="n">prompt_style</span><span class="o">.</span><span class="n">system_prompt</span><span class="si">}</span><span class="s2">&lt;|im_end|&gt;&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">for</span> <span class="n">message</span> <span class="ow">in</span> <span class="n">chat_history</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                <span class="n">role</span> <span class="o">=</span> <span class="n">get_role</span><span class="p">(</span><span class="n">message</span><span class="p">[</span><span class="s2">&#34;role&#34;</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">                <span class="n">content</span> <span class="o">=</span> <span class="n">message</span><span class="p">[</span><span class="s2">&#34;content&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">                <span class="n">ret</span> <span class="o">+=</span> <span class="n">prompt_style</span><span class="o">.</span><span class="n">intra_message_sep</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">tools</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="k">if</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&#34;user&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">tool_system</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">content</span> <span class="o">=</span> <span class="n">tool_system</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&#34;</span><span class="se">\n\n</span><span class="s2">Question: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                            <span class="n">tool_system</span> <span class="o">=</span> <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;Question: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&#34;assistant&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">tool_calls</span> <span class="o">=</span> <span class="n">message</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;tool_calls&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                        <span class="k">if</span> <span class="n">tool_calls</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">func_call</span> <span class="o">=</span> <span class="n">tool_calls</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&#34;function&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">                            <span class="n">f_name</span><span class="p">,</span> <span class="n">f_args</span> <span class="o">=</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">                                <span class="n">func_call</span><span class="p">[</span><span class="s2">&#34;name&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                <span class="n">func_call</span><span class="p">[</span><span class="s2">&#34;arguments&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                            <span class="p">)</span>
</span></span><span class="line"><span class="cl">                            <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;Thought: I can use </span><span class="si">{</span><span class="n">f_name</span><span class="si">}</span><span class="s2">.</span><span class="se">\n</span><span class="s2">Action: </span><span class="si">{</span><span class="n">f_name</span><span class="si">}</span><span class="se">\n</span><span class="s2">Action Input: </span><span class="si">{</span><span class="n">f_args</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="k">elif</span> <span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                            <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;Thought: I now know the final answer.</span><span class="se">\n</span><span class="s2">Final answer: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">elif</span> <span class="n">role</span> <span class="o">==</span> <span class="s2">&#34;tool&#34;</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="n">role</span> <span class="o">=</span> <span class="s2">&#34;function&#34;</span>
</span></span><span class="line"><span class="cl">                        <span class="n">content</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;Observation: </span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Unsupported message role: </span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                <span class="k">if</span> <span class="n">content</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">content</span> <span class="o">=</span> <span class="n">content</span><span class="o">.</span><span class="n">lstrip</span><span class="p">(</span><span class="s2">&#34;</span><span class="se">\n</span><span class="s2">&#34;</span><span class="p">)</span><span class="o">.</span><span class="n">rstrip</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&#34;&lt;|im_start|&gt;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="se">\n</span><span class="si">{</span><span class="n">content</span><span class="si">}</span><span class="s2">&lt;|im_end|&gt;&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">                    <span class="n">ret</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&#34;&lt;|im_start|&gt;</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="se">\n</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">ret</span>
</span></span></code></pre></div><p>会稍微复杂一些， 利用了react的COT方式（代码中的<strong>react_instruction</strong>），要求模型以一系列的**<code>Thought</code><strong>（思考）、</strong><code>Action</code><strong>（行动）、</strong><code>Action Input</code><strong>（行动输入）和</strong><code>Observation</code>**（观察结果）步骤，最终给出问题的答案，以增加正确性。</p>
<p>假设使用以下工具列表和对话历史：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 工具列表</span>
</span></span><span class="line"><span class="cl"><span class="n">tools</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;geo_lookup&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;Retrieves geographical information.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;parameters&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;query&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;properties&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;query&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                        <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The query to lookup.&#34;</span>
</span></span><span class="line"><span class="cl">                    <span class="p">}</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">chat_history</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;user&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;What is the population of Tokyo?&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;role&#34;</span><span class="p">:</span> <span class="s2">&#34;assistant&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;tool_calls&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">            <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;function&#34;</span><span class="p">:</span> <span class="s2">&#34;geo_lookup&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;arguments&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                    <span class="s2">&#34;query&#34;</span><span class="p">:</span> <span class="s2">&#34;Tokyo&#34;</span>
</span></span><span class="line"><span class="cl">                <span class="p">}</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;content&#34;</span><span class="p">:</span> <span class="s2">&#34;The population of Tokyo is about 14 million.&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span></code></pre></div><p>可以推断出，最终输入Qwen的prompt应该长这样：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">system</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Answer</span> <span class="n">the</span> <span class="n">following</span> <span class="n">questions</span> <span class="k">as</span> <span class="n">best</span> <span class="n">you</span> <span class="n">can</span><span class="o">.</span> <span class="n">You</span> <span class="n">have</span> <span class="n">access</span> <span class="n">to</span> <span class="n">the</span> <span class="n">following</span> <span class="n">APIs</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">geo_lookup</span><span class="p">:</span> <span class="n">Call</span> <span class="n">this</span> <span class="n">tool</span> <span class="n">to</span> <span class="n">interact</span> <span class="k">with</span> <span class="n">the</span> <span class="n">geo_lookup</span> <span class="n">API</span><span class="o">.</span> <span class="n">What</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">geo_lookup</span> <span class="n">API</span> <span class="n">useful</span> <span class="k">for</span><span class="err">?</span> <span class="n">Retrieves</span> <span class="n">geographical</span> <span class="n">information</span><span class="o">.</span> <span class="n">Parameters</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;query&#34;</span><span class="p">,</span> <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;string&#34;</span><span class="p">,</span> <span class="s2">&#34;description&#34;</span><span class="p">:</span> <span class="s2">&#34;The query to lookup.&#34;</span><span class="p">,</span> <span class="s2">&#34;required&#34;</span><span class="p">:</span> <span class="n">true</span><span class="p">}]</span> <span class="n">Format</span> <span class="n">the</span> <span class="n">arguments</span> <span class="k">as</span> <span class="n">a</span> <span class="n">JSON</span> <span class="nb">object</span><span class="o">.</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Use</span> <span class="n">the</span> <span class="n">following</span> <span class="nb">format</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Question</span><span class="p">:</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">question</span> <span class="n">you</span> <span class="n">must</span> <span class="n">answer</span>
</span></span><span class="line"><span class="cl"><span class="n">Thought</span><span class="p">:</span> <span class="n">you</span> <span class="n">should</span> <span class="n">always</span> <span class="n">think</span> <span class="n">about</span> <span class="n">what</span> <span class="n">to</span> <span class="n">do</span>
</span></span><span class="line"><span class="cl"><span class="n">Action</span><span class="p">:</span> <span class="n">the</span> <span class="n">action</span> <span class="n">to</span> <span class="n">take</span><span class="p">,</span> <span class="n">should</span> <span class="n">be</span> <span class="n">one</span> <span class="n">of</span> <span class="p">[</span><span class="n">geo_lookup</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">Action</span> <span class="n">Input</span><span class="p">:</span> <span class="n">the</span> <span class="nb">input</span> <span class="n">to</span> <span class="n">the</span> <span class="n">action</span>
</span></span><span class="line"><span class="cl"><span class="n">Observation</span><span class="p">:</span> <span class="n">the</span> <span class="n">result</span> <span class="n">of</span> <span class="n">the</span> <span class="n">action</span>
</span></span><span class="line"><span class="cl"><span class="o">...</span> <span class="p">(</span><span class="n">this</span> <span class="n">Thought</span><span class="o">/</span><span class="n">Action</span><span class="o">/</span><span class="n">Action</span> <span class="n">Input</span><span class="o">/</span><span class="n">Observation</span> <span class="n">can</span> <span class="n">be</span> <span class="n">repeated</span> <span class="n">zero</span> <span class="ow">or</span> <span class="n">more</span> <span class="n">times</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">Thought</span><span class="p">:</span> <span class="n">I</span> <span class="n">now</span> <span class="n">know</span> <span class="n">the</span> <span class="n">final</span> <span class="n">answer</span>
</span></span><span class="line"><span class="cl"><span class="n">Final</span> <span class="n">Answer</span><span class="p">:</span> <span class="n">the</span> <span class="n">final</span> <span class="n">answer</span> <span class="n">to</span> <span class="n">the</span> <span class="n">original</span> <span class="nb">input</span> <span class="n">question</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Begin</span><span class="err">!</span>
</span></span><span class="line"><span class="cl">                                                                                                 
</span></span><span class="line"><span class="cl"><span class="n">user</span>
</span></span><span class="line"><span class="cl"><span class="n">Question</span><span class="p">:</span> <span class="n">What</span> <span class="ow">is</span> <span class="n">the</span> <span class="n">population</span> <span class="n">of</span> <span class="n">Tokyo</span><span class="err">?</span>
</span></span><span class="line"><span class="cl"><span class="n">assistant</span>
</span></span><span class="line"><span class="cl"><span class="n">Thought</span><span class="p">:</span> <span class="n">I</span> <span class="n">can</span> <span class="n">use</span> <span class="n">geo_lookup</span> <span class="n">to</span> <span class="n">find</span> <span class="n">the</span> <span class="n">information</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Action</span><span class="p">:</span> <span class="n">geo_lookup</span>
</span></span><span class="line"><span class="cl"><span class="n">Action</span> <span class="n">Input</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;query&#34;</span><span class="p">:</span> <span class="s2">&#34;Tokyo&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">Observation</span><span class="p">:</span> <span class="n">The</span> <span class="n">population</span> <span class="n">of</span> <span class="n">Tokyo</span> <span class="ow">is</span> <span class="n">about</span> <span class="mi">14</span> <span class="n">million</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Thought</span><span class="p">:</span> <span class="n">I</span> <span class="n">now</span> <span class="n">know</span> <span class="n">the</span> <span class="n">final</span> <span class="n">answer</span><span class="o">.</span>
</span></span><span class="line"><span class="cl"><span class="n">Final</span> <span class="n">answer</span><span class="p">:</span> <span class="n">The</span> <span class="n">population</span> <span class="n">of</span> <span class="n">Tokyo</span> <span class="ow">is</span> <span class="n">about</span> <span class="mi">14</span> <span class="n">million</span><span class="o">.</span>                                                                                                 
</span></span></code></pre></div><p>在这个例子中，用户询问东京的人口数量。助手利用**<code>geo_lookup</code>**工具进行查询，具体的行动步骤包括：</p>
<ul>
<li>
<p><strong>思考</strong>：助手决定可以使用**<code>geo_lookup</code>**工具来查找信息。</p>
</li>
<li>
<p><strong>行动</strong>：实际调用**<code>geo_lookup</code>**工具。</p>
</li>
<li>
<p><strong>行动输入</strong>：向工具传递的参数，即查询**<code>&quot;Tokyo&quot;</code>**。</p>
</li>
<li>
<p><strong>观察</strong>：观察到的结果，这里是东京的人口大约为1400万。</p>
</li>
<li>
<p><strong>最终思考</strong>：基于观察结果，助手得出了最终答案。</p>
</li>
<li>
<p><strong>最终答案</strong>：向用户提供的答案，即东京的人口数量。</p>
</li>
</ul>
<p>更详细的内容，建议看这篇知乎文章：<strong><a href="https://zhuanlan.zhihu.com/p/674859843">Qwen Function Calling 的对话模板及训练方法总结</a>; 以及qwen的官方文档：</strong><a href="https://github.com/QwenLM/Qwen/blob/main/examples/react_prompt.md">ReAct Prompting 示例</a></p>
<h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<p><a href="https://platform.openai.com/docs/guides/function-calling">openAI function calling</a></p>
<p><a href="https://cookbook.openai.com/examples/how_to_call_functions_with_chat_models">How to call functions with chat models</a></p>
<p><a href="https://github.com/openai/openai-cookbook/blob/main/examples/How_to_call_functions_for_knowledge_retrieval.ipynb">How_to_call_functions_for_knowledge_retrieval</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/674859843">Qwen Function Calling 的对话模板及训练方法总结</a></p>
<p><a href="https://github.com/QwenLM/Qwen/blob/main/examples/react_prompt.md">qwen的官方文档</a></p>
<p><a href="https://github.com/THUDM/ChatGLM3/blob/main/PROMPT.md">GLM的官方文档</a></p>
<p><a href="https://console.groq.com/docs/tool-use">tool-using via Groq API</a></p>
<p><a href="https://console.groq.com/docs/text-chat#json-mode-object-object">Json mode in Groq</a></p>
<p><a href="https://cobusgreyling.medium.com/openai-json-mode-seeding-6aeb6f7664b0">OpenAI JSON Mode &amp; Seeding</a></p>
<p><a href="https://community.openai.com/t/openai-api-guide-using-json-mode/557265">OpenAI API Guide: Using JSON Mode</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://niraya666.github.io/tags/agent/">Agent</a></li>
      <li><a href="https://niraya666.github.io/tags/tool-using/">Tool-Using</a></li>
    </ul>
<nav class="paginav">
  <a class="prev" href="https://niraya666.github.io/posts/%E5%9F%BA%E4%BA%8E%E5%A4%A7%E8%AF%AD%E8%A8%80%E6%A8%A1%E5%9E%8B%E7%9A%84-agent%E7%A7%91%E6%99%AE%E5%90%91/">
    <span class="title">« Prev</span>
    <br>
    <span>基于大语言模型的 Agent：科普向</span>
  </a>
  <a class="next" href="https://niraya666.github.io/posts/rag%E5%B7%A5%E5%85%B7%E7%AE%B1%E6%96%87%E6%A1%A3%E8%A7%A3%E6%9E%90%E4%B8%8E%E8%A1%A8%E6%A0%BC%E5%A4%84%E7%90%86/">
    <span class="title">Next »</span>
    <br>
    <span>RAG工具箱：文档解析与表格处理</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Agent学习笔记：OpenAI Function Calling完全指南 on x"
            href="https://x.com/intent/tweet/?text=Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%ef%bc%9aOpenAI%20Function%20Calling%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97&amp;url=https%3a%2f%2fniraya666.github.io%2fposts%2fagent%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0openai-function-calling%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597%2f&amp;hashtags=Agent%2ctool-using">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Agent学习笔记：OpenAI Function Calling完全指南 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fniraya666.github.io%2fposts%2fagent%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0openai-function-calling%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597%2f&amp;title=Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%ef%bc%9aOpenAI%20Function%20Calling%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97&amp;summary=Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%ef%bc%9aOpenAI%20Function%20Calling%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97&amp;source=https%3a%2f%2fniraya666.github.io%2fposts%2fagent%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0openai-function-calling%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Agent学习笔记：OpenAI Function Calling完全指南 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fniraya666.github.io%2fposts%2fagent%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0openai-function-calling%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597%2f&title=Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%ef%bc%9aOpenAI%20Function%20Calling%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Agent学习笔记：OpenAI Function Calling完全指南 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fniraya666.github.io%2fposts%2fagent%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0openai-function-calling%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Agent学习笔记：OpenAI Function Calling完全指南 on whatsapp"
            href="https://api.whatsapp.com/send?text=Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%ef%bc%9aOpenAI%20Function%20Calling%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97%20-%20https%3a%2f%2fniraya666.github.io%2fposts%2fagent%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0openai-function-calling%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Agent学习笔记：OpenAI Function Calling完全指南 on telegram"
            href="https://telegram.me/share/url?text=Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%ef%bc%9aOpenAI%20Function%20Calling%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97&amp;url=https%3a%2f%2fniraya666.github.io%2fposts%2fagent%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0openai-function-calling%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Agent学习笔记：OpenAI Function Calling完全指南 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Agent%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%ef%bc%9aOpenAI%20Function%20Calling%e5%ae%8c%e5%85%a8%e6%8c%87%e5%8d%97&u=https%3a%2f%2fniraya666.github.io%2fposts%2fagent%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0openai-function-calling%25E5%25AE%258C%25E5%2585%25A8%25E6%258C%2587%25E5%258D%2597%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
<div id="utterances">
  <script src="https://utteranc.es/client.js"
        repo="https://github.com/Niraya666/niraya666.github.io.git"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>
</div>


<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://niraya666.github.io/">LZY Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
