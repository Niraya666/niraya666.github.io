<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Milvus-2.5版本：学习笔记和备忘录 | LZY Blog</title>
<meta name="keywords" content="RAG, 向量库">
<meta name="description" content="几年前初识 Milvus 的契机，来源于开发一个图像相似检索的应用，当时市面上向量库的可选择项并不像现在这么多，且功能也仅限于单纯的向量检索。
鉴于最近有业务更新的需要，和打算重构一下之前做的RAG项目，再次有机会深入学习 Milvus，探索其在新功能和实际应用上的更多可能性。
本篇笔记，仅作为学习笔记，更多是记录一些 Milvus从2.0 到2.5 的变化， 和一些动手实践的记录，便于之后的查阅。
一些概念
Collections, Schema and index
Collection是Milvus中的一个二维表格，具有固定的列和可变的行。每一列代表一个字段(field)，每一行代表一个实体(entity)
Schema和字段 Collection需要一个schema来定义其结构
索引 在特定字段上创建索引可以提高搜索效率。建议为服务所依赖的所有字段创建索引，其中向量字段的索引是必需的。
分区(Partition) 分区是Collection的子集，与其父Collection共享相同的字段集
分片(Shard) 分片是Collection的水平切片。每个分片对应一个数据输入通道。
Shard vs Partition的区别 :


分区(Partition)的作用是通过指定分区名称来减少读取负载


而分片(Shard)的作用是将写入负载分散到多个服务器分布式架构中的应用 在分布式系统中，分片是实现水平扩展的重要机制。通过将数据分布到多个节点，可以充分利用集群的并行计算潜力，提高系统的写入性能


MilvusClient vs Connection
MilvusClient
定位：更高级封装，提供一体化的操作接口。简化了与 Milvus 的交互流程， 提供更直观和结构化的操作方式，便于新手快速上手，内置了对连接的管理和操作，减少手动处理的复杂性。
from pymilvus import MilvusClient

# 创建客户端并连接到 Milvus
client = MilvusClient(uri=&#34;http://localhost:19530&#34;)

# 创建集合
client.create_collection(
    name=&#34;example_collection&#34;,
    schema={&#34;fields&#34;: [{&#34;name&#34;: &#34;vector&#34;, &#34;type&#34;: &#34;FLOAT_VECTOR&#34;, &#34;params&#34;: {&#34;dim&#34;: 128}}]}
)

# 插入数据
client.insert(&#34;example_collection&#34;, data={&#34;vector&#34;: [[0.1] * 128, [0.2] * 128]})

# 搜索
results = client.search(&#34;example_collection&#34;, data=[[0.1] * 128])
print(results)
Connection
定位：基础连接操作，需要通过 connect 方法创建并维护连接。提供更底层的控制，适合灵活、自定义的操作。
from pymilvus import connections, Collection, FieldSchema, CollectionSchema

# 创建连接
connections.connect(alias=&#34;default&#34;, host=&#34;localhost&#34;, port=&#34;19530&#34;)

# 创建集合
fields = [
    FieldSchema(name=&#34;vector&#34;, dtype=&#34;FLOAT_VECTOR&#34;, dim=128)
]
schema = CollectionSchema(fields, description=&#34;example collection&#34;)
collection = Collection(name=&#34;example_collection&#34;, schema=schema)

# 插入数据
collection.insert([[0.1] * 128, [0.2] * 128])

# 搜索
collection.load()
results = collection.search([[0.1] * 128], anns_field=&#34;vector&#34;, limit=10)
print(results)
Schema
Schema 用于定义collection及其字段的属性">
<meta name="author" content="Theme PaperMod">
<link rel="canonical" href="https://niraya666.github.io/posts/milvus-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%92%8C%E5%A4%87%E5%BF%98%E5%BD%95%E4%BB%8E2.0-%E5%88%B02.5%E7%89%88%E6%9C%AC%E7%9A%84%E4%BB%8E%E5%A4%B4%E5%AD%A6%E4%B9%A0/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css" integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z&#43;V9&#43;cO1A=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://niraya666.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://niraya666.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://niraya666.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://niraya666.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://niraya666.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://niraya666.github.io/posts/milvus-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%92%8C%E5%A4%87%E5%BF%98%E5%BD%95%E4%BB%8E2.0-%E5%88%B02.5%E7%89%88%E6%9C%AC%E7%9A%84%E4%BB%8E%E5%A4%B4%E5%AD%A6%E4%B9%A0/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Milvus-2.5版本：学习笔记和备忘录" />
<meta property="og:description" content="几年前初识 Milvus 的契机，来源于开发一个图像相似检索的应用，当时市面上向量库的可选择项并不像现在这么多，且功能也仅限于单纯的向量检索。
鉴于最近有业务更新的需要，和打算重构一下之前做的RAG项目，再次有机会深入学习 Milvus，探索其在新功能和实际应用上的更多可能性。
本篇笔记，仅作为学习笔记，更多是记录一些 Milvus从2.0 到2.5 的变化， 和一些动手实践的记录，便于之后的查阅。
一些概念
Collections, Schema and index
Collection是Milvus中的一个二维表格，具有固定的列和可变的行。每一列代表一个字段(field)，每一行代表一个实体(entity)
Schema和字段 Collection需要一个schema来定义其结构
索引 在特定字段上创建索引可以提高搜索效率。建议为服务所依赖的所有字段创建索引，其中向量字段的索引是必需的。
分区(Partition) 分区是Collection的子集，与其父Collection共享相同的字段集
分片(Shard) 分片是Collection的水平切片。每个分片对应一个数据输入通道。
Shard vs Partition的区别 :


分区(Partition)的作用是通过指定分区名称来减少读取负载


而分片(Shard)的作用是将写入负载分散到多个服务器分布式架构中的应用 在分布式系统中，分片是实现水平扩展的重要机制。通过将数据分布到多个节点，可以充分利用集群的并行计算潜力，提高系统的写入性能


MilvusClient vs Connection
MilvusClient
定位：更高级封装，提供一体化的操作接口。简化了与 Milvus 的交互流程， 提供更直观和结构化的操作方式，便于新手快速上手，内置了对连接的管理和操作，减少手动处理的复杂性。
from pymilvus import MilvusClient

# 创建客户端并连接到 Milvus
client = MilvusClient(uri=&#34;http://localhost:19530&#34;)

# 创建集合
client.create_collection(
    name=&#34;example_collection&#34;,
    schema={&#34;fields&#34;: [{&#34;name&#34;: &#34;vector&#34;, &#34;type&#34;: &#34;FLOAT_VECTOR&#34;, &#34;params&#34;: {&#34;dim&#34;: 128}}]}
)

# 插入数据
client.insert(&#34;example_collection&#34;, data={&#34;vector&#34;: [[0.1] * 128, [0.2] * 128]})

# 搜索
results = client.search(&#34;example_collection&#34;, data=[[0.1] * 128])
print(results)
Connection
定位：基础连接操作，需要通过 connect 方法创建并维护连接。提供更底层的控制，适合灵活、自定义的操作。
from pymilvus import connections, Collection, FieldSchema, CollectionSchema

# 创建连接
connections.connect(alias=&#34;default&#34;, host=&#34;localhost&#34;, port=&#34;19530&#34;)

# 创建集合
fields = [
    FieldSchema(name=&#34;vector&#34;, dtype=&#34;FLOAT_VECTOR&#34;, dim=128)
]
schema = CollectionSchema(fields, description=&#34;example collection&#34;)
collection = Collection(name=&#34;example_collection&#34;, schema=schema)

# 插入数据
collection.insert([[0.1] * 128, [0.2] * 128])

# 搜索
collection.load()
results = collection.search([[0.1] * 128], anns_field=&#34;vector&#34;, limit=10)
print(results)
Schema
Schema 用于定义collection及其字段的属性" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://niraya666.github.io/posts/milvus-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%92%8C%E5%A4%87%E5%BF%98%E5%BD%95%E4%BB%8E2.0-%E5%88%B02.5%E7%89%88%E6%9C%AC%E7%9A%84%E4%BB%8E%E5%A4%B4%E5%AD%A6%E4%B9%A0/" />
<meta property="og:image" content="https://niraya666.github.io/images/papermod-cover.png" />
<meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-12-25T15:49:00+08:00" />
<meta property="article:modified_time" content="2024-12-25T15:49:00+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://niraya666.github.io/images/papermod-cover.png" />
<meta name="twitter:title" content="Milvus-2.5版本：学习笔记和备忘录"/>
<meta name="twitter:description" content="几年前初识 Milvus 的契机，来源于开发一个图像相似检索的应用，当时市面上向量库的可选择项并不像现在这么多，且功能也仅限于单纯的向量检索。
鉴于最近有业务更新的需要，和打算重构一下之前做的RAG项目，再次有机会深入学习 Milvus，探索其在新功能和实际应用上的更多可能性。
本篇笔记，仅作为学习笔记，更多是记录一些 Milvus从2.0 到2.5 的变化， 和一些动手实践的记录，便于之后的查阅。
一些概念
Collections, Schema and index
Collection是Milvus中的一个二维表格，具有固定的列和可变的行。每一列代表一个字段(field)，每一行代表一个实体(entity)
Schema和字段 Collection需要一个schema来定义其结构
索引 在特定字段上创建索引可以提高搜索效率。建议为服务所依赖的所有字段创建索引，其中向量字段的索引是必需的。
分区(Partition) 分区是Collection的子集，与其父Collection共享相同的字段集
分片(Shard) 分片是Collection的水平切片。每个分片对应一个数据输入通道。
Shard vs Partition的区别 :


分区(Partition)的作用是通过指定分区名称来减少读取负载


而分片(Shard)的作用是将写入负载分散到多个服务器分布式架构中的应用 在分布式系统中，分片是实现水平扩展的重要机制。通过将数据分布到多个节点，可以充分利用集群的并行计算潜力，提高系统的写入性能


MilvusClient vs Connection
MilvusClient
定位：更高级封装，提供一体化的操作接口。简化了与 Milvus 的交互流程， 提供更直观和结构化的操作方式，便于新手快速上手，内置了对连接的管理和操作，减少手动处理的复杂性。
from pymilvus import MilvusClient

# 创建客户端并连接到 Milvus
client = MilvusClient(uri=&#34;http://localhost:19530&#34;)

# 创建集合
client.create_collection(
    name=&#34;example_collection&#34;,
    schema={&#34;fields&#34;: [{&#34;name&#34;: &#34;vector&#34;, &#34;type&#34;: &#34;FLOAT_VECTOR&#34;, &#34;params&#34;: {&#34;dim&#34;: 128}}]}
)

# 插入数据
client.insert(&#34;example_collection&#34;, data={&#34;vector&#34;: [[0.1] * 128, [0.2] * 128]})

# 搜索
results = client.search(&#34;example_collection&#34;, data=[[0.1] * 128])
print(results)
Connection
定位：基础连接操作，需要通过 connect 方法创建并维护连接。提供更底层的控制，适合灵活、自定义的操作。
from pymilvus import connections, Collection, FieldSchema, CollectionSchema

# 创建连接
connections.connect(alias=&#34;default&#34;, host=&#34;localhost&#34;, port=&#34;19530&#34;)

# 创建集合
fields = [
    FieldSchema(name=&#34;vector&#34;, dtype=&#34;FLOAT_VECTOR&#34;, dim=128)
]
schema = CollectionSchema(fields, description=&#34;example collection&#34;)
collection = Collection(name=&#34;example_collection&#34;, schema=schema)

# 插入数据
collection.insert([[0.1] * 128, [0.2] * 128])

# 搜索
collection.load()
results = collection.search([[0.1] * 128], anns_field=&#34;vector&#34;, limit=10)
print(results)
Schema
Schema 用于定义collection及其字段的属性"/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://niraya666.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Milvus-2.5版本：学习笔记和备忘录",
      "item": "https://niraya666.github.io/posts/milvus-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%92%8C%E5%A4%87%E5%BF%98%E5%BD%95%E4%BB%8E2.0-%E5%88%B02.5%E7%89%88%E6%9C%AC%E7%9A%84%E4%BB%8E%E5%A4%B4%E5%AD%A6%E4%B9%A0/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Milvus-2.5版本：学习笔记和备忘录",
  "name": "Milvus-2.5版本：学习笔记和备忘录",
  "description": "几年前初识 Milvus 的契机，来源于开发一个图像相似检索的应用，当时市面上向量库的可选择项并不像现在这么多，且功能也仅限于单纯的向量检索。\n鉴于最近有业务更新的需要，和打算重构一下之前做的RAG项目，再次有机会深入学习 Milvus，探索其在新功能和实际应用上的更多可能性。\n本篇笔记，仅作为学习笔记，更多是记录一些 Milvus从2.0 到2.5 的变化， 和一些动手实践的记录，便于之后的查阅。\n一些概念 Collections, Schema and index Collection是Milvus中的一个二维表格，具有固定的列和可变的行。每一列代表一个字段(field)，每一行代表一个实体(entity)\nSchema和字段 Collection需要一个schema来定义其结构\n索引 在特定字段上创建索引可以提高搜索效率。建议为服务所依赖的所有字段创建索引，其中向量字段的索引是必需的。\n分区(Partition) 分区是Collection的子集，与其父Collection共享相同的字段集\n分片(Shard) 分片是Collection的水平切片。每个分片对应一个数据输入通道。\nShard vs Partition的区别 :\n分区(Partition)的作用是通过指定分区名称来减少读取负载\n而分片(Shard)的作用是将写入负载分散到多个服务器分布式架构中的应用 在分布式系统中，分片是实现水平扩展的重要机制。通过将数据分布到多个节点，可以充分利用集群的并行计算潜力，提高系统的写入性能\nMilvusClient vs Connection MilvusClient\n定位：更高级封装，提供一体化的操作接口。简化了与 Milvus 的交互流程， 提供更直观和结构化的操作方式，便于新手快速上手，内置了对连接的管理和操作，减少手动处理的复杂性。\nfrom pymilvus import MilvusClient # 创建客户端并连接到 Milvus client = MilvusClient(uri=\u0026#34;http://localhost:19530\u0026#34;) # 创建集合 client.create_collection( name=\u0026#34;example_collection\u0026#34;, schema={\u0026#34;fields\u0026#34;: [{\u0026#34;name\u0026#34;: \u0026#34;vector\u0026#34;, \u0026#34;type\u0026#34;: \u0026#34;FLOAT_VECTOR\u0026#34;, \u0026#34;params\u0026#34;: {\u0026#34;dim\u0026#34;: 128}}]} ) # 插入数据 client.insert(\u0026#34;example_collection\u0026#34;, data={\u0026#34;vector\u0026#34;: [[0.1] * 128, [0.2] * 128]}) # 搜索 results = client.search(\u0026#34;example_collection\u0026#34;, data=[[0.1] * 128]) print(results) Connection\n定位：基础连接操作，需要通过 connect 方法创建并维护连接。提供更底层的控制，适合灵活、自定义的操作。\nfrom pymilvus import connections, Collection, FieldSchema, CollectionSchema # 创建连接 connections.connect(alias=\u0026#34;default\u0026#34;, host=\u0026#34;localhost\u0026#34;, port=\u0026#34;19530\u0026#34;) # 创建集合 fields = [ FieldSchema(name=\u0026#34;vector\u0026#34;, dtype=\u0026#34;FLOAT_VECTOR\u0026#34;, dim=128) ] schema = CollectionSchema(fields, description=\u0026#34;example collection\u0026#34;) collection = Collection(name=\u0026#34;example_collection\u0026#34;, schema=schema) # 插入数据 collection.insert([[0.1] * 128, [0.2] * 128]) # 搜索 collection.load() results = collection.search([[0.1] * 128], anns_field=\u0026#34;vector\u0026#34;, limit=10) print(results) Schema Schema 用于定义collection及其字段的属性\n",
  "keywords": [
    "RAG", "向量库"
  ],
  "articleBody": "几年前初识 Milvus 的契机，来源于开发一个图像相似检索的应用，当时市面上向量库的可选择项并不像现在这么多，且功能也仅限于单纯的向量检索。\n鉴于最近有业务更新的需要，和打算重构一下之前做的RAG项目，再次有机会深入学习 Milvus，探索其在新功能和实际应用上的更多可能性。\n本篇笔记，仅作为学习笔记，更多是记录一些 Milvus从2.0 到2.5 的变化， 和一些动手实践的记录，便于之后的查阅。\n一些概念 Collections, Schema and index Collection是Milvus中的一个二维表格，具有固定的列和可变的行。每一列代表一个字段(field)，每一行代表一个实体(entity)\nSchema和字段 Collection需要一个schema来定义其结构\n索引 在特定字段上创建索引可以提高搜索效率。建议为服务所依赖的所有字段创建索引，其中向量字段的索引是必需的。\n分区(Partition) 分区是Collection的子集，与其父Collection共享相同的字段集\n分片(Shard) 分片是Collection的水平切片。每个分片对应一个数据输入通道。\nShard vs Partition的区别 :\n分区(Partition)的作用是通过指定分区名称来减少读取负载\n而分片(Shard)的作用是将写入负载分散到多个服务器分布式架构中的应用 在分布式系统中，分片是实现水平扩展的重要机制。通过将数据分布到多个节点，可以充分利用集群的并行计算潜力，提高系统的写入性能\nMilvusClient vs Connection MilvusClient\n定位：更高级封装，提供一体化的操作接口。简化了与 Milvus 的交互流程， 提供更直观和结构化的操作方式，便于新手快速上手，内置了对连接的管理和操作，减少手动处理的复杂性。\nfrom pymilvus import MilvusClient # 创建客户端并连接到 Milvus client = MilvusClient(uri=\"http://localhost:19530\") # 创建集合 client.create_collection( name=\"example_collection\", schema={\"fields\": [{\"name\": \"vector\", \"type\": \"FLOAT_VECTOR\", \"params\": {\"dim\": 128}}]} ) # 插入数据 client.insert(\"example_collection\", data={\"vector\": [[0.1] * 128, [0.2] * 128]}) # 搜索 results = client.search(\"example_collection\", data=[[0.1] * 128]) print(results) Connection\n定位：基础连接操作，需要通过 connect 方法创建并维护连接。提供更底层的控制，适合灵活、自定义的操作。\nfrom pymilvus import connections, Collection, FieldSchema, CollectionSchema # 创建连接 connections.connect(alias=\"default\", host=\"localhost\", port=\"19530\") # 创建集合 fields = [ FieldSchema(name=\"vector\", dtype=\"FLOAT_VECTOR\", dim=128) ] schema = CollectionSchema(fields, description=\"example collection\") collection = Collection(name=\"example_collection\", schema=schema) # 插入数据 collection.insert([[0.1] * 128, [0.2] * 128]) # 搜索 collection.load() results = collection.search([[0.1] * 128], anns_field=\"vector\", limit=10) print(results) Schema Schema 用于定义collection及其字段的属性\n设定 Schema 的目的是为了定义数据的逻辑结构和存储规则。Schema 是集合（Collection）和字段（Field）的元数据定义，它决定了如何存储和管理数据，同时保证数据操作的一致性、灵活性和高效性。\n字段属性（Field Properties）\n属性名称 描述 注意事项 name 字段名称 必须字段，类型为字符串。 dtype 字段的数据类型 必须字段。 description 字段的描述 可选字段，类型为字符串。 is_primary 是否将字段设为主键 类型为布尔值（true 或 false），主键字段必须指定。 auto_id 是否启用自动 ID 分配 必须为主键字段设置，类型为布尔值。 max_length VARCHAR 字段的最大长度（以字节为单位） 必须为 VARCHAR 字段指定，范围为 [1, 65,535]。 dim 向量的维度 对于稠密向量字段，必须指定；对稀疏向量字段可以省略。范围为 [1, 32,768]。 is_partition_key 是否为分区键字段 类型为布尔值（true 或 false）。 Milvus 支持以下三类字段：\n1. 主键字段\n主键字段是集合的唯一标识，用于标识集合中的每条记录。\n属性 描述 name 主键字段的名称 dtype 支持 INT64（整数主键）或 VARCHAR（字符串主键） is_primary 必须设为 True，表示该字段是主键 auto_id 是否自动生成主键值（布尔值：True 或 False） 2. 标量字段\n标量字段用于存储布尔值、整数、浮点数、字符串、JSON 数据或数组等。\n数据类型 描述 BOOL 布尔值，支持 true 或 false INT8 8 位整数 INT16 16 位整数 INT32 32 位整数 INT64 64 位整数 FLOAT 32 位单精度浮点数 DOUBLE 64 位双精度浮点数 VARCHAR 可变长度字符串，需指定最大长度（max_length） JSON JSON 数据类型，存储键值对 Array 数组类型，用于存储多个相同类型的数据 3. 向量字段\n向量字段用于存储高维特征数据，是 Milvus 支持向量检索的基础。\n数据类型 描述 FLOAT_VECTOR 32 位浮点型向量，常用于机器学习和深度学习模型的特征表示 BINARY_VECTOR 二进制向量，存储由 0 和 1 组成的序列，用于图像处理或紧凑特征表示 FLOAT16_VECTOR 16 位浮点型向量，用于深度学习和 GPU 计算的内存优化 BFLOAT16_VECTOR 16 位浮点型向量，具有与 FLOAT32 相同的指数范围，常用于深度学习优化 SPARSE_FLOAT_VECTOR 稀疏浮点型向量，存储非零元素及其索引，用于稀疏向量场景 其他支持的字段属性\nis_partition_key: 是否将字段作为分区键，支持 true 或 false。\ndim: 向量字段的维度，必需为向量字段定义。\nmax_length: VARCHAR 类型字段的最大字节长度。\n动态字段允许在插入数据时不提前定义字段，可以通过 enable_dynamic_field=True 在collection Schema 中启用\n属性名称 描述 注意事项 fields 字段的集合 必须字段。 description 集合的描述 可选字段，类型为字符串。 partition_key_field 作为分区键的字段名 可选字段，类型为字符串。 enable_dynamic_field 是否启用动态字段 可选字段，类型为布尔值，默认值为 false。 Index 为什么需要构造索引？\n加速搜索：向量搜索的主要瓶颈在于计算高维向量之间的相似性。如果不使用索引，检索可能需要线性扫描整个数据集，耗时且资源消耗大；\n支持大规模数据： 在百万甚至十亿级别的数据量中，直接搜索变得不可行。索引能够分层次或分块处理数据，从而支持大规模数据场景\n资源效率：使用索引可以显著减少内存和计算资源的占用，尤其在处理频繁的实时查询时更加重要。\n几种主要的索引类型：\n密集向量（Dense Vectors）\n索引名称 适合场景 优点 缺点 参数解释 原理 FLAT 小数据集，精确搜索 搜索结果精确，简单易用 随数据量增加，速度显著下降 无需额外参数 对所有向量进行线性扫描，计算查询向量与每个向量的距离，从而找到最相似的结果。 IVF_FLAT 中等规模数据集 搜索效率高，支持近似搜索 搜索精度依赖参数调整 nlist：桶的数量，影响召回率和性能；nprobe：查询时访问的桶数量，影响搜索的准确性和速度 将向量划分为多个簇（cluster），通过聚类算法（如 k-means）预先构建倒排文件，仅在相关簇中执行搜索，减少比较次数，提高效率。 IVF_SQ8 需要平衡存储和性能的场景 存储需求低 搜索精度较低 与 IVF_FLAT 相同 在 IVF_FLAT 的基础上对每个向量进行标量量化（Scalar Quantization, SQ），将原始浮点向量压缩为整数形式以节省存储空间。 IVF_PQ 超大规模数据集，存储敏感场景 存储需求显著降低 搜索精度较低 nlist：桶的数量；m：子向量的数量，影响压缩比和性能；nbits：每个子向量的编码位数，影响压缩质量 基于 IVF_FLAT，使用产品量化（Product Quantization, PQ）将向量分为多个子空间，并分别进行量化，从而显著减少存储需求。 HNSW 中小规模数据集，高搜索精度场景 高性能，高维数据效果良好 索引构建时间长，占用内存大 efConstruction：控制构建时的候选集大小，影响构建速度和搜索精度；ef：搜索时的候选集大小，影响搜索性能和精度 使用分层的近似图（Navigable Small World Graph, NSW）表示向量之间的关系，通过图的导航找到查询向量的近似最近邻。 DISKANN 磁盘存储超大规模数据集 支持超大规模数据检索 查询速度较慢 search_list：控制查询范围，影响精度；pq_code_budget_gb：控制压缩的预算大小；build_threads：控制索引构建的线程数 结合倒排文件和磁盘访问优化，将部分索引和数据保存在磁盘上，通过减少内存占用实现超大规模数据检索。 支持的度量类型有欧几里得距离（L2）、内积（IP）、余弦相似度（COSINE）。\n二进制向量（Binary Vectors）\n二进制向量（布尔值、哈希签名），占用资源低，对低维数据搜索快，精度不太高的场景\n索引名称 适合场景 优点 缺点 参数解释 原理 BIN_FLAT 小规模数据集，精确搜索 搜索结果精确，易于实现 随数据量增加，速度显著下降 无需额外参数 对所有二进制向量进行线性扫描，逐一计算查询向量与每个向量的距离（如汉明距离），从而找到最相似的结果。 BIN_IVF_FLAT 中等规模数据集 搜索效率高，支持近似搜索 搜索精度依赖参数调整 - nlist：桶的数量，影响召回率和性能\n- nprobe：查询时访问的桶数量，影响搜索的准确性和速度 结合倒排文件和线性扫描，将二进制向量划分到不同的桶中，通过访问部分桶来加速检索过程。 支持的度量类型有 Jaccard 和 Hamming\n稀疏向量（Sparse Vectors）\n常用于文档搜索\n索引名称 适合场景 优点 缺点 参数解释 原理 SPARSE_INVERTED_INDEX 文档检索、推荐系统 高效支持稀疏数据的相似性搜索 仅支持稀疏向量 - 无需额外参数 基于倒排索引（Inverted Index），将稀疏向量的非零值索引到特定位置，通过快速查找相关文档加速检索过程。 SPARSE_WAND 高性能文档检索、稀疏向量场景 支持稀疏数据，搜索效率更高 构建复杂度较高 - top_k：控制返回的搜索结果数量 基于 WAND（Weighted AND）算法优化倒排索引，对查询进行剪枝优化，仅访问最相关的文档，提高搜索性能。 支持内积（IP）度量\n如何选择合适的index\nfrom RAG搭建中，如何选择最合适的向量索引？\nGPU-index\n索引名称 适合场景 优点 缺点 参数解释 原理 GPU_BRUTE_FORCE 小批量搜索，高性能需求场景 结果精确，性能优于 CPU 的线性扫描 不支持范围搜索，资源消耗较高 无需额外参数 使用 GPU 并行计算能力对所有向量执行线性扫描，计算查询向量与每个向量的相似性，从而获得结果。 GPU_IVF_FLAT 大规模数据集搜索，高吞吐量需求场景 搜索效率高，结合 GPU 加速 搜索精度依赖参数调整 - nlist：桶的数量，影响召回率和性能\n- nprobe：查询时访问的桶数量，影响搜索的准确性和速度 在 CPU IVF_FLAT 的基础上，利用 GPU 加速桶的分配和搜索过程，大幅提高检索速度。 GPU_IVF_PQ 大规模数据存储敏感场景，高吞吐量需求场景 存储需求显著降低，支持近似搜索 搜索精度较低 - nlist：桶的数量\n- m：子向量数量，影响压缩比和性能\n- nbits：每个子向量的编码位数，影响压缩质量 结合倒排文件与产品量化（PQ）技术，利用 GPU 提高量化和检索过程的速度，适合超大规模数据检索。 GPU_CAGRA 超高吞吐量和高召回率场景 高性能，高召回率，适合大批量查询 消耗更多内存，索引构建时间长 - intermediate_graph_degree：构建时图的中间连接数量，影响构建时间和召回率\n- graph_degree：最终图的连接数量，影响搜索性能和内存占用 基于图的搜索算法（如 CAGRA），结合 GPU 的并行计算能力构建分层图结构，提高搜索的速度和精度。 Analyzer 用于将原始文本转换为结构化和可搜索的格式。它的主要作用是实现文本处理、索引构建和检索优化。\n在本质上，analyzer 包含了一个tokenizer（分词器）和可选的多个filters（过滤器）。\n用途: 将输入文本分解为更小的单元（tokens）; 通过过滤器进一步处理分词后的 token，例如转为小写、移除停用词、仅保留特定字符等; 将处理后的文本用于全文检索和关键词匹配。\nhow to use：\nschema.add_field( field_name='text_field', datatype=DataType.VARCHAR, max_length=1000, enable_analyzer=True, analyzer_params={ \"type\": \"standard\", # 使用内置 analyzer \"stop_words\": [\"a\", \"an\", \"the\"] }, enable_match=True, # 启用关键词匹配 ) 内置 Analyzer： 提供快速配置，适用于通用场景，如：\nstandard（标准分词器）/english（针对英文优化）/ chinese（针对中文优化）\n自定义 Analyzer， 如：\nanalyzer_params = { \"tokenizer\": \"standard\", \"filter\": [ \"lowercase\", # 转为小写 { \"type\": \"stop\", # 自定义停用词 \"stop_words\": [\"of\", \"to\", \"the\"] } ] } ANN Search in Milvus 不同于传统数据库的精确匹配查询,向量库主要用于相似性搜索。这种搜索基于向量间的距离,通常使用欧几里得距离或余弦相似度。以暴力遍历的最近邻查询为例(Nearest neighbor search),假设我们有n个d维向量,查询复杂度为$O(nd)$。当n和d都很大时,这种方法变得非常耗时。\n而近似最近邻搜索(Approximate Nearest Neighbor search, ANN)则能将时间复杂度降低到亚线性,通常为$O(log n)$或更优。\nhow to ANN-search\ncreate collection , schema and index\ninsert data\nsearch\n构造索引\nfrom pymilvus import MilvusClient, DataType import numpy as np # 创建Milvus客户端 client = MilvusClient( uri=\"http://localhost:19530\" ) # 创建schema schema = MilvusClient.create_schema( auto_id=False, enable_dynamic_field=True, ) # 添加字段到schema schema.add_field(field_name=\"my_id\", datatype=DataType.INT64, is_primary=True) schema.add_field(field_name=\"my_vector\", datatype=DataType.FLOAT_VECTOR, dim=5) schema.add_field(field_name=\"my_varchar\", datatype=DataType.VARCHAR, max_length=512) # 准备索引参数 index_params = client.prepare_index_params() # 添加索引 index_params.add_index( field_name=\"my_id\", index_type=\"STL_SORT\" ) index_params.add_index( field_name=\"my_vector\", index_type=\"AUTOINDEX\", metric_type=\"COSINE\" ) # 创建collection client.create_collection( collection_name=\"customized_setup_1\", schema=schema, index_params=index_params )` 数据插入\ndata = [ { \"my_id\": i, \"my_vector\": np.random.random(5).tolist(), \"my_varchar\": f\"example_text_{i}\" } for i in range(100) ] # 插入数据 client.insert(collection_name=\"customized_setup_1\", data=data) # 加载集合到内存 client.load_collection(\"customized_setup_1\") # 查看集合统计信息 stats = client.get_collection_stats(\"customized_setup_1\") print(f\"Collection stats: {stats}\") 基础ANN-search\n# 查询向量 query_vector = np.random.random(5).tolist() # 模拟一个随机向量作为查询向量 # 搜索参数 search_params = { \"metric_type\": \"COSINE\", # 与创建索引时保持一致 \"params\": {\"nprobe\": 10} # nprobe 决定搜索范围，值越高精度越高，但速度可能变慢 } # 执行搜索 res = client.search( collection_name=\"customized_setup_1\", anns_field=\"my_vector\", # 指定向量字段 data=[query_vector], # 查询向量 limit=5, # 返回前 5 个结果 search_params=search_params ) # 打印搜索结果 print(\"Search Results:\") for hits in res: for hit in hits: print(hit) 在指定的partition中search\n# 构建partition，将数据插入partition client.create_partition( collection_name=\"customized_setup_1\", partition_name=\"partitionA\" ) res = client.list_partitions( collection_name=\"customized_setup_1\" ) print(res) \"\"\" ['_default', 'partitionA'] \"\"\" data2 = [ { \"my_id\": i, \"my_vector\": np.random.random(5).tolist(), # 生成随机向量 \"my_varchar\": f\"example_text_{i}\" } for i in range(50) ] client.insert(collection_name=\"customized_setup_1\",partition_name=\"partitionA\", data=data2) # 在partition 中查询 res = client.search( collection_name=\"customized_setup_1\", anns_field=\"my_vector\", data=[query_vector], partition_names=[\"partitionA\"], limit=3, search_params=search_params ) print(\"Search Results:\") for hits in res: for hit in hits: print(hit) 通过 output Fields指定输出的内容，在数据插入时，定义了my_vector和my_varchar;(默认只展示id)\n# Use Output Fields res = client.search( collection_name=\"customized_setup_1\", anns_field=\"my_vector\", data=[query_vector], limit=3, search_params=search_params, output_fields=[\"my_vector\",\"my_varchar\"] ) print(\"Search Results:\") for hits in res: for hit in hits: print(hit) \"\"\" Search Results: {'id': 7, 'distance': 0.9791999459266663, 'entity': {'my_vector': [0.7273301482200623, 0.25300344824790955, 0.8510549664497375, 0.6126695871353149, 0.5709182024002075], 'my_varchar': 'example_text_7'}} {'id': 84, 'distance': 0.9768796563148499, 'entity': {'my_vector': [0.6703248620033264, 0.1109713464975357, 0.5905848145484924, 0.372805655002594, 0.4945228397846222], 'my_varchar': 'example_text_84'}} {'id': 27, 'distance': 0.9755662083625793, 'entity': {'my_vector': [0.8758077025413513, 0.13442707061767578, 0.968295156955719, 0.25122591853141785, 0.7256166934967041], 'my_varchar': 'example_text_27'}} \"\"\" Limit and Offset\n这两个参数结合使用时可以实现分页查询\nLimit: 控制搜索结果中返回的实体数量，即返回的 Top-K 结果。\nOffset: 指定从搜索结果中跳过的实体数量，用于实现分页。\n# 第 1 页查询：获取第 1-10 个结果 res_page_1 = client.search( collection_name=\"customized_setup_2\", anns_field=\"my_vector\", data=[query_vector], limit=10, # 每页 10 条 offset=0, # 跳过 0 条 search_params=search_params ) print(\"Page 1 Results:\") for hits in res_page_1: for hit in hits: print(hit) # 第 2 页查询：获取第 11-20 个结果 res_page_2 = client.search( collection_name=\"customized_setup_2\", anns_field=\"my_vector\", data=[query_vector], limit=10, # 每页 10 条 offset=10, # 跳过前 10 条 search_params=search_params ) print(\"Page 2 Results:\") for hits in res_page_2: for hit in hits: print(hit) \"\"\" Page 1 Results: {'id': 7, 'distance': 0.9791999459266663, 'entity': {}} {'id': 84, 'distance': 0.9768796563148499, 'entity': {}} {'id': 27, 'distance': 0.9755662083625793, 'entity': {}} {'id': 28, 'distance': 0.9715055227279663, 'entity': {}} {'id': 38, 'distance': 0.9661443829536438, 'entity': {}} {'id': 40, 'distance': 0.9624771475791931, 'entity': {}} {'id': 93, 'distance': 0.9594350457191467, 'entity': {}} {'id': 0, 'distance': 0.9587700366973877, 'entity': {}} {'id': 73, 'distance': 0.9547507166862488, 'entity': {}} {'id': 32, 'distance': 0.9311172366142273, 'entity': {}} Page 2 Results: {'id': 52, 'distance': 0.9296990036964417, 'entity': {}} {'id': 26, 'distance': 0.9230980277061462, 'entity': {}} {'id': 33, 'distance': 0.922787606716156, 'entity': {}} {'id': 55, 'distance': 0.9211370348930359, 'entity': {}} {'id': 30, 'distance': 0.9198154211044312, 'entity': {}} {'id': 63, 'distance': 0.918975830078125, 'entity': {}} {'id': 3, 'distance': 0.9085606932640076, 'entity': {}} {'id': 37, 'distance': 0.9077025651931763, 'entity': {}} {'id': 67, 'distance': 0.9050586223602295, 'entity': {}} {'id': 4, 'distance': 0.9049072861671448, 'entity': {}} \"\"\" Milvus 中单次搜索结果的返回实体数限制为 16,384。如果需要更多结果，可以通过 Search Iterator 分批处理。\n较大的 offset 值会导致搜索效率下降，因为需要计算和跳过前面部分结果\n进阶ANN Search Filter Search \u0026 Metadata Filtering Filtered Search 是在 ANN 方法的基础上添加过滤条件的搜索模式，结合了元数据的过滤功能，能够缩小检索范围或实现一些复杂逻辑。\n数据准备\nclient = MilvusClient(uri=\"http://localhost:19530\") # 创建 schema schema = client.create_schema( auto_id=False, enable_dynamic_field=True, ) index_params = client.prepare_index_params() # 添加字段到 schema schema.add_field(field_name=\"id\", datatype=DataType.INT64, is_primary=True) schema.add_field(field_name=\"vector\", datatype=DataType.FLOAT_VECTOR, dim=5) schema.add_field(field_name=\"color\", datatype=DataType.VARCHAR, max_length=50) schema.add_field(field_name=\"likes\", datatype=DataType.INT64) index_params.add_index( field_name=\"vector\", index_type=\"AUTOINDEX\", # Automatically choose the best index type metric_type=\"L2\" # Use L2 distance as the metric ) # Add a sort index for the id field index_params.add_index( field_name=\"id\", index_type=\"STL_SORT\" ) collection_name = \"customized_setup_5\" client.create_collection( collection_name=collection_name, schema=schema, index_params=index_params ) # 准备数据 data = [ {\"id\": 0, \"vector\": [0.3580376395471989, -0.6023495712049978, 0.18414012509913835, -0.26286205330961354, 0.9029438446296592], \"color\": \"pink_8682\", \"likes\": 165}, {\"id\": 1, \"vector\": [0.19886812562848388, 0.06023560599112088, 0.6976963061752597, 0.2614474506242501, 0.838729485096104], \"color\": \"red_7025\", \"likes\": 25}, {\"id\": 2, \"vector\": [0.43742130801983836, -0.5597502546264526, 0.6457887650909682, 0.7894058910881185, 0.20785793220625592], \"color\": \"orange_6781\", \"likes\": 764}, {\"id\": 3, \"vector\": [0.3172005263489739, 0.9719044792798428, -0.36981146090600725, -0.4860894583077995, 0.95791889146345], \"color\": \"pink_9298\", \"likes\": 234}, {\"id\": 4, \"vector\": [0.4452349528804562, -0.8757026943054742, 0.8220779437047674, 0.46406290649483184, 0.30337481143159106], \"color\": \"red_4794\", \"likes\": 122}, {\"id\": 5, \"vector\": [0.985825131989184, -0.8144651566660419, 0.6299267002202009, 0.1206906911183383, -0.1446277761879955], \"color\": \"yellow_4222\", \"likes\": 12}, {\"id\": 6, \"vector\": [0.8371977790571115, -0.015764369584852833, -0.31062937026679327, -0.562666951622192, -0.8984947637863987], \"color\": \"red_9392\", \"likes\": 58}, {\"id\": 7, \"vector\": [-0.33445148015177995, -0.2567135004164067, 0.8987539745369246, 0.9402995886420709, 0.5378064918413052], \"color\": \"grey_8510\", \"likes\": 775}, {\"id\": 8, \"vector\": [0.39524717779832685, 0.4000257286739164, -0.5890507376891594, -0.8650502298996872, -0.6140360785406336], \"color\": \"white_9381\", \"likes\": 876}, {\"id\": 9, \"vector\": [0.5718280481994695, 0.24070317428066512, -0.3737913482606834, -0.06726932177492717, -0.6980531615588608], \"color\": \"purple_4976\", \"likes\": 765}, ] # 插入数据 client.insert( collection_name=collection_name, data=data ) # {'insert_count': 10, 'ids': [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], 'cost': 0} filter-search\nres_filtered = client.search( collection_name=collection_name, anns_field=\"vector\", data=[query_vector], limit=5, filter=\"color like 'red%' and likes \u003e 50\", output_fields=[\"color\", \"likes\"] ) for hits in res_filtered: for hit in hits: print(hit) \"\"\" {'id': 4, 'distance': 1.4699335098266602, 'entity': {'color': 'red_4794', 'likes': 122}} {'id': 6, 'distance': 3.989945888519287, 'entity': {'color': 'red_9392', 'likes': 58}} \"\"\" 支持的metadata 过滤方式：\n过滤类型 描述 示例 比较操作符 用于数值比较 filter=\"price \u003e 500\" - \u003e：大于 filter=\"inventory['quantity'] \u003e= 250\" - \u003c：小于 filter=\"sales_volume[0] \u003c 100\" - ==：等于 filter=\"color == 'red_7025'\" - \u003c=：小于等于 filter=\"price \u003c= 900\" - \u003e=：大于等于 filter=\"sales_volume[0] \u003e= 150\" - !=：不等于 filter=\"color != 'yellow_4222'\" Term操作符 精确匹配或排除 filter='color in [\"red_7025\", \"red_4794\"]' - in：匹配指定集合 filter='inventory[\"brand\"] in [\"Apple\"]' - not in：排除指定集合 filter='color not in [\"yellow_4222\", \"grey_8510\"]' Match操作符 字符串匹配 filter='color like \"red%\"' - like：通配符匹配 filter='inventory[\"brand\"] like \"S%\"' - TEXT_MATCH：文本高效匹配 filter='TEXT_MATCH(description, \"Apple iPhone\")' 算术操作符 数值计算 filter=\"price * 0.5 \u003c 300\" - +：加 filter=\"sales_volume[0] + 50 \u003e 200\" - -：减 filter=\"price - 100 \u003e 500\" - *：乘 filter=\"price * 2 \u003e 1000\" - /：除 filter=\"inventory['quantity'] / 2 \u003e 100\" - **：幂运算 filter=\"price ** 2 \u003e 250000\" - %：取余 filter=\"price % 100 == 0\" JSON操作符 用于JSON字段的高级过滤 filter='JSON_CONTAINS(inventory[\"previous_sales\"], 232)' - JSON_CONTAINS：包含指定元素 filter='JSON_CONTAINS_ALL(inventory[\"previous_sales\"], [232, 254])' - JSON_CONTAINS_ALL：包含所有指定元素 filter='JSON_CONTAINS_ANY(inventory[\"previous_sales\"], [232, 275])' - JSON_CONTAINS_ANY：包含任一元素 Array操作符 用于数组字段的高级过滤 filter='ARRAY_CONTAINS(sales_volume, 150)' - ARRAY_CONTAINS：包含指定元素 filter='ARRAY_CONTAINS_ALL(sales_volume, [150, 150])' - ARRAY_CONTAINS_ALL：包含所有指定元素 filter='ARRAY_CONTAINS_ANY(sales_volume, [150, 190])' - ARRAY_CONTAINS_ANY：包含任一指定元素 - ARRAY_LENGTH：检查数组长度 filter='ARRAY_LENGTH(sales_volume) == 3' 逻辑操作符 组合多个过滤条件 filter='color like \"red%\" and price \u003c 500' - and 或 \u0026\u0026：所有条件均需满足 filter='price \u003c 500 and sales_volume[0] \u003e 100' - or 或 ` - not：逻辑非 filter='not (price \u003e 500)' 复杂表达式 通过括号调整优先级 filter='(price \u003e 500 and inventory[\"brand\"] in [\"Apple\"]) or color == \"red_7025\"' Range search 通过设置一个范围（半径或区间），筛选出符合距离/相似度范围的向量\n执行范围搜索请求时，Milvus 以 ANN 搜索结果中与查询向量最相似的向量为圆心，以搜索请求中指定的半径为外圈半径，以range_filter为内圈半径，画出两个同心圆。所有相似度得分在这两个同心圆形成的环形区域内的向量都将被返回\n可能的使用场景：\n相似度过滤：返回与查询向量相似度在指定范围内的项\n异常检测：查找距离远离中心点的异常点\n推荐系统： 避免过高相似度（可能是重复内容）或过低相似度（相关性不强）的结果\nMetric Type 距离范围 L2 range_filter \u003c= 距离 \u003c radius IP radius \u003c 距离 \u003c= range_filter COSINE radius \u003c 距离 \u003c= range_filter JACCARD range_filter \u003c= 距离 \u003c radius HAMMING range_filter \u003c= 距离 \u003c radius query_vector = [0.5580376395471989, -0.8023495712049978, 0.38414012509913835, -0.36286205330961354, 0.9029438446296591] # metric_type=\"L2\" res = client.search( collection_name=collection_name, data=[query_vector], limit=10, search_params={ \"params\": { \"radius\": 0.9, \"range_filter\": 0.1 } } ) for hits in res: for hit in hits: print(hit) \"\"\" {'id': 0, 'distance': 0.12999999523162842, 'entity': {}} \"\"\" Grouping Search 将搜索结果根据某些属性或特征分组（group）\n搜索结果中，基于特定字段或条件，将相似或具有共同特征的记录聚合在一起\n举个具体的例子，在 RAG（Retrieval-Augmented Generation）任务中，我们通常会将文档拆分成一定大小的文本块（chunks），以便在检索过程中实现更精准的语义匹配。然而，在生成回答时，我们并不总是局限于直接使用召回的这些文本块，而是希望尽可能覆盖更多的文档或是包含更多的文档上下文。因为检索阶段可能会从同一文档中召回多个文本块，而忽略其他文档的内容，从而导致搜索结果的多样性降低，影响答案的全面性和准确性。\n数据准备\nclient = MilvusClient(uri=\"http://localhost:19530\") # 创建 schema schema = client.create_schema( auto_id=False, enable_dynamic_field=True, ) index_params = client.prepare_index_params() # 添加字段到 schema schema.add_field(field_name=\"id\", datatype=DataType.INT64, is_primary=True) schema.add_field(field_name=\"vector\", datatype=DataType.FLOAT_VECTOR, dim=5) schema.add_field(field_name=\"chunk\", datatype=DataType.VARCHAR, max_length=50) schema.add_field(field_name=\"docId\", datatype=DataType.INT64) index_params.add_index( field_name=\"vector\", index_type=\"AUTOINDEX\", # Automatically choose the best index type metric_type=\"L2\" # Use L2 distance as the metric ) # Add a sort index for the id field index_params.add_index( field_name=\"id\", index_type=\"STL_SORT\" ) collection_name = \"group_search_collection\" client.create_collection( collection_name=collection_name, schema=schema, index_params=index_params ) data = [ {\"id\": 0, \"vector\": [0.3580376395471989, -0.6023495712049978, 0.18414012509913835, -0.26286205330961354, 0.9029438446296592], \"chunk\": \"pink_8682\", \"docId\": 1}, {\"id\": 1, \"vector\": [0.19886812562848388, 0.06023560599112088, 0.6976963061752597, 0.2614474506242501, 0.838729485096104], \"chunk\": \"red_7025\", \"docId\": 5}, {\"id\": 2, \"vector\": [0.43742130801983836, -0.5597502546264526, 0.6457887650909682, 0.7894058910881185, 0.20785793220625592], \"chunk\": \"orange_6781\", \"docId\": 2}, {\"id\": 3, \"vector\": [0.3172005263489739, 0.9719044792798428, -0.36981146090600725, -0.4860894583077995, 0.95791889146345], \"chunk\": \"pink_9298\", \"docId\": 3}, {\"id\": 4, \"vector\": [0.4452349528804562, -0.8757026943054742, 0.8220779437047674, 0.46406290649483184, 0.30337481143159106], \"chunk\": \"red_4794\", \"docId\": 3}, {\"id\": 5, \"vector\": [0.985825131989184, -0.8144651566660419, 0.6299267002202009, 0.1206906911183383, -0.1446277761879955], \"chunk\": \"yellow_4222\", \"docId\": 4}, {\"id\": 6, \"vector\": [0.8371977790571115, -0.015764369584852833, -0.31062937026679327, -0.562666951622192, -0.8984947637863987], \"chunk\": \"red_9392\", \"docId\": 1}, {\"id\": 7, \"vector\": [-0.33445148015177995, -0.2567135004164067, 0.8987539745369246, 0.9402995886420709, 0.5378064918413052], \"chunk\": \"grey_8510\", \"docId\": 2}, {\"id\": 8, \"vector\": [0.39524717779832685, 0.4000257286739164, -0.5890507376891594, -0.8650502298996872, -0.6140360785406336], \"chunk\": \"white_9381\", \"docId\": 5}, {\"id\": 9, \"vector\": [0.5718280481994695, 0.24070317428066512, -0.3737913482606834, -0.06726932177492717, -0.6980531615588608], \"chunk\": \"purple_4976\", \"docId\": 3}, ] client.insert( collection_name=collection_name, data=data ) 查询\nquery_vectors = [ [0.14529211512077012, 0.9147257273453546, 0.7965055218724449, 0.7009258593102812, 0.5605206522382088]] # Group search results res = client.search( collection_name=collection_name, data=query_vectors, limit=3, group_by_field=\"docId\", output_fields=[\"docId\"] ) # Retrieve the values in the `docId` column doc_ids = [result['entity']['docId'] for result in res[0]] doc_ids # [5, 2, 3] 只返回top-3的doc结果\ngroup_by_field： 指定进行分组的字段名称\nstrict_group_size： 每组返回的结果数量。默认情况下，每组只返回一个最相似的实体\nstrict_group_size： 是否严格限制每组的返回结果数量。设置为 True 时，系统会尝试保证每组返回的实体数量与 group_size 参数一致。如果某组数据不足，则可能影响查询性能。默认值为 False。\nHybrid Search 允许在一个collection中对多个向量字段（例如稠密向量和稀疏向量）同时进行搜索，并将不同搜索结果重新排序为单一结果集。\nHybrid Search refers to a search method that conducts multiple ANN searches simultaneously, reranks multiple sets of results from these ANN searches, and ultimately returns a single set of results. 主要工作流程\n生成密集向量（Dense Vectors）：通过嵌入模型（如 BERT 和 Transformers）生成密\n生成稀疏向量（Sparse Vectors）：通过嵌入模型（如 BM25、BGE-M3、SPLADE 等）生成稀疏向量。\n创建集合（Collection）：创建集合，并定义包含密集和稀疏向量字段的集合 Schema。\n插入数据：将稀疏和密集向量插入到创建的集合中。\n执行混合搜索：\n对密集向量执行 ANN 搜索，返回一组最相似的 Top-K 结果。\n对稀疏向量执行文本匹配搜索，也返回一组 Top-K 结果。\n得分归一化（Normalization）：将两组 Top-K 结果的得分归一化到 [0,1] 的范围。\n融合与重排序：选择合适的重排序策略，将两组 Top-K 结果合并并重新排序，最终返回一组综合的 Top-K 结果。\nfrom pymilvus import ( MilvusClient, DataType ) client = MilvusClient( uri=\"http://localhost:19530\" ) schema = MilvusClient.create_schema( auto_id=False, enable_dynamic_field=True, ) schema.add_field(field_name=\"id\", datatype=DataType.INT64, is_primary=True) schema.add_field(field_name=\"text\", datatype=DataType.VARCHAR, max_length=1000) schema.add_field(field_name=\"sparse\", datatype=DataType.SPARSE_FLOAT_VECTOR) schema.add_field(field_name=\"dense\", datatype=DataType.FLOAT_VECTOR, dim=5) index_params = client.prepare_index_params() index_params.add_index( field_name=\"dense\", index_name=\"dense_index\", index_type=\"IVF_FLAT\", metric_type=\"IP\", params={\"nlist\": 128}, ) index_params.add_index( field_name=\"sparse\", index_name=\"sparse_index\", index_type=\"SPARSE_INVERTED_INDEX\", # Index type for sparse vectors metric_type=\"IP\", # Currently, only IP (Inner Product) is supported for sparse vectors params={\"drop_ratio_build\": 0.2}, # The ratio of small vector values to be dropped during indexing ) client.create_collection( collection_name=\"hybrid_search_collection\", schema=schema, index_params=index_params ) 数据插入\n# 插入数据 import random # 随机生成稠密向量 def generate_random_dense_vector(dim): return [random.uniform(-1, 1) for _ in range(dim)] # 随机生成稀疏向量 def generate_random_sparse_vector(max_dim, num_non_zero): indices = random.sample(range(max_dim), num_non_zero) values = [random.uniform(0, 1) for _ in range(num_non_zero)] return {idx: val for idx, val in zip(indices, values)} # 数据 data = [ { \"id\": 0, \"text\": \"Artificial intelligence was founded as an academic discipline in 1956.\", \"sparse\": generate_random_sparse_vector(10000, 5), # 稀疏向量 \"dense\": generate_random_dense_vector(5) # 稠密向量 }, { \"id\": 1, \"text\": \"Alan Turing was the first person to conduct substantial research in AI.\", \"sparse\": generate_random_sparse_vector(10000, 5), \"dense\": generate_random_dense_vector(5) }, { \"id\": 2, \"text\": \"Born in Maida Vale, London, Turing was raised in southern England.\", \"sparse\": generate_random_sparse_vector(10000, 5), \"dense\": generate_random_dense_vector(5) }, ] # 插入数据 res = client.insert( collection_name=\"hybrid_search_collection\", data=data ) 混合搜索是通过在**hybrid_search()** 函数中创建多个**AnnSearchRequest** 来实现的，其中每个**AnnSearchRequest** 代表一个特定向量场的基本 ANN 搜索请求。\n在混合搜索中，每个**AnnSearchRequest** 只支持一个查询向量。\nfrom pymilvus import AnnSearchRequest query_dense_vector = [0.3580376395471989, -0.6023495712049978, 0.18414012509913835, -0.26286205330961354, 0.9029438446296592] search_param_1 = { \"data\": [query_dense_vector], \"anns_field\": \"dense\", \"param\": { \"metric_type\": \"IP\", \"params\": {\"nprobe\": 10} }, \"limit\": 2 } request_1 = AnnSearchRequest(**search_param_1) query_sparse_vector = {1609: 0.6255744191385809, 7058: 0.20234890590382482, 449: 0.01787891574781786, 9702: 0.710732808143222, 8827: 0.3979309078494506} search_param_2 = { \"data\": [query_sparse_vector], \"anns_field\": \"sparse\", \"param\": { \"metric_type\": \"IP\", \"params\": {\"drop_ratio_build\": 0.2} }, \"limit\": 2 } request_2 = AnnSearchRequest(**search_param_2) reqs = [request_1, request_2] 采用加权排名\nfrom pymilvus import WeightedRanker ranker= WeightedRanker(0.8, 0.3) res = client.hybrid_search( collection_name=\"hybrid_search_collection\", reqs=reqs, ranker=ranker, limit=2 ) for hits in res: print(\"TopK results:\") for hit in hits: print(hit) \"\"\" TopK results: {'id': 1, 'distance': 0.5914705991744995, 'entity': {}} {'id': 0, 'distance': 0.27949291467666626, 'entity': {}} \"\"\" 采用RRF（Reciprocal Rank Fusion） ranker\nfrom pymilvus import RRFRanker # Default k value is 60 ranker = RRFRanker(k=100) res = client.hybrid_search( collection_name=\"hybrid_search_collection\", reqs=reqs, ranker=ranker, limit=2 ) for hits in res: print(\"TopK results:\") for hit in hits: print(hit) \"\"\" TopK results: {'id': 1, 'distance': 0.009900989942252636, 'entity': {}} {'id': 0, 'distance': 0.009803921915590763, 'entity': {}} \"\"\" Full Text Search Milvus 在 2.5 版本中引入了全文检索， 能够基于关键字或短语高效地搜索文本数据。\n全文检索功能在 Milvus Standalone 和 Milvus Distributed 中可用，但在 Milvus Lite 中不可用\n步骤：\n文本输入：用户直接插入原始文本数据，无需手动生成向量嵌入。\n文本分析：Milvus 使用内置的分析器将输入文本分解为可搜索的词条。\n函数处理：内置函数接收已分词的词条，并将其转换为稀疏向量表示。\n集合存储：Milvus 将这些稀疏嵌入存储在集合（Collection）中，以便高效检索。\nBM25 评分：在检索时，Milvus 应用 BM25 算法计算查询文本和存储文档的相关性得分，并对匹配结果进行排序\n创建 Schema\nfrom pymilvus import MilvusClient, DataType, Function, FunctionType client = MilvusClient(uri=\"http://localhost:19530\") schema = client.create_schema() schema.add_field(field_name=\"id\", datatype=DataType.INT64, is_primary=True, auto_id=True) schema.add_field(field_name=\"text\", datatype=DataType.VARCHAR, max_length=1000, enable_analyzer=True) schema.add_field(field_name=\"sparse\", datatype=DataType.SPARSE_FLOAT_VECTOR) SPARSE_FLOAT_VECTOR 字段，预留用于存储稀疏嵌入\n定义一个将文本转换为稀疏向量表示的函数，然后将其添加到 Schema 中\nbm25_function = Function( name=\"text_bm25_emb\", # Function name input_field_names=[\"text\"], # Name of the VARCHAR field containing raw text data output_field_names=[\"sparse\"], # Name of the SPARSE_FLOAT_VECTOR field reserved to store generated embeddings function_type=FunctionType.BM25, ) schema.add_function(bm25_function) 设置索引 create collection\nindex_params = client.prepare_index_params() index_params.add_index( field_name=\"sparse\", index_type=\"AUTOINDEX\", metric_type=\"BM25\" ) client.create_collection( collection_name='demo', schema=schema, index_params=index_params ) 插入数据\nclient.insert('demo', [ {'text': 'information retrieval is a field of study.'}, {'text': 'information retrieval focuses on finding relevant information in large datasets.'}, {'text': 'data mining and information retrieval overlap in research.'}, ]) 执行全文查询\nsearch_params = { 'params': {'drop_ratio_search': 0.2}, } res = client.search( collection_name='demo', data=['whats the focus of information retrieval?'], anns_field='sparse', limit=2, search_params=search_params, output_fields=[\"text\"] ) for hits in res: print(\"TopK results:\") for hit in hits: print(hit) \"\"\" TopK results: {'id': 454187296102665084, 'distance': 1.3352930545806885, 'entity': {'text': 'information retrieval is a field of study.'}} {'id': 454187296102665085, 'distance': 0.29726022481918335, 'entity': {'text': 'information retrieval focuses on finding relevant information in large datasets.'}} \"\"\" Query Milvus 还支持通过查询进行元数据过滤，即类似于关系型数据库的数据查询和过滤\nGet 查询： 用于通过主键（Primary Key）精确查找实体\nQuery 查询： 通过自定义过滤表达式查找满足条件的实体\nQueryIterator 查询迭代器： 用于在分页查询中，通过自定义过滤条件遍历满足条件的所有实体 （by-batch查找）\nget\nfrom pymilvus import MilvusClient client = MilvusClient( uri=\"http://localhost:19530\" ) res = client.get( collection_name=\"query_collection\", ids=[0, 1, 2], output_fields=[\"vector\", \"color\"] ) print(res) \"\"\" data: [\"{'vector': [0.35803765, -0.6023496, 0.18414013, -0.26286206, 0.90294385], 'color': 'pink_8682', 'id': 0}\", \"{'vector': [0.19886813, 0.060235605, 0.6976963, 0.26144746, 0.8387295], 'color': 'red_7025', 'id': 1}\", \"{'vector': [0.43742132, -0.55975026, 0.6457888, 0.7894059, 0.20785794], 'color': 'orange_6781', 'id': 2}\"] \"\"\" query\nres = client.query( collection_name=\"query_collection\", filter=\"color like \\\"red%\\\"\", output_fields=[\"vector\", \"color\"], limit=3 ) print(res) \"\"\" data: [\"{'id': 1, 'vector': [0.19886813, 0.060235605, 0.6976963, 0.26144746, 0.8387295], 'color': 'red_7025'}\", \"{'id': 4, 'vector': [0.44523495, -0.8757027, 0.82207793, 0.4640629, 0.3033748], 'color': 'red_4794'}\", \"{'id': 6, 'vector': [0.8371978, -0.015764369, -0.31062937, -0.56266695, -0.8984948], 'color': 'red_9392'}\"] \"\"\" QueryIterator\nfrom pymilvus import connections, Collection connections.connect( uri=\"http://localhost:19530\", ) collection = Collection(\"query_collection\") iterator = collection.query_iterator( batch_size=10, expr=\"color like \\\"red%\\\"\", output_fields=[\"color\"] ) results = [] while True: result = iterator.next() if not result: iterator.close() break print(result) results += result \"\"\" [{'color': 'red_7025', 'id': 1}, {'color': 'red_4794', 'id': 4}, {'color': 'red_9392', 'id': 6}] \"\"\" Partition-Key 在 Milvus 中，partition-key（分区键）是一种基于特定标量字段的搜索优化方案。通过将某个字段指定为分区键，Milvus 会根据该字段的值将数据自动分配到不同的分区中，与手动管理分区不同，使用分区键可以克服集合中分区数量的限制（最多 1,024 个）。\n将数据分布到独立的分区中，同时支持对分区范围的查询限定，从而实现数据隔离，可以有效避免对非目标分区的数据进行查询操作。\n自动管理分区 vs 手动创建和指定分区\n特性 partition-key 手动分区 分区管理 自动生成，动态分区 必须手动创建，分区结构固定 分区数量限制 无理论限制，分区数量随字段值动态变化 最多 1,024 个分区 便捷性 插入和查询都更加自动化 插入和查询需要手动指定分区名称 适用场景 动态、多分区场景，如用户 ID、类别分类 静态、少量分区场景，如地理区域划分 Partition-key vs Meta-data Filtering\n特性 partition-key Meta-data Filtering 存储方式 数据物理隔离，按分区键存储 数据逻辑统一，存储在一个集合中 查询效率 通过分区键快速定位目标分区，效率高 全局扫描，效率较低 管理复杂性 自动管理，无需显式定义或维护分区 无需预定义分区，依赖查询时的过滤 动态性 分区结构相对稳定，适合分区逻辑较简单场景 更灵活，适合复杂和多变的查询条件 有无分区差异\n通过partition-key 实现数据隔离查询的简单例子；\n在这个例子中，每一个user只有查询自己数据的权限，当user选择将数据公开share，此时partition-key会被改成public，作为单独的partition存在，从而实现数据隔离查询。\n数据准备：\nfrom pymilvus import MilvusClient, DataType, Function, FunctionType client = MilvusClient(uri=\"http://localhost:19530\") schema = client.create_schema() index_params = client.prepare_index_params() schema.add_field(field_name=\"id\", datatype=DataType.INT64, is_primary=True, auto_id=True) schema.add_field(field_name=\"partition_key\", datatype=DataType.VARCHAR, max_length=512, is_partition_key=True,description=\"Partition key for data isolation\"), schema.add_field(field_name=\"data_id\", datatype=DataType.VARCHAR, max_length=128, description=\"Unique data identifier\"), schema.add_field(field_name=\"vector\", datatype=DataType.FLOAT_VECTOR, dim=128, description=\"Vector representation\"), schema.add_field(field_name=\"metadata\", datatype=DataType.JSON, description=\"Additional filtering metadata\"), index_params.add_index( field_name=\"vector\", index_type=\"AUTOINDEX\", # Automatically choose the best index type metric_type=\"L2\" # Use L2 distance as the metric ) # Add a sort index for the id field index_params.add_index( field_name=\"id\", index_type=\"STL_SORT\" ) client.create_collection( collection_name=\"partitionkey_collection\", schema=schema, index_params=index_params, num_partitions=1024 ) 构造一些假数据\nimport json def generate_test_data(num_records, num_users, public_probability=0.2): \"\"\" 生成测试数据，支持一定概率生成公共数据。 Args: num_records (int): 数据总数 num_users (int): 用户数量 public_probability (float): 生成公共数据的概率 (0.0 到 1.0) Returns: list: 生成的测试数据，每条数据为一个字典 \"\"\" data = [] for _ in range(num_records): # 根据概率选择 partition_key 为 \"public\" 或随机用户 ID if random.random() \u003c public_probability: partition_key = \"public\" else: partition_key = f\"user_{random.randint(1, num_users)}\" record = { \"partition_key\": partition_key, # 设置分区键 \"data_id\": f\"data_{random.randint(1000, 9999)}\", # 随机生成数据 ID \"vector\": [random.uniform(0, 1) for _ in range(128)], # 随机生成128维向量 \"metadata\": json.dumps({ \"category\": random.choice([\"image\", \"text\", \"video\"]), \"tags\": [random.choice([\"AI\", \"ML\", \"NLP\", \"CV\"]) for _ in range(2)], \"rating\": random.uniform(1, 5), }) } data.append(record) return data data = generate_test_data(500,20) client.insert( collection_name=\"partitionkey_collection\", data=data ) 仅查询user_10 的数据\nquery_result = client.query( collection_name = \"partitionkey_collection\", filter='partition_key == \"user_10\"', output_fields=[\"data_id\", \"partition_key\"] ) print(query_result) \"\"\" data: [\"{'data_id': 'data_7887', 'partition_key': 'user_10', 'id': 454187296102665088}\", \"{'data_id': 'data_9004', 'partition_key': 'user_10', 'id': 454187296102665090}\", \"{'data_id': 'data_8970', 'partition_key': 'user_10', 'id': 454187296102665092}\", \"{'data_id': 'data_2031', 'partition_key': 'user_10', 'id': 454187296102665098}\", \"{'data_id': 'data_6972', 'partition_key': 'user_10', 'id': 454187296102665111}\", \"{'data_id': 'data_3463', 'partition_key': 'user_10', 'id': 454187296102665118}\", \"{'data_id': 'data_9998', 'partition_key': 'user_10', 'id': 454187296102665123}\", \"{'data_id': 'data_5411', 'partition_key': 'user_10', 'id': 454187296102665133}\", \"{'data_id': 'data_9952', 'partition_key': 'user_10', 'id': 454187296102665205}\", \"{'data_id': 'data_9002', 'partition_key': 'user_10', 'id': 454187296102665257}\"] ... \"\"\" user_10 所能ANN搜索的内容（ppublicand user_10)\nquery_vectors = [random.uniform(0, 1) for _ in range(128)] res = client.search( collection_name = \"partitionkey_collection\", data=[query_vectors], filter='partition_key in [\"public\",\"user_10\"]', output_fields=[\"data_id\", \"partition_key\"] ) for hits in res: for hit in hits: print(hit) \"\"\" {'id': 454187296102665637, 'distance': 15.168614387512207, 'entity': {'partition_key': 'public', 'data_id': 'data_9024'}} {'id': 454187296102665532, 'distance': 15.173531532287598, 'entity': {'partition_key': 'user_10', 'data_id': 'data_8461'}} {'id': 454187296102665598, 'distance': 15.250306129455566, 'entity': {'partition_key': 'user_10', 'data_id': 'data_7539'}} {'id': 454187296102665323, 'distance': 15.833619117736816, 'entity': {'partition_key': 'user_10', 'data_id': 'data_8433'}} {'id': 454187296102665234, 'distance': 16.50188446044922, 'entity': {'partition_key': 'public', 'data_id': 'data_1534'}} {'id': 454187296102665501, 'distance': 16.521953582763672, 'entity': {'partition_key': 'public', 'data_id': 'data_9944'}} {'id': 454187296102665463, 'distance': 16.524085998535156, 'entity': {'partition_key': 'public', 'data_id': 'data_6430'}} {'id': 454187296102665453, 'distance': 16.64727020263672, 'entity': {'partition_key': 'public', 'data_id': 'data_8403'}} {'id': 454187296102665629, 'distance': 16.649581909179688, 'entity': {'partition_key': 'public', 'data_id': 'data_5141'}} {'id': 454187296102665631, 'distance': 16.809789657592773, 'entity': {'partition_key': 'public', 'data_id': 'data_3505'}} \"\"\" Models 在2.4 版本之后支持了对于embedding模型和reranking模型的集成。\n个人认为没有太大必要。\n图形化界面 之前使用的是milvus-insight，不过不再维护了。\n官方主推的是attu。\n一些踩坑点 （待更新）\n参考 官方文档\n",
  "wordCount" : "3163",
  "inLanguage": "en",
  "image": "https://niraya666.github.io/images/papermod-cover.png","datePublished": "2024-12-25T15:49:00+08:00",
  "dateModified": "2024-12-25T15:49:00+08:00",
  "author":{
    "@type": "Person",
    "name": "Theme PaperMod"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://niraya666.github.io/posts/milvus-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E5%92%8C%E5%A4%87%E5%BF%98%E5%BD%95%E4%BB%8E2.0-%E5%88%B02.5%E7%89%88%E6%9C%AC%E7%9A%84%E4%BB%8E%E5%A4%B4%E5%AD%A6%E4%B9%A0/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "LZY Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://niraya666.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://niraya666.github.io/" accesskey="h" title="LZY Blog (Alt + H)">LZY Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://niraya666.github.io/archives" title="Archive">
                    <span>Archive</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/about/" title="About">
                    <span>About</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/musik/" title="musik!">
                    <span>musik!</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/search/" title="Search (Alt &#43; /)" accesskey=/>
                    <span>Search</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/tags/" title="Tags">
                    <span>Tags</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/monthly/" title="月刊">
                    <span>月刊</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/essay/" title="杂文">
                    <span>杂文</span>
                </a>
            </li>
            <li>
                <a href="https://niraya666.github.io/travel/" title="游记">
                    <span>游记</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://niraya666.github.io/">Home</a>&nbsp;»&nbsp;<a href="https://niraya666.github.io/posts/">Posts</a></div>
    <h1 class="post-title entry-hint-parent">
      Milvus-2.5版本：学习笔记和备忘录
      <span class="entry-hint" title="Draft">
        <svg xmlns="http://www.w3.org/2000/svg" height="35" viewBox="0 -960 960 960" fill="currentColor">
          <path
            d="M160-410v-60h300v60H160Zm0-165v-60h470v60H160Zm0-165v-60h470v60H160Zm360 580v-123l221-220q9-9 20-13t22-4q12 0 23 4.5t20 13.5l37 37q9 9 13 20t4 22q0 11-4.5 22.5T862.09-380L643-160H520Zm300-263-37-37 37 37ZM580-220h38l121-122-18-19-19-18-122 121v38Zm141-141-19-18 37 37-18-19Z" />
        </svg>
      </span>
    </h1>
    <div class="post-meta"><span title='2024-12-25 15:49:00 +0800 CST'>December 25, 2024</span>&nbsp;·&nbsp;15 min&nbsp;·&nbsp;Theme PaperMod

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#%e4%b8%80%e4%ba%9b%e6%a6%82%e5%bf%b5" aria-label="一些概念">一些概念</a><ul>
                        
                <li>
                    <a href="#collections-schema-and-index" aria-label="Collections, Schema and index">Collections, Schema and index</a></li>
                <li>
                    <a href="#milvusclient-vs-connection" aria-label="MilvusClient vs Connection">MilvusClient vs Connection</a></li>
                <li>
                    <a href="#schema" aria-label="Schema">Schema</a></li>
                <li>
                    <a href="#index" aria-label="Index">Index</a></li>
                <li>
                    <a href="#analyzer" aria-label="Analyzer">Analyzer</a></li></ul>
                </li>
                <li>
                    <a href="#ann-search-in-milvus" aria-label="ANN Search in Milvus">ANN Search in Milvus</a></li>
                <li>
                    <a href="#%e8%bf%9b%e9%98%b6ann-search" aria-label="进阶ANN Search">进阶ANN Search</a><ul>
                        
                <li>
                    <a href="#filter-search--metadata-filtering" aria-label="Filter Search &amp; Metadata Filtering">Filter Search &amp; Metadata Filtering</a></li>
                <li>
                    <a href="#range-search" aria-label="Range search">Range search</a></li>
                <li>
                    <a href="#grouping-search" aria-label="Grouping Search">Grouping Search</a></li>
                <li>
                    <a href="#hybrid-search" aria-label="Hybrid Search">Hybrid Search</a></li>
                <li>
                    <a href="#full-text-search" aria-label="Full Text Search">Full Text Search</a></li></ul>
                </li>
                <li>
                    <a href="#query" aria-label="Query">Query</a></li>
                <li>
                    <a href="#partition-key" aria-label="Partition-Key">Partition-Key</a></li>
                <li>
                    <a href="#models" aria-label="Models">Models</a></li>
                <li>
                    <a href="#%e5%9b%be%e5%bd%a2%e5%8c%96%e7%95%8c%e9%9d%a2" aria-label="图形化界面">图形化界面</a></li>
                <li>
                    <a href="#%e4%b8%80%e4%ba%9b%e8%b8%a9%e5%9d%91%e7%82%b9" aria-label="一些踩坑点">一些踩坑点</a></li>
                <li>
                    <a href="#%e5%8f%82%e8%80%83" aria-label="参考">参考</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><p>几年前初识 Milvus 的契机，来源于开发一个图像相似检索的应用，当时市面上向量库的可选择项并不像现在这么多，且功能也仅限于单纯的向量检索。</p>
<p>鉴于最近有业务更新的需要，和打算重构一下之前做的RAG项目，再次有机会深入学习 Milvus，探索其在新功能和实际应用上的更多可能性。</p>
<p>本篇笔记，仅作为学习笔记，更多是记录一些 Milvus从2.0 到2.5 的变化， 和一些动手实践的记录，便于之后的查阅。</p>
<h2 id="一些概念">一些概念<a hidden class="anchor" aria-hidden="true" href="#一些概念">#</a></h2>
<h3 id="collections-schema-and-index">Collections, Schema and index<a hidden class="anchor" aria-hidden="true" href="#collections-schema-and-index">#</a></h3>
<p><strong>Collection</strong>是Milvus中的一个二维表格，具有固定的列和可变的行。每一列代表一个字段(field)，每一行代表一个实体(entity)</p>
<p><strong>Schema和字段</strong> Collection需要一个schema来定义其结构</p>
<p><strong>索引</strong> 在特定字段上创建索引可以提高搜索效率。建议为服务所依赖的所有字段创建索引，其中向量字段的索引是必需的。</p>
<p><strong>分区(Partition)</strong> 分区是Collection的子集，与其父Collection共享相同的字段集</p>
<p><strong>分片(Shard)</strong> 分片是Collection的水平切片。每个分片对应一个数据输入通道。</p>
<p><strong>Shard vs Partition的区别</strong> :</p>
<ul>
<li>
<p>分区(Partition)的作用是通过指定分区名称来减少读取负载</p>
</li>
<li>
<p>而分片(Shard)的作用是将写入负载分散到多个服务器<strong>分布式架构中的应用</strong> 在分布式系统中，分片是实现水平扩展的重要机制。通过将数据分布到多个节点，可以充分利用集群的并行计算潜力，提高系统的写入性能</p>
</li>
</ul>
<h3 id="milvusclient-vs-connection"><strong>MilvusClient vs Connection</strong><a hidden class="anchor" aria-hidden="true" href="#milvusclient-vs-connection">#</a></h3>
<p><strong>MilvusClient</strong></p>
<p><strong>定位</strong>：更高级封装，提供一体化的操作接口。简化了与 Milvus 的交互流程， 提供更直观和结构化的操作方式，便于新手快速上手，内置了对连接的管理和操作，减少手动处理的复杂性。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">MilvusClient</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建客户端并连接到 Milvus</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建集合</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s2">&#34;example_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;fields&#34;</span><span class="p">:</span> <span class="p">[{</span><span class="s2">&#34;name&#34;</span><span class="p">:</span> <span class="s2">&#34;vector&#34;</span><span class="p">,</span> <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;FLOAT_VECTOR&#34;</span><span class="p">,</span> <span class="s2">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;dim&#34;</span><span class="p">:</span> <span class="mi">128</span><span class="p">}}]}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 插入数据</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s2">&#34;example_collection&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[[</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span><span class="p">]})</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 搜索</span>
</span></span><span class="line"><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&#34;example_collection&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="p">[[</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span><span class="p">])</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></span></code></pre></div><p><strong>Connection</strong></p>
<p><strong>定位</strong>：基础连接操作，需要通过 connect 方法创建并维护连接。提供更底层的控制，适合灵活、自定义的操作。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">connections</span><span class="p">,</span> <span class="n">Collection</span><span class="p">,</span> <span class="n">FieldSchema</span><span class="p">,</span> <span class="n">CollectionSchema</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建连接</span>
</span></span><span class="line"><span class="cl"><span class="n">connections</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">alias</span><span class="o">=</span><span class="s2">&#34;default&#34;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s2">&#34;localhost&#34;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="s2">&#34;19530&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建集合</span>
</span></span><span class="line"><span class="cl"><span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="n">FieldSchema</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&#34;FLOAT_VECTOR&#34;</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span> <span class="o">=</span> <span class="n">CollectionSchema</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&#34;example collection&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">collection</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&#34;example_collection&#34;</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 插入数据</span>
</span></span><span class="line"><span class="cl"><span class="n">collection</span><span class="o">.</span><span class="n">insert</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 搜索</span>
</span></span><span class="line"><span class="cl"><span class="n">collection</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">search</span><span class="p">([[</span><span class="mf">0.1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">128</span><span class="p">],</span> <span class="n">anns_field</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
</span></span></code></pre></div><h3 id="schema"><strong>Schema</strong><a hidden class="anchor" aria-hidden="true" href="#schema">#</a></h3>
<p><strong>Schema</strong> 用于定义collection及其字段的属性</p>
<p>设定 <strong>Schema</strong> 的目的是为了定义数据的逻辑结构和存储规则。Schema 是集合（Collection）和字段（Field）的元数据定义，它决定了如何存储和管理数据，同时保证数据操作的一致性、灵活性和高效性。</p>
<p>字段属性（Field Properties）</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">属性名称</th>
          <th style="text-align: left">描述</th>
          <th style="text-align: left">注意事项</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong><code>name</code></strong></td>
          <td style="text-align: left">字段名称</td>
          <td style="text-align: left">必须字段，类型为字符串。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>dtype</code></strong></td>
          <td style="text-align: left">字段的数据类型</td>
          <td style="text-align: left">必须字段。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>description</code></strong></td>
          <td style="text-align: left">字段的描述</td>
          <td style="text-align: left">可选字段，类型为字符串。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>is_primary</code></strong></td>
          <td style="text-align: left">是否将字段设为主键</td>
          <td style="text-align: left">类型为布尔值（<code>true</code> 或 <code>false</code>），主键字段必须指定。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>auto_id</code></strong></td>
          <td style="text-align: left">是否启用自动 ID 分配</td>
          <td style="text-align: left">必须为主键字段设置，类型为布尔值。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>max_length</code></strong></td>
          <td style="text-align: left"><code>VARCHAR</code> 字段的最大长度（以字节为单位）</td>
          <td style="text-align: left">必须为 <code>VARCHAR</code> 字段指定，范围为 [1, 65,535]。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>dim</code></strong></td>
          <td style="text-align: left">向量的维度</td>
          <td style="text-align: left">对于稠密向量字段，必须指定；对稀疏向量字段可以省略。范围为 [1, 32,768]。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>is_partition_key</code></strong></td>
          <td style="text-align: left">是否为分区键字段</td>
          <td style="text-align: left">类型为布尔值（<code>true</code> 或 <code>false</code>）。</td>
      </tr>
  </tbody>
</table>
<p>Milvus 支持以下三类字段：</p>
<p>1. <strong>主键字段</strong></p>
<p>主键字段是集合的唯一标识，用于标识集合中的每条记录。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">属性</th>
          <th style="text-align: left">描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong><code>name</code></strong></td>
          <td style="text-align: left">主键字段的名称</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>dtype</code></strong></td>
          <td style="text-align: left">支持 <code>INT64</code>（整数主键）或 <code>VARCHAR</code>（字符串主键）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>is_primary</code></strong></td>
          <td style="text-align: left">必须设为 <code>True</code>，表示该字段是主键</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>auto_id</code></strong></td>
          <td style="text-align: left">是否自动生成主键值（布尔值：<code>True</code> 或 <code>False</code>）</td>
      </tr>
  </tbody>
</table>
<p>2. <strong>标量字段</strong></p>
<p>标量字段用于存储布尔值、整数、浮点数、字符串、JSON 数据或数组等。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">数据类型</th>
          <th style="text-align: left">描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong><code>BOOL</code></strong></td>
          <td style="text-align: left">布尔值，支持 <code>true</code> 或 <code>false</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>INT8</code></strong></td>
          <td style="text-align: left">8 位整数</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>INT16</code></strong></td>
          <td style="text-align: left">16 位整数</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>INT32</code></strong></td>
          <td style="text-align: left">32 位整数</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>INT64</code></strong></td>
          <td style="text-align: left">64 位整数</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>FLOAT</code></strong></td>
          <td style="text-align: left">32 位单精度浮点数</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>DOUBLE</code></strong></td>
          <td style="text-align: left">64 位双精度浮点数</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>VARCHAR</code></strong></td>
          <td style="text-align: left">可变长度字符串，需指定最大长度（<code>max_length</code>）</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>JSON</code></strong></td>
          <td style="text-align: left">JSON 数据类型，存储键值对</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>Array</code></strong></td>
          <td style="text-align: left">数组类型，用于存储多个相同类型的数据</td>
      </tr>
  </tbody>
</table>
<p>3. <strong>向量字段</strong></p>
<p>向量字段用于存储高维特征数据，是 Milvus 支持向量检索的基础。</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">数据类型</th>
          <th style="text-align: left">描述</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong><code>FLOAT_VECTOR</code></strong></td>
          <td style="text-align: left">32 位浮点型向量，常用于机器学习和深度学习模型的特征表示</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>BINARY_VECTOR</code></strong></td>
          <td style="text-align: left">二进制向量，存储由 0 和 1 组成的序列，用于图像处理或紧凑特征表示</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>FLOAT16_VECTOR</code></strong></td>
          <td style="text-align: left">16 位浮点型向量，用于深度学习和 GPU 计算的内存优化</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>BFLOAT16_VECTOR</code></strong></td>
          <td style="text-align: left">16 位浮点型向量，具有与 <code>FLOAT32</code> 相同的指数范围，常用于深度学习优化</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>SPARSE_FLOAT_VECTOR</code></strong></td>
          <td style="text-align: left">稀疏浮点型向量，存储非零元素及其索引，用于稀疏向量场景</td>
      </tr>
  </tbody>
</table>
<p>其他支持的字段属性</p>
<ul>
<li>
<p><strong><code>is_partition_key</code></strong>: 是否将字段作为分区键，支持 <code>true</code> 或 <code>false</code>。</p>
</li>
<li>
<p><strong><code>dim</code></strong>: 向量字段的维度，必需为向量字段定义。</p>
</li>
<li>
<p><strong><code>max_length</code></strong>: <code>VARCHAR</code> 类型字段的最大字节长度。</p>
</li>
</ul>
<p>动态字段允许在插入数据时不提前定义字段，可以通过 <code>enable_dynamic_field=True</code> 在collection Schema 中启用</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">属性名称</th>
          <th style="text-align: left">描述</th>
          <th style="text-align: left">注意事项</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong><code>fields</code></strong></td>
          <td style="text-align: left">字段的集合</td>
          <td style="text-align: left">必须字段。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>description</code></strong></td>
          <td style="text-align: left">集合的描述</td>
          <td style="text-align: left">可选字段，类型为字符串。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>partition_key_field</code></strong></td>
          <td style="text-align: left">作为分区键的字段名</td>
          <td style="text-align: left">可选字段，类型为字符串。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong><code>enable_dynamic_field</code></strong></td>
          <td style="text-align: left">是否启用动态字段</td>
          <td style="text-align: left">可选字段，类型为布尔值，默认值为 <code>false</code>。</td>
      </tr>
  </tbody>
</table>
<h3 id="index">Index<a hidden class="anchor" aria-hidden="true" href="#index">#</a></h3>
<p><strong>为什么需要构造索引？</strong></p>
<p><strong>加速搜索</strong>：向量搜索的主要瓶颈在于计算高维向量之间的相似性。如果不使用索引，检索可能需要线性扫描整个数据集，耗时且资源消耗大；</p>
<p><strong>支持大规模数据</strong>： 在百万甚至十亿级别的数据量中，直接搜索变得不可行。索引能够分层次或分块处理数据，从而支持大规模数据场景</p>
<p><strong>资源效率</strong>：使用索引可以显著减少内存和计算资源的占用，尤其在处理频繁的实时查询时更加重要。</p>
<p>几种主要的索引类型：</p>
<p><strong>密集向量（Dense Vectors）</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">索引名称</th>
          <th style="text-align: left">适合场景</th>
          <th style="text-align: left">优点</th>
          <th style="text-align: left">缺点</th>
          <th style="text-align: left">参数解释</th>
          <th style="text-align: left">原理</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">FLAT</td>
          <td style="text-align: left">小数据集，精确搜索</td>
          <td style="text-align: left">搜索结果精确，简单易用</td>
          <td style="text-align: left">随数据量增加，速度显著下降</td>
          <td style="text-align: left">无需额外参数</td>
          <td style="text-align: left">对所有向量进行线性扫描，计算查询向量与每个向量的距离，从而找到最相似的结果。</td>
      </tr>
      <tr>
          <td style="text-align: left">IVF_FLAT</td>
          <td style="text-align: left">中等规模数据集</td>
          <td style="text-align: left">搜索效率高，支持近似搜索</td>
          <td style="text-align: left">搜索精度依赖参数调整</td>
          <td style="text-align: left">nlist：桶的数量，影响召回率和性能；nprobe：查询时访问的桶数量，影响搜索的准确性和速度</td>
          <td style="text-align: left">将向量划分为多个簇（cluster），通过聚类算法（如 k-means）预先构建倒排文件，仅在相关簇中执行搜索，减少比较次数，提高效率。</td>
      </tr>
      <tr>
          <td style="text-align: left">IVF_SQ8</td>
          <td style="text-align: left">需要平衡存储和性能的场景</td>
          <td style="text-align: left">存储需求低</td>
          <td style="text-align: left">搜索精度较低</td>
          <td style="text-align: left">与 IVF_FLAT 相同</td>
          <td style="text-align: left">在 IVF_FLAT 的基础上对每个向量进行标量量化（Scalar Quantization, SQ），将原始浮点向量压缩为整数形式以节省存储空间。</td>
      </tr>
      <tr>
          <td style="text-align: left">IVF_PQ</td>
          <td style="text-align: left">超大规模数据集，存储敏感场景</td>
          <td style="text-align: left">存储需求显著降低</td>
          <td style="text-align: left">搜索精度较低</td>
          <td style="text-align: left">nlist：桶的数量；m：子向量的数量，影响压缩比和性能；nbits：每个子向量的编码位数，影响压缩质量</td>
          <td style="text-align: left">基于 IVF_FLAT，使用产品量化（Product Quantization, PQ）将向量分为多个子空间，并分别进行量化，从而显著减少存储需求。</td>
      </tr>
      <tr>
          <td style="text-align: left">HNSW</td>
          <td style="text-align: left">中小规模数据集，高搜索精度场景</td>
          <td style="text-align: left">高性能，高维数据效果良好</td>
          <td style="text-align: left">索引构建时间长，占用内存大</td>
          <td style="text-align: left">efConstruction：控制构建时的候选集大小，影响构建速度和搜索精度；ef：搜索时的候选集大小，影响搜索性能和精度</td>
          <td style="text-align: left">使用分层的近似图（Navigable Small World Graph, NSW）表示向量之间的关系，通过图的导航找到查询向量的近似最近邻。</td>
      </tr>
      <tr>
          <td style="text-align: left">DISKANN</td>
          <td style="text-align: left">磁盘存储超大规模数据集</td>
          <td style="text-align: left">支持超大规模数据检索</td>
          <td style="text-align: left">查询速度较慢</td>
          <td style="text-align: left">search_list：控制查询范围，影响精度；pq_code_budget_gb：控制压缩的预算大小；build_threads：控制索引构建的线程数</td>
          <td style="text-align: left">结合倒排文件和磁盘访问优化，将部分索引和数据保存在磁盘上，通过减少内存占用实现超大规模数据检索。</td>
      </tr>
  </tbody>
</table>
<p>支持的度量类型有欧几里得距离（L2）、内积（IP）、余弦相似度（COSINE）。</p>
<p><strong>二进制向量（Binary Vectors）</strong></p>
<p>二进制向量（布尔值、哈希签名），占用资源低，对低维数据搜索快，精度不太高的场景</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>索引名称</strong></th>
          <th style="text-align: left"><strong>适合场景</strong></th>
          <th style="text-align: left"><strong>优点</strong></th>
          <th style="text-align: left"><strong>缺点</strong></th>
          <th style="text-align: left"><strong>参数解释</strong></th>
          <th style="text-align: left"><strong>原理</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>BIN_FLAT</strong></td>
          <td style="text-align: left">小规模数据集，精确搜索</td>
          <td style="text-align: left">搜索结果精确，易于实现</td>
          <td style="text-align: left">随数据量增加，速度显著下降</td>
          <td style="text-align: left">无需额外参数</td>
          <td style="text-align: left">对所有二进制向量进行线性扫描，逐一计算查询向量与每个向量的距离（如汉明距离），从而找到最相似的结果。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>BIN_IVF_FLAT</strong></td>
          <td style="text-align: left">中等规模数据集</td>
          <td style="text-align: left">搜索效率高，支持近似搜索</td>
          <td style="text-align: left">搜索精度依赖参数调整</td>
          <td style="text-align: left">- <code>nlist</code>：桶的数量，影响召回率和性能<br>- <code>nprobe</code>：查询时访问的桶数量，影响搜索的准确性和速度</td>
          <td style="text-align: left">结合倒排文件和线性扫描，将二进制向量划分到不同的桶中，通过访问部分桶来加速检索过程。</td>
      </tr>
  </tbody>
</table>
<p>支持的度量类型有 Jaccard 和 Hamming</p>
<p><strong>稀疏向量（Sparse Vectors）</strong></p>
<p>常用于文档搜索</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>索引名称</strong></th>
          <th style="text-align: left"><strong>适合场景</strong></th>
          <th style="text-align: left"><strong>优点</strong></th>
          <th style="text-align: left"><strong>缺点</strong></th>
          <th style="text-align: left"><strong>参数解释</strong></th>
          <th style="text-align: left"><strong>原理</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>SPARSE_INVERTED_INDEX</strong></td>
          <td style="text-align: left">文档检索、推荐系统</td>
          <td style="text-align: left">高效支持稀疏数据的相似性搜索</td>
          <td style="text-align: left">仅支持稀疏向量</td>
          <td style="text-align: left">- 无需额外参数</td>
          <td style="text-align: left">基于倒排索引（Inverted Index），将稀疏向量的非零值索引到特定位置，通过快速查找相关文档加速检索过程。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>SPARSE_WAND</strong></td>
          <td style="text-align: left">高性能文档检索、稀疏向量场景</td>
          <td style="text-align: left">支持稀疏数据，搜索效率更高</td>
          <td style="text-align: left">构建复杂度较高</td>
          <td style="text-align: left">- <code>top_k</code>：控制返回的搜索结果数量</td>
          <td style="text-align: left">基于 WAND（Weighted AND）算法优化倒排索引，对查询进行剪枝优化，仅访问最相关的文档，提高搜索性能。</td>
      </tr>
  </tbody>
</table>
<p>支持内积（IP）度量</p>
<p>如何选择合适的index</p>
<p><img loading="lazy" src="/img/Milvus%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95%ef%bc%9a%e4%bb%8e2.0%20%e5%88%b02.5%e7%89%88%e6%9c%ac%e7%9a%84%e4%bb%8e%e5%a4%b4%e5%ad%a6%e4%b9%a0-assets/640.webp" alt="640.webp"  />
</p>
<p>from <strong><a href="https://mp.weixin.qq.com/s/CITOmwNC2nGGe4LYnq6B4A">RAG搭建中，如何选择最合适的向量索引？</a></strong></p>
<p><strong>GPU-index</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>索引名称</strong></th>
          <th style="text-align: left"><strong>适合场景</strong></th>
          <th style="text-align: left"><strong>优点</strong></th>
          <th style="text-align: left"><strong>缺点</strong></th>
          <th style="text-align: left"><strong>参数解释</strong></th>
          <th style="text-align: left"><strong>原理</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>GPU_BRUTE_FORCE</strong></td>
          <td style="text-align: left">小批量搜索，高性能需求场景</td>
          <td style="text-align: left">结果精确，性能优于 CPU 的线性扫描</td>
          <td style="text-align: left">不支持范围搜索，资源消耗较高</td>
          <td style="text-align: left">无需额外参数</td>
          <td style="text-align: left">使用 GPU 并行计算能力对所有向量执行线性扫描，计算查询向量与每个向量的相似性，从而获得结果。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>GPU_IVF_FLAT</strong></td>
          <td style="text-align: left">大规模数据集搜索，高吞吐量需求场景</td>
          <td style="text-align: left">搜索效率高，结合 GPU 加速</td>
          <td style="text-align: left">搜索精度依赖参数调整</td>
          <td style="text-align: left">- <code>nlist</code>：桶的数量，影响召回率和性能<br>- <code>nprobe</code>：查询时访问的桶数量，影响搜索的准确性和速度</td>
          <td style="text-align: left">在 CPU IVF_FLAT 的基础上，利用 GPU 加速桶的分配和搜索过程，大幅提高检索速度。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>GPU_IVF_PQ</strong></td>
          <td style="text-align: left">大规模数据存储敏感场景，高吞吐量需求场景</td>
          <td style="text-align: left">存储需求显著降低，支持近似搜索</td>
          <td style="text-align: left">搜索精度较低</td>
          <td style="text-align: left">- <code>nlist</code>：桶的数量<br>- <code>m</code>：子向量数量，影响压缩比和性能<br>- <code>nbits</code>：每个子向量的编码位数，影响压缩质量</td>
          <td style="text-align: left">结合倒排文件与产品量化（PQ）技术，利用 GPU 提高量化和检索过程的速度，适合超大规模数据检索。</td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>GPU_CAGRA</strong></td>
          <td style="text-align: left">超高吞吐量和高召回率场景</td>
          <td style="text-align: left">高性能，高召回率，适合大批量查询</td>
          <td style="text-align: left">消耗更多内存，索引构建时间长</td>
          <td style="text-align: left">- <code>intermediate_graph_degree</code>：构建时图的中间连接数量，影响构建时间和召回率<br>- <code>graph_degree</code>：最终图的连接数量，影响搜索性能和内存占用</td>
          <td style="text-align: left">基于图的搜索算法（如 CAGRA），结合 GPU 的并行计算能力构建分层图结构，提高搜索的速度和精度。</td>
      </tr>
  </tbody>
</table>
<h3 id="analyzer"><strong>Analyzer</strong><a hidden class="anchor" aria-hidden="true" href="#analyzer">#</a></h3>
<p><strong>用于将原始文本转换为结构化和可搜索的格式。它的主要作用是实现文本处理、索引构建和检索优化</strong>。</p>
<p>在本质上，analyzer 包含了一个<strong>tokenizer（分词器）和可选的多个filters（过滤器）</strong>。</p>
<p><strong>用途</strong>: 将输入文本分解为更小的单元（tokens）; 通过过滤器进一步处理分词后的 token，例如转为小写、移除停用词、仅保留特定字符等; 将处理后的文本<strong>用于全文检索和关键词匹配。</strong></p>
<p>how to use：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s1">&#39;text_field&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">max_length</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable_analyzer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">analyzer_params</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;standard&#34;</span><span class="p">,</span>  <span class="c1"># 使用内置 analyzer</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;stop_words&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;a&#34;</span><span class="p">,</span> <span class="s2">&#34;an&#34;</span><span class="p">,</span> <span class="s2">&#34;the&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable_match</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># 启用关键词匹配</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p><strong>内置 Analyzer：</strong> 提供快速配置，适用于通用场景，如：</p>
<p>standard（标准分词器）/english（针对英文优化）/ chinese（针对中文优化）</p>
<p><strong>自定义 Analyzer， 如：</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">analyzer_params</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;tokenizer&#34;</span><span class="p">:</span> <span class="s2">&#34;standard&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;filter&#34;</span><span class="p">:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;lowercase&#34;</span><span class="p">,</span>  <span class="c1"># 转为小写</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;type&#34;</span><span class="p">:</span> <span class="s2">&#34;stop&#34;</span><span class="p">,</span>  <span class="c1"># 自定义停用词</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;stop_words&#34;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;of&#34;</span><span class="p">,</span> <span class="s2">&#34;to&#34;</span><span class="p">,</span> <span class="s2">&#34;the&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></div><h2 id="ann-search-in-milvus">ANN Search in Milvus<a hidden class="anchor" aria-hidden="true" href="#ann-search-in-milvus">#</a></h2>
<p>不同于传统数据库的精确匹配查询,向量库主要用于相似性搜索。这种搜索基于向量间的距离,通常使用欧几里得距离或余弦相似度。以暴力遍历的最近邻查询为例(Nearest neighbor search),假设我们有n个d维向量,查询复杂度为$O(nd)$。当n和d都很大时,这种方法变得非常耗时。</p>
<p>而近似最近邻搜索(Approximate Nearest Neighbor search, ANN)则能将时间复杂度降低到亚线性,通常为$O(log n)$或更优。</p>
<p>how to ANN-search</p>
<ol>
<li>
<p>create collection , schema and index</p>
</li>
<li>
<p>insert data</p>
</li>
<li>
<p>search</p>
</li>
</ol>
<p>构造索引</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">MilvusClient</span><span class="p">,</span> <span class="n">DataType</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建Milvus客户端</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建schema</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="o">.</span><span class="n">create_schema</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">auto_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable_dynamic_field</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加字段到schema</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;my_id&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">,</span> <span class="n">is_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;my_vector&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">FLOAT_VECTOR</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;my_varchar&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 准备索引参数</span>
</span></span><span class="line"><span class="cl"><span class="n">index_params</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">prepare_index_params</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加索引</span>
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;my_id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;STL_SORT&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;my_vector&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;AUTOINDEX&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric_type</span><span class="o">=</span><span class="s2">&#34;COSINE&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建collection</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_params</span><span class="o">=</span><span class="n">index_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span><span class="err">`</span>
</span></span></code></pre></div><p>数据插入</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;my_id&#34;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;my_vector&#34;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;my_varchar&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;example_text_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 插入数据</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 加载集合到内存</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">load_collection</span><span class="p">(</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 查看集合统计信息</span>
</span></span><span class="line"><span class="cl"><span class="n">stats</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get_collection_stats</span><span class="p">(</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&#34;Collection stats: </span><span class="si">{</span><span class="n">stats</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">)</span>
</span></span></code></pre></div><p>基础ANN-search</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 查询向量</span>
</span></span><span class="line"><span class="cl"><span class="n">query_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>  <span class="c1"># 模拟一个随机向量作为查询向量</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 搜索参数</span>
</span></span><span class="line"><span class="cl"><span class="n">search_params</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;metric_type&#34;</span><span class="p">:</span> <span class="s2">&#34;COSINE&#34;</span><span class="p">,</span>  <span class="c1"># 与创建索引时保持一致</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;nprobe&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>  <span class="c1"># nprobe 决定搜索范围，值越高精度越高，但速度可能变慢</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 执行搜索</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">anns_field</span><span class="o">=</span><span class="s2">&#34;my_vector&#34;</span><span class="p">,</span>   <span class="c1"># 指定向量字段</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>      <span class="c1"># 查询向量</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>                  <span class="c1"># 返回前 5 个结果</span>
</span></span><span class="line"><span class="cl">    <span class="n">search_params</span><span class="o">=</span><span class="n">search_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 打印搜索结果</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Search Results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span></code></pre></div><p>在指定的partition中search</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 构建partition，将数据插入partition</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">create_partition</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">partition_name</span><span class="o">=</span><span class="s2">&#34;partitionA&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">list_partitions</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_1&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">[&#39;_default&#39;, &#39;partitionA&#39;]
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data2</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;my_id&#34;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;my_vector&#34;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>  <span class="c1"># 生成随机向量</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;my_varchar&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;example_text_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>  
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">,</span><span class="n">partition_name</span><span class="o">=</span><span class="s2">&#34;partitionA&#34;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 在partition 中查询</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">anns_field</span><span class="o">=</span><span class="s2">&#34;my_vector&#34;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>      
</span></span><span class="line"><span class="cl">    <span class="n">partition_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;partitionA&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>                  
</span></span><span class="line"><span class="cl">    <span class="n">search_params</span><span class="o">=</span><span class="n">search_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Search Results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span></code></pre></div><p>通过 <code>output Fields</code>指定输出的内容，在数据插入时，定义了<code>my_vector</code>和<code>my_varchar;</code>(默认只展示id)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># Use Output Fields</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_1&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">anns_field</span><span class="o">=</span><span class="s2">&#34;my_vector&#34;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>      
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>                  
</span></span><span class="line"><span class="cl">    <span class="n">search_params</span><span class="o">=</span><span class="n">search_params</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;my_vector&#34;</span><span class="p">,</span><span class="s2">&#34;my_varchar&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Search Results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">Search Results:
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 7, &#39;distance&#39;: 0.9791999459266663, &#39;entity&#39;: {&#39;my_vector&#39;: [0.7273301482200623, 0.25300344824790955, 0.8510549664497375, 0.6126695871353149, 0.5709182024002075], &#39;my_varchar&#39;: &#39;example_text_7&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 84, &#39;distance&#39;: 0.9768796563148499, &#39;entity&#39;: {&#39;my_vector&#39;: [0.6703248620033264, 0.1109713464975357, 0.5905848145484924, 0.372805655002594, 0.4945228397846222], &#39;my_varchar&#39;: &#39;example_text_84&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 27, &#39;distance&#39;: 0.9755662083625793, &#39;entity&#39;: {&#39;my_vector&#39;: [0.8758077025413513, 0.13442707061767578, 0.968295156955719, 0.25122591853141785, 0.7256166934967041], &#39;my_varchar&#39;: &#39;example_text_27&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>Limit and Offset</p>
<p>这两个参数结合使用时可以实现分页查询</p>
<ul>
<li>
<p>Limit: 控制搜索结果中返回的实体数量，即返回的 Top-K 结果。</p>
</li>
<li>
<p>Offset: 指定从搜索结果中跳过的实体数量，用于实现分页。</p>
</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 第 1 页查询：获取第 1-10 个结果</span>
</span></span><span class="line"><span class="cl"><span class="n">res_page_1</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">anns_field</span><span class="o">=</span><span class="s2">&#34;my_vector&#34;</span><span class="p">,</span>   
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>      
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>                 <span class="c1"># 每页 10 条</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>                 <span class="c1"># 跳过 0 条</span>
</span></span><span class="line"><span class="cl">    <span class="n">search_params</span><span class="o">=</span><span class="n">search_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Page 1 Results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res_page_1</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 第 2 页查询：获取第 11-20 个结果</span>
</span></span><span class="line"><span class="cl"><span class="n">res_page_2</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;customized_setup_2&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">anns_field</span><span class="o">=</span><span class="s2">&#34;my_vector&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># 每页 10 条</span>
</span></span><span class="line"><span class="cl">    <span class="n">offset</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="c1"># 跳过前 10 条</span>
</span></span><span class="line"><span class="cl">    <span class="n">search_params</span><span class="o">=</span><span class="n">search_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="s2">&#34;Page 2 Results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res_page_2</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">Page 1 Results:
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 7, &#39;distance&#39;: 0.9791999459266663, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 84, &#39;distance&#39;: 0.9768796563148499, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 27, &#39;distance&#39;: 0.9755662083625793, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 28, &#39;distance&#39;: 0.9715055227279663, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 38, &#39;distance&#39;: 0.9661443829536438, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 40, &#39;distance&#39;: 0.9624771475791931, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 93, &#39;distance&#39;: 0.9594350457191467, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 0, &#39;distance&#39;: 0.9587700366973877, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 73, &#39;distance&#39;: 0.9547507166862488, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 32, &#39;distance&#39;: 0.9311172366142273, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">Page 2 Results:
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 52, &#39;distance&#39;: 0.9296990036964417, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 26, &#39;distance&#39;: 0.9230980277061462, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 33, &#39;distance&#39;: 0.922787606716156, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 55, &#39;distance&#39;: 0.9211370348930359, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 30, &#39;distance&#39;: 0.9198154211044312, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 63, &#39;distance&#39;: 0.918975830078125, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 3, &#39;distance&#39;: 0.9085606932640076, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 37, &#39;distance&#39;: 0.9077025651931763, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 67, &#39;distance&#39;: 0.9050586223602295, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 4, &#39;distance&#39;: 0.9049072861671448, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><ul>
<li>
<p>Milvus 中单次搜索结果的返回实体数限制为 16,384。如果需要更多结果，可以通过 <strong>Search Iterator</strong> 分批处理。</p>
</li>
<li>
<p>较大的 offset 值会导致搜索效率下降，因为需要计算和跳过前面部分结果</p>
</li>
</ul>
<h2 id="进阶ann-search">进阶ANN Search<a hidden class="anchor" aria-hidden="true" href="#进阶ann-search">#</a></h2>
<h3 id="filter-search--metadata-filtering">Filter Search &amp; Metadata Filtering<a hidden class="anchor" aria-hidden="true" href="#filter-search--metadata-filtering">#</a></h3>
<p><strong>Filtered Search</strong> 是在 ANN 方法的基础上添加过滤条件的搜索模式，结合了元数据的过滤功能，能够缩小检索范围或实现一些复杂逻辑。</p>
<p><img loading="lazy" src="/img/Milvus%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95%ef%bc%9a%e4%bb%8e2.0%20%e5%88%b02.5%e7%89%88%e6%9c%ac%e7%9a%84%e4%bb%8e%e5%a4%b4%e5%ad%a6%e4%b9%a0-assets/Pasted%202024-12-23-19-42-35.png" alt="Pasted 2024-12-23-19-42-35.png"  />
</p>
<p>数据准备</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建 schema</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_schema</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">auto_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable_dynamic_field</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">index_params</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">prepare_index_params</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加字段到 schema</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">,</span> <span class="n">is_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">FLOAT_VECTOR</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;color&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;likes&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;AUTOINDEX&#34;</span><span class="p">,</span>  <span class="c1"># Automatically choose the best index type</span>
</span></span><span class="line"><span class="cl">            <span class="n">metric_type</span><span class="o">=</span><span class="s2">&#34;L2&#34;</span>         <span class="c1"># Use L2 distance as the metric</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add a sort index for the id field</span>
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;STL_SORT&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&#34;customized_setup_5&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_params</span><span class="o">=</span><span class="n">index_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 准备数据</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3580376395471989</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6023495712049978</span><span class="p">,</span> <span class="mf">0.18414012509913835</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26286205330961354</span><span class="p">,</span> <span class="mf">0.9029438446296592</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;pink_8682&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">165</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.19886812562848388</span><span class="p">,</span> <span class="mf">0.06023560599112088</span><span class="p">,</span> <span class="mf">0.6976963061752597</span><span class="p">,</span> <span class="mf">0.2614474506242501</span><span class="p">,</span> <span class="mf">0.838729485096104</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;red_7025&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">25</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.43742130801983836</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5597502546264526</span><span class="p">,</span> <span class="mf">0.6457887650909682</span><span class="p">,</span> <span class="mf">0.7894058910881185</span><span class="p">,</span> <span class="mf">0.20785793220625592</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;orange_6781&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">764</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3172005263489739</span><span class="p">,</span> <span class="mf">0.9719044792798428</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.36981146090600725</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4860894583077995</span><span class="p">,</span> <span class="mf">0.95791889146345</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;pink_9298&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">234</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.4452349528804562</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8757026943054742</span><span class="p">,</span> <span class="mf">0.8220779437047674</span><span class="p">,</span> <span class="mf">0.46406290649483184</span><span class="p">,</span> <span class="mf">0.30337481143159106</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;red_4794&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">122</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.985825131989184</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8144651566660419</span><span class="p">,</span> <span class="mf">0.6299267002202009</span><span class="p">,</span> <span class="mf">0.1206906911183383</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1446277761879955</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;yellow_4222&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">12</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8371977790571115</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.015764369584852833</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.31062937026679327</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.562666951622192</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8984947637863987</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;red_9392&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">58</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.33445148015177995</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2567135004164067</span><span class="p">,</span> <span class="mf">0.8987539745369246</span><span class="p">,</span> <span class="mf">0.9402995886420709</span><span class="p">,</span> <span class="mf">0.5378064918413052</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;grey_8510&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">775</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.39524717779832685</span><span class="p">,</span> <span class="mf">0.4000257286739164</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5890507376891594</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8650502298996872</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6140360785406336</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;white_9381&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">876</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5718280481994695</span><span class="p">,</span> <span class="mf">0.24070317428066512</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3737913482606834</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.06726932177492717</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6980531615588608</span><span class="p">],</span> <span class="s2">&#34;color&#34;</span><span class="p">:</span> <span class="s2">&#34;purple_4976&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">:</span> <span class="mi">765</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 插入数据</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="n">data</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># {&#39;insert_count&#39;: 10, &#39;ids&#39;: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9], &#39;cost&#39;: 0}</span>
</span></span></code></pre></div><p>filter-search</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res_filtered</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">anns_field</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nb">filter</span><span class="o">=</span><span class="s2">&#34;color like &#39;red%&#39; and likes &gt; 50&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;color&#34;</span><span class="p">,</span> <span class="s2">&#34;likes&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res_filtered</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 4, &#39;distance&#39;: 1.4699335098266602, &#39;entity&#39;: {&#39;color&#39;: &#39;red_4794&#39;, &#39;likes&#39;: 122}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 6, &#39;distance&#39;: 3.989945888519287, &#39;entity&#39;: {&#39;color&#39;: &#39;red_9392&#39;, &#39;likes&#39;: 58}}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>支持的metadata 过滤方式：</p>
<table>
  <thead>
      <tr>
          <th style="text-align: left"><strong>过滤类型</strong></th>
          <th style="text-align: left"><strong>描述</strong></th>
          <th style="text-align: left"><strong>示例</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left"><strong>比较操作符</strong></td>
          <td style="text-align: left">用于数值比较</td>
          <td style="text-align: left"><code>filter=&quot;price &gt; 500&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>&gt;</code>：大于</td>
          <td style="text-align: left"><code>filter=&quot;inventory['quantity'] &gt;= 250&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>&lt;</code>：小于</td>
          <td style="text-align: left"><code>filter=&quot;sales_volume[0] &lt; 100&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>==</code>：等于</td>
          <td style="text-align: left"><code>filter=&quot;color == 'red_7025'&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>&lt;=</code>：小于等于</td>
          <td style="text-align: left"><code>filter=&quot;price &lt;= 900&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>&gt;=</code>：大于等于</td>
          <td style="text-align: left"><code>filter=&quot;sales_volume[0] &gt;= 150&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>!=</code>：不等于</td>
          <td style="text-align: left"><code>filter=&quot;color != 'yellow_4222'&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>Term操作符</strong></td>
          <td style="text-align: left">精确匹配或排除</td>
          <td style="text-align: left"><code>filter='color in [&quot;red_7025&quot;, &quot;red_4794&quot;]'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>in</code>：匹配指定集合</td>
          <td style="text-align: left"><code>filter='inventory[&quot;brand&quot;] in [&quot;Apple&quot;]'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>not in</code>：排除指定集合</td>
          <td style="text-align: left"><code>filter='color not in [&quot;yellow_4222&quot;, &quot;grey_8510&quot;]'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>Match操作符</strong></td>
          <td style="text-align: left">字符串匹配</td>
          <td style="text-align: left"><code>filter='color like &quot;red%&quot;'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>like</code>：通配符匹配</td>
          <td style="text-align: left"><code>filter='inventory[&quot;brand&quot;] like &quot;S%&quot;'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>TEXT_MATCH</code>：文本高效匹配</td>
          <td style="text-align: left"><code>filter='TEXT_MATCH(description, &quot;Apple iPhone&quot;)'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>算术操作符</strong></td>
          <td style="text-align: left">数值计算</td>
          <td style="text-align: left"><code>filter=&quot;price * 0.5 &lt; 300&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>+</code>：加</td>
          <td style="text-align: left"><code>filter=&quot;sales_volume[0] + 50 &gt; 200&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>-</code>：减</td>
          <td style="text-align: left"><code>filter=&quot;price - 100 &gt; 500&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>*</code>：乘</td>
          <td style="text-align: left"><code>filter=&quot;price * 2 &gt; 1000&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>/</code>：除</td>
          <td style="text-align: left"><code>filter=&quot;inventory['quantity'] / 2 &gt; 100&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>**</code>：幂运算</td>
          <td style="text-align: left"><code>filter=&quot;price ** 2 &gt; 250000&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>%</code>：取余</td>
          <td style="text-align: left"><code>filter=&quot;price % 100 == 0&quot;</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>JSON操作符</strong></td>
          <td style="text-align: left">用于JSON字段的高级过滤</td>
          <td style="text-align: left"><code>filter='JSON_CONTAINS(inventory[&quot;previous_sales&quot;], 232)'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>JSON_CONTAINS</code>：包含指定元素</td>
          <td style="text-align: left"><code>filter='JSON_CONTAINS_ALL(inventory[&quot;previous_sales&quot;], [232, 254])'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>JSON_CONTAINS_ALL</code>：包含所有指定元素</td>
          <td style="text-align: left"><code>filter='JSON_CONTAINS_ANY(inventory[&quot;previous_sales&quot;], [232, 275])'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>JSON_CONTAINS_ANY</code>：包含任一元素</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>Array操作符</strong></td>
          <td style="text-align: left">用于数组字段的高级过滤</td>
          <td style="text-align: left"><code>filter='ARRAY_CONTAINS(sales_volume, 150)'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>ARRAY_CONTAINS</code>：包含指定元素</td>
          <td style="text-align: left"><code>filter='ARRAY_CONTAINS_ALL(sales_volume, [150, 150])'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>ARRAY_CONTAINS_ALL</code>：包含所有指定元素</td>
          <td style="text-align: left"><code>filter='ARRAY_CONTAINS_ANY(sales_volume, [150, 190])'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>ARRAY_CONTAINS_ANY</code>：包含任一指定元素</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>ARRAY_LENGTH</code>：检查数组长度</td>
          <td style="text-align: left"><code>filter='ARRAY_LENGTH(sales_volume) == 3'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>逻辑操作符</strong></td>
          <td style="text-align: left">组合多个过滤条件</td>
          <td style="text-align: left"><code>filter='color like &quot;red%&quot; and price &lt; 500'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>and</code> 或 <code>&amp;&amp;</code>：所有条件均需满足</td>
          <td style="text-align: left"><code>filter='price &lt; 500 and sales_volume[0] &gt; 100'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>or</code> 或 `</td>
          <td style="text-align: left"></td>
      </tr>
      <tr>
          <td style="text-align: left"></td>
          <td style="text-align: left">- <code>not</code>：逻辑非</td>
          <td style="text-align: left"><code>filter='not (price &gt; 500)'</code></td>
      </tr>
      <tr>
          <td style="text-align: left"><strong>复杂表达式</strong></td>
          <td style="text-align: left">通过括号调整优先级</td>
          <td style="text-align: left"><code>filter='(price &gt; 500 and inventory[&quot;brand&quot;] in [&quot;Apple&quot;]) or color == &quot;red_7025&quot;'</code></td>
      </tr>
  </tbody>
</table>
<h3 id="range-search">Range search<a hidden class="anchor" aria-hidden="true" href="#range-search">#</a></h3>
<p><img loading="lazy" src="/img/Milvus%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95%ef%bc%9a%e4%bb%8e2.0%20%e5%88%b02.5%e7%89%88%e6%9c%ac%e7%9a%84%e4%bb%8e%e5%a4%b4%e5%ad%a6%e4%b9%a0-assets/Pasted%202024-12-23-19-42-35%201.png" alt="Pasted 2024-12-23-19-42-35 1.png"  />
</p>
<p>通过设置一个范围（<strong>半径</strong>或<strong>区间</strong>），筛选出符合距离/相似度范围的向量</p>
<blockquote>
<p>执行范围搜索请求时，Milvus 以 ANN 搜索结果中与查询向量最相似的向量为圆心，以搜索请求中指定的半径为外圈半径，以<strong>range_filter</strong>为内圈半径，画出两个同心圆。所有相似度得分在这两个同心圆形成的环形区域内的向量都将被返回</p>
</blockquote>
<p>可能的使用场景：</p>
<ul>
<li>
<p><strong>相似度过滤</strong>：返回与查询向量相似度在指定范围内的项</p>
</li>
<li>
<p><strong>异常检测</strong>：查找距离远离中心点的异常点</p>
</li>
<li>
<p><strong>推荐系统：</strong> 避免过高相似度（可能是重复内容）或过低相似度（相关性不强）的结果</p>
</li>
</ul>
<table>
  <thead>
      <tr>
          <th style="text-align: left">Metric Type</th>
          <th style="text-align: left">距离范围</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">L2</td>
          <td style="text-align: left">range_filter &lt;= 距离 &lt; radius</td>
      </tr>
      <tr>
          <td style="text-align: left">IP</td>
          <td style="text-align: left">radius &lt; 距离 &lt;= range_filter</td>
      </tr>
      <tr>
          <td style="text-align: left">COSINE</td>
          <td style="text-align: left">radius &lt; 距离 &lt;= range_filter</td>
      </tr>
      <tr>
          <td style="text-align: left">JACCARD</td>
          <td style="text-align: left">range_filter &lt;= 距离 &lt; radius</td>
      </tr>
      <tr>
          <td style="text-align: left">HAMMING</td>
          <td style="text-align: left">range_filter &lt;= 距离 &lt; radius</td>
      </tr>
  </tbody>
</table>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">query_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.5580376395471989</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8023495712049978</span><span class="p">,</span> <span class="mf">0.38414012509913835</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.36286205330961354</span><span class="p">,</span> <span class="mf">0.9029438446296591</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="c1"># metric_type=&#34;L2&#34;  </span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vector</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">search_params</span><span class="o">=</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;radius&#34;</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;range_filter&#34;</span><span class="p">:</span> <span class="mf">0.1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">       
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 0, &#39;distance&#39;: 0.12999999523162842, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h3 id="grouping-search">Grouping Search<a hidden class="anchor" aria-hidden="true" href="#grouping-search">#</a></h3>
<p>将搜索结果根据某些属性或特征分组（group）</p>
<p>搜索结果中，基于特定字段或条件，将相似或具有共同特征的记录聚合在一起</p>
<p><img loading="lazy" src="/img/Milvus%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95%ef%bc%9a%e4%bb%8e2.0%20%e5%88%b02.5%e7%89%88%e6%9c%ac%e7%9a%84%e4%bb%8e%e5%a4%b4%e5%ad%a6%e4%b9%a0-assets/Pasted%202024-12-23-19-42-35%202.png" alt="Pasted 2024-12-23-19-42-35 2.png"  />
</p>
<p>举个具体的例子，在 RAG（Retrieval-Augmented Generation）任务中，我们通常会将文档拆分成一定大小的文本块（chunks），以便在检索过程中实现更精准的语义匹配。然而，在生成回答时，我们并不总是局限于直接使用召回的这些文本块，而是希望尽可能覆盖更多的文档或是包含更多的文档上下文。因为检索阶段可能会从同一文档中召回多个文本块，而忽略其他文档的内容，从而导致搜索结果的多样性降低，影响答案的全面性和准确性。</p>
<p>数据准备</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 创建 schema</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_schema</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">auto_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable_dynamic_field</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">index_params</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">prepare_index_params</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 添加字段到 schema</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">,</span> <span class="n">is_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">FLOAT_VECTOR</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;chunk&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;docId&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;AUTOINDEX&#34;</span><span class="p">,</span>  <span class="c1"># Automatically choose the best index type</span>
</span></span><span class="line"><span class="cl">            <span class="n">metric_type</span><span class="o">=</span><span class="s2">&#34;L2&#34;</span>         <span class="c1"># Use L2 distance as the metric</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add a sort index for the id field</span>
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;STL_SORT&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&#34;group_search_collection&#34;</span>
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_params</span><span class="o">=</span><span class="n">index_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3580376395471989</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6023495712049978</span><span class="p">,</span> <span class="mf">0.18414012509913835</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26286205330961354</span><span class="p">,</span> <span class="mf">0.9029438446296592</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;pink_8682&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.19886812562848388</span><span class="p">,</span> <span class="mf">0.06023560599112088</span><span class="p">,</span> <span class="mf">0.6976963061752597</span><span class="p">,</span> <span class="mf">0.2614474506242501</span><span class="p">,</span> <span class="mf">0.838729485096104</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;red_7025&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.43742130801983836</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5597502546264526</span><span class="p">,</span> <span class="mf">0.6457887650909682</span><span class="p">,</span> <span class="mf">0.7894058910881185</span><span class="p">,</span> <span class="mf">0.20785793220625592</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;orange_6781&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.3172005263489739</span><span class="p">,</span> <span class="mf">0.9719044792798428</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.36981146090600725</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.4860894583077995</span><span class="p">,</span> <span class="mf">0.95791889146345</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;pink_9298&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.4452349528804562</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8757026943054742</span><span class="p">,</span> <span class="mf">0.8220779437047674</span><span class="p">,</span> <span class="mf">0.46406290649483184</span><span class="p">,</span> <span class="mf">0.30337481143159106</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;red_4794&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.985825131989184</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8144651566660419</span><span class="p">,</span> <span class="mf">0.6299267002202009</span><span class="p">,</span> <span class="mf">0.1206906911183383</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1446277761879955</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;yellow_4222&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">4</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">6</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.8371977790571115</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.015764369584852833</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.31062937026679327</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.562666951622192</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8984947637863987</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;red_9392&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">7</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.33445148015177995</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2567135004164067</span><span class="p">,</span> <span class="mf">0.8987539745369246</span><span class="p">,</span> <span class="mf">0.9402995886420709</span><span class="p">,</span> <span class="mf">0.5378064918413052</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;grey_8510&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.39524717779832685</span><span class="p">,</span> <span class="mf">0.4000257286739164</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5890507376891594</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.8650502298996872</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6140360785406336</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;white_9381&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span><span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">9</span><span class="p">,</span> <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="mf">0.5718280481994695</span><span class="p">,</span> <span class="mf">0.24070317428066512</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3737913482606834</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.06726932177492717</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6980531615588608</span><span class="p">],</span> <span class="s2">&#34;chunk&#34;</span><span class="p">:</span> <span class="s2">&#34;purple_4976&#34;</span><span class="p">,</span> <span class="s2">&#34;docId&#34;</span><span class="p">:</span> <span class="mi">3</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="n">data</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>查询</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">query_vectors</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span><span class="mf">0.14529211512077012</span><span class="p">,</span> <span class="mf">0.9147257273453546</span><span class="p">,</span> <span class="mf">0.7965055218724449</span><span class="p">,</span> <span class="mf">0.7009258593102812</span><span class="p">,</span> <span class="mf">0.5605206522382088</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Group search results</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="n">collection_name</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="n">query_vectors</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">group_by_field</span><span class="o">=</span><span class="s2">&#34;docId&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;docId&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Retrieve the values in the `docId` column</span>
</span></span><span class="line"><span class="cl"><span class="n">doc_ids</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s1">&#39;entity&#39;</span><span class="p">][</span><span class="s1">&#39;docId&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">result</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
</span></span><span class="line"><span class="cl"><span class="n">doc_ids</span>
</span></span><span class="line"><span class="cl"><span class="c1"># [5, 2, 3]</span>
</span></span></code></pre></div><p>只返回top-3的doc结果</p>
<ul>
<li>
<p>group_by_field： 指定进行分组的字段名称</p>
</li>
<li>
<p>strict_group_size： 每组返回的结果数量。默认情况下，每组只返回一个最相似的实体</p>
</li>
<li>
<p>strict_group_size： 是否严格限制每组的返回结果数量。设置为 True 时，系统会尝试保证每组返回的实体数量与 group_size 参数一致。如果某组数据不足，则可能影响查询性能。默认值为 False。</p>
</li>
</ul>
<h3 id="hybrid-search"><strong>Hybrid Search</strong><a hidden class="anchor" aria-hidden="true" href="#hybrid-search">#</a></h3>
<p>允许在一个collection中对多个向量字段（例如稠密向量和稀疏向量）同时进行搜索，并将不同搜索结果重新排序为单一结果集。</p>
<blockquote>
<p>Hybrid Search refers to a search method that conducts multiple ANN searches simultaneously, reranks multiple sets of results from these ANN searches, and ultimately returns a single set of results. </p>
</blockquote>
<p><img loading="lazy" src="/img/Milvus%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95%ef%bc%9a%e4%bb%8e2.0%20%e5%88%b02.5%e7%89%88%e6%9c%ac%e7%9a%84%e4%bb%8e%e5%a4%b4%e5%ad%a6%e4%b9%a0-assets/Pasted%202024-12-23-19-42-35%203.png" alt="Pasted 2024-12-23-19-42-35 3.png"  />
</p>
<p>主要工作流程</p>
<ol>
<li>
<p>生成密集向量（Dense Vectors）：通过嵌入模型（如 BERT 和 Transformers）生成密</p>
</li>
<li>
<p>生成稀疏向量（Sparse Vectors）：通过嵌入模型（如 BM25、BGE-M3、SPLADE 等）生成稀疏向量。</p>
</li>
<li>
<p>创建集合（Collection）：创建集合，并定义包含密集和稀疏向量字段的集合 Schema。</p>
</li>
<li>
<p>插入数据：将稀疏和密集向量插入到创建的集合中。</p>
</li>
<li>
<p>执行混合搜索：</p>
<ul>
<li>
<p>对密集向量执行 ANN 搜索，返回一组最相似的 Top-K 结果。</p>
</li>
<li>
<p>对稀疏向量执行文本匹配搜索，也返回一组 Top-K 结果。</p>
</li>
</ul>
</li>
<li>
<p>得分归一化（Normalization）：将两组 Top-K 结果的得分归一化到 [0,1] 的范围。</p>
</li>
<li>
<p>融合与重排序：选择合适的重排序策略，将两组 Top-K 结果合并并重新排序，最终返回一组综合的 Top-K 结果。</p>
</li>
</ol>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">MilvusClient</span><span class="p">,</span> <span class="n">DataType</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="o">.</span><span class="n">create_schema</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">auto_id</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">enable_dynamic_field</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">,</span> <span class="n">is_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;text&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;sparse&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">SPARSE_FLOAT_VECTOR</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;dense&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">FLOAT_VECTOR</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_params</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">prepare_index_params</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;dense&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_name</span><span class="o">=</span><span class="s2">&#34;dense_index&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;IVF_FLAT&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric_type</span><span class="o">=</span><span class="s2">&#34;IP&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;nlist&#34;</span><span class="p">:</span> <span class="mi">128</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;sparse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_name</span><span class="o">=</span><span class="s2">&#34;sparse_index&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;SPARSE_INVERTED_INDEX&#34;</span><span class="p">,</span>  <span class="c1"># Index type for sparse vectors</span>
</span></span><span class="line"><span class="cl">    <span class="n">metric_type</span><span class="o">=</span><span class="s2">&#34;IP&#34;</span><span class="p">,</span>  <span class="c1"># Currently, only IP (Inner Product) is supported for sparse vectors</span>
</span></span><span class="line"><span class="cl">    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&#34;drop_ratio_build&#34;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>  <span class="c1"># The ratio of small vector values to be dropped during indexing</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;hybrid_search_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_params</span><span class="o">=</span><span class="n">index_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>数据插入</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="c1"># 插入数据</span>
</span></span><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">random</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 随机生成稠密向量</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_random_dense_vector</span><span class="p">(</span><span class="n">dim</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 随机生成稀疏向量</span>
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_random_sparse_vector</span><span class="p">(</span><span class="n">max_dim</span><span class="p">,</span> <span class="n">num_non_zero</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="n">indices</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">max_dim</span><span class="p">),</span> <span class="n">num_non_zero</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_non_zero</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="p">{</span><span class="n">idx</span><span class="p">:</span> <span class="n">val</span> <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">values</span><span class="p">)}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 数据</span>
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;Artificial intelligence was founded as an academic discipline in 1956.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;sparse&#34;</span><span class="p">:</span> <span class="n">generate_random_sparse_vector</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>  <span class="c1"># 稀疏向量</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;dense&#34;</span><span class="p">:</span> <span class="n">generate_random_dense_vector</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># 稠密向量</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;Alan Turing was the first person to conduct substantial research in AI.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;sparse&#34;</span><span class="p">:</span> <span class="n">generate_random_sparse_vector</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;dense&#34;</span><span class="p">:</span> <span class="n">generate_random_dense_vector</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;id&#34;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;text&#34;</span><span class="p">:</span> <span class="s2">&#34;Born in Maida Vale, London, Turing was raised in southern England.&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;sparse&#34;</span><span class="p">:</span> <span class="n">generate_random_sparse_vector</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;dense&#34;</span><span class="p">:</span> <span class="n">generate_random_dense_vector</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># 插入数据</span>
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;hybrid_search_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="n">data</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>混合搜索是通过在**<code>hybrid_search()</code>** 函数中创建多个**<code>AnnSearchRequest</code>** 来实现的，其中每个**<code>AnnSearchRequest</code>** 代表一个特定向量场的基本 ANN 搜索请求。</p>
<p>在混合搜索中，每个**<code>AnnSearchRequest</code>** 只支持一个查询向量。</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">AnnSearchRequest</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">query_dense_vector</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.3580376395471989</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6023495712049978</span><span class="p">,</span> <span class="mf">0.18414012509913835</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.26286205330961354</span><span class="p">,</span> <span class="mf">0.9029438446296592</span><span class="p">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">search_param_1</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">query_dense_vector</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;anns_field&#34;</span><span class="p">:</span> <span class="s2">&#34;dense&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;param&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;metric_type&#34;</span><span class="p">:</span> <span class="s2">&#34;IP&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;nprobe&#34;</span><span class="p">:</span> <span class="mi">10</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;limit&#34;</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">request_1</span> <span class="o">=</span> <span class="n">AnnSearchRequest</span><span class="p">(</span><span class="o">**</span><span class="n">search_param_1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">query_sparse_vector</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1609</span><span class="p">:</span> <span class="mf">0.6255744191385809</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="mi">7058</span><span class="p">:</span> <span class="mf">0.20234890590382482</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="mi">449</span><span class="p">:</span> <span class="mf">0.01787891574781786</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="mi">9702</span><span class="p">:</span> <span class="mf">0.710732808143222</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"> <span class="mi">8827</span><span class="p">:</span> <span class="mf">0.3979309078494506</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">search_param_2</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;data&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">query_sparse_vector</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;anns_field&#34;</span><span class="p">:</span> <span class="s2">&#34;sparse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;param&#34;</span><span class="p">:</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;metric_type&#34;</span><span class="p">:</span> <span class="s2">&#34;IP&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;params&#34;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&#34;drop_ratio_build&#34;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;limit&#34;</span><span class="p">:</span> <span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">request_2</span> <span class="o">=</span> <span class="n">AnnSearchRequest</span><span class="p">(</span><span class="o">**</span><span class="n">search_param_2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">reqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">request_1</span><span class="p">,</span> <span class="n">request_2</span><span class="p">]</span>
</span></span></code></pre></div><p>采用<strong>加权排名</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">WeightedRanker</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ranker</span><span class="o">=</span> <span class="n">WeightedRanker</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;hybrid_search_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">reqs</span><span class="o">=</span><span class="n">reqs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ranker</span><span class="o">=</span><span class="n">ranker</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;TopK results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">TopK results:
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 1, &#39;distance&#39;: 0.5914705991744995, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 0, &#39;distance&#39;: 0.27949291467666626, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>采用RRF（Reciprocal Rank Fusion） ranker</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">RRFRanker</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Default k value is 60</span>
</span></span><span class="line"><span class="cl"><span class="n">ranker</span> <span class="o">=</span> <span class="n">RRFRanker</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">hybrid_search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;hybrid_search_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">reqs</span><span class="o">=</span><span class="n">reqs</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ranker</span><span class="o">=</span><span class="n">ranker</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">2</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;TopK results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">TopK results:
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 1, &#39;distance&#39;: 0.009900989942252636, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 0, &#39;distance&#39;: 0.009803921915590763, &#39;entity&#39;: </span><span class="si">{}</span><span class="s2">}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h3 id="full-text-search">Full Text Search<a hidden class="anchor" aria-hidden="true" href="#full-text-search">#</a></h3>
<p>Milvus 在 2.5 版本中引入了全文检索， 能够基于关键字或短语高效地搜索文本数据。</p>
<p>全文检索功能在 Milvus Standalone 和 Milvus Distributed 中可用，但在 Milvus Lite 中不可用</p>
<p>步骤：</p>
<ol>
<li>
<p>文本输入：用户直接插入原始文本数据，无需手动生成向量嵌入。</p>
</li>
<li>
<p>文本分析：Milvus 使用内置的分析器将输入文本分解为可搜索的词条。</p>
</li>
<li>
<p>函数处理：内置函数接收已分词的词条，并将其转换为稀疏向量表示。</p>
</li>
<li>
<p>集合存储：Milvus 将这些稀疏嵌入存储在集合（Collection）中，以便高效检索。</p>
</li>
<li>
<p>BM25 评分：在检索时，Milvus 应用 BM25 算法计算查询文本和存储文档的相关性得分，并对匹配结果进行排序</p>
</li>
</ol>
<p><img loading="lazy" src="/img/Milvus%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95%ef%bc%9a%e4%bb%8e2.0%20%e5%88%b02.5%e7%89%88%e6%9c%ac%e7%9a%84%e4%bb%8e%e5%a4%b4%e5%ad%a6%e4%b9%a0-assets/Pasted%202024-12-23-19-42-35%204.png" alt="Pasted 2024-12-23-19-42-35 4.png"  />
</p>
<p>创建 Schema</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">MilvusClient</span><span class="p">,</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">Function</span><span class="p">,</span> <span class="n">FunctionType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_schema</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">,</span> <span class="n">is_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;text&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">enable_analyzer</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;sparse&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">SPARSE_FLOAT_VECTOR</span><span class="p">)</span>
</span></span></code></pre></div><p><strong><code>SPARSE_FLOAT_VECTOR</code></strong> 字段，预留用于存储稀疏嵌入</p>
<p>定义一个将文本转换为稀疏向量表示的函数，然后将其添加到 Schema 中</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">bm25_function</span> <span class="o">=</span> <span class="n">Function</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">name</span><span class="o">=</span><span class="s2">&#34;text_bm25_emb&#34;</span><span class="p">,</span> <span class="c1"># Function name</span>
</span></span><span class="line"><span class="cl">    <span class="n">input_field_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;text&#34;</span><span class="p">],</span> <span class="c1"># Name of the VARCHAR field containing raw text data</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_field_names</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;sparse&#34;</span><span class="p">],</span> <span class="c1"># Name of the SPARSE_FLOAT_VECTOR field reserved to store generated embeddings</span>
</span></span><span class="line"><span class="cl">    <span class="n">function_type</span><span class="o">=</span><span class="n">FunctionType</span><span class="o">.</span><span class="n">BM25</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_function</span><span class="p">(</span><span class="n">bm25_function</span><span class="p">)</span>
</span></span></code></pre></div><p>设置索引 create collection</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">index_params</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">prepare_index_params</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;sparse&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;AUTOINDEX&#34;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">metric_type</span><span class="o">=</span><span class="s2">&#34;BM25&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">index_params</span><span class="o">=</span><span class="n">index_params</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>插入数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;information retrieval is a field of study.&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;information retrieval focuses on finding relevant information in large datasets.&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="s1">&#39;data mining and information retrieval overlap in research.&#39;</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">])</span>
</span></span></code></pre></div><p>执行全文查询</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">search_params</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;drop_ratio_search&#39;</span><span class="p">:</span> <span class="mf">0.2</span><span class="p">},</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s1">&#39;demo&#39;</span><span class="p">,</span> 
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;whats the focus of information retrieval?&#39;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">anns_field</span><span class="o">=</span><span class="s1">&#39;sparse&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">search_params</span><span class="o">=</span><span class="n">search_params</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;text&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="s2">&#34;TopK results:&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">TopK results:
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665084, &#39;distance&#39;: 1.3352930545806885, &#39;entity&#39;: {&#39;text&#39;: &#39;information retrieval is a field of study.&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665085, &#39;distance&#39;: 0.29726022481918335, &#39;entity&#39;: {&#39;text&#39;: &#39;information retrieval focuses on finding relevant information in large datasets.&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h2 id="query">Query<a hidden class="anchor" aria-hidden="true" href="#query">#</a></h2>
<p>Milvus 还支持通过查询进行元数据过滤，即类似于关系型数据库的数据查询和过滤</p>
<ul>
<li>
<p><strong>Get 查询：</strong> 用于通过主键（Primary Key）精确查找实体</p>
</li>
<li>
<p><strong>Query 查询：</strong> 通过自定义过滤表达式查找满足条件的实体</p>
</li>
<li>
<p><strong>QueryIterator 查询迭代器：</strong> 用于在分页查询中，通过自定义过滤条件遍历满足条件的所有实体 （by-batch查找）</p>
</li>
</ul>
<p>get</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">MilvusClient</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;query_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">ids</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span> <span class="s2">&#34;color&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">data: [&#34;{&#39;vector&#39;: [0.35803765, -0.6023496, 0.18414013, -0.26286206, 0.90294385], &#39;color&#39;: &#39;pink_8682&#39;, &#39;id&#39;: 0}&#34;, &#34;{&#39;vector&#39;: [0.19886813, 0.060235605, 0.6976963, 0.26144746, 0.8387295], &#39;color&#39;: &#39;red_7025&#39;, &#39;id&#39;: 1}&#34;, &#34;{&#39;vector&#39;: [0.43742132, -0.55975026, 0.6457888, 0.7894059, 0.20785794], &#39;color&#39;: &#39;orange_6781&#39;, &#39;id&#39;: 2}&#34;] 
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>query</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;query_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nb">filter</span><span class="o">=</span><span class="s2">&#34;color like </span><span class="se">\&#34;</span><span class="s2">red%</span><span class="se">\&#34;</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span> <span class="s2">&#34;color&#34;</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="n">limit</span><span class="o">=</span><span class="mi">3</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">data: [&#34;{&#39;id&#39;: 1, &#39;vector&#39;: [0.19886813, 0.060235605, 0.6976963, 0.26144746, 0.8387295], &#39;color&#39;: &#39;red_7025&#39;}&#34;, &#34;{&#39;id&#39;: 4, &#39;vector&#39;: [0.44523495, -0.8757027, 0.82207793, 0.4640629, 0.3033748], &#39;color&#39;: &#39;red_4794&#39;}&#34;, &#34;{&#39;id&#39;: 6, &#39;vector&#39;: [0.8371978, -0.015764369, -0.31062937, -0.56266695, -0.8984948], &#39;color&#39;: &#39;red_9392&#39;}&#34;] 
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p><strong>QueryIterator</strong></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">connections</span><span class="p">,</span> <span class="n">Collection</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">connections</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">collection</span> <span class="o">=</span> <span class="n">Collection</span><span class="p">(</span><span class="s2">&#34;query_collection&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">iterator</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">query_iterator</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">batch_size</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">expr</span><span class="o">=</span><span class="s2">&#34;color like </span><span class="se">\&#34;</span><span class="s2">red%</span><span class="se">\&#34;</span><span class="s2">&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;color&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="n">result</span> <span class="o">=</span> <span class="n">iterator</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="n">iterator</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="n">results</span> <span class="o">+=</span> <span class="n">result</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">[{&#39;color&#39;: &#39;red_7025&#39;, &#39;id&#39;: 1}, {&#39;color&#39;: &#39;red_4794&#39;, &#39;id&#39;: 4}, {&#39;color&#39;: &#39;red_9392&#39;, &#39;id&#39;: 6}]
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h2 id="partition-key">Partition-Key<a hidden class="anchor" aria-hidden="true" href="#partition-key">#</a></h2>
<p>在 Milvus 中，partition-key（分区键）是一种基于特定标量字段的搜索优化方案。通过将某个字段指定为分区键，Milvus 会根据该字段的值将数据自动分配到不同的分区中，与手动管理分区不同，使用分区键可以克服集合中分区数量的限制（最多 1,024 个）。</p>
<p>将数据分布到独立的分区中，同时支持对分区范围的查询限定，从而实现<strong>数据隔离</strong>，可以有效避免对非目标分区的数据进行查询操作。</p>
<p><strong>自动管理分区 vs</strong>  <strong>手动创建和指定分区</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">特性</th>
          <th style="text-align: left">partition-key</th>
          <th style="text-align: left">手动分区</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">分区管理</td>
          <td style="text-align: left">自动生成，动态分区</td>
          <td style="text-align: left">必须手动创建，分区结构固定</td>
      </tr>
      <tr>
          <td style="text-align: left">分区数量限制</td>
          <td style="text-align: left">无理论限制，分区数量随字段值动态变化</td>
          <td style="text-align: left">最多 1,024 个分区</td>
      </tr>
      <tr>
          <td style="text-align: left">便捷性</td>
          <td style="text-align: left">插入和查询都更加自动化</td>
          <td style="text-align: left">插入和查询需要手动指定分区名称</td>
      </tr>
      <tr>
          <td style="text-align: left">适用场景</td>
          <td style="text-align: left">动态、多分区场景，如用户 ID、类别分类</td>
          <td style="text-align: left">静态、少量分区场景，如地理区域划分</td>
      </tr>
  </tbody>
</table>
<p><strong>Partition-key</strong> vs <strong>Meta-data Filtering</strong></p>
<table>
  <thead>
      <tr>
          <th style="text-align: left">特性</th>
          <th style="text-align: left">partition-key</th>
          <th style="text-align: left">Meta-data Filtering</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td style="text-align: left">存储方式</td>
          <td style="text-align: left">数据物理隔离，按分区键存储</td>
          <td style="text-align: left">数据逻辑统一，存储在一个集合中</td>
      </tr>
      <tr>
          <td style="text-align: left">查询效率</td>
          <td style="text-align: left">通过分区键快速定位目标分区，效率高</td>
          <td style="text-align: left">全局扫描，效率较低</td>
      </tr>
      <tr>
          <td style="text-align: left">管理复杂性</td>
          <td style="text-align: left">自动管理，无需显式定义或维护分区</td>
          <td style="text-align: left">无需预定义分区，依赖查询时的过滤</td>
      </tr>
      <tr>
          <td style="text-align: left">动态性</td>
          <td style="text-align: left">分区结构相对稳定，适合分区逻辑较简单场景</td>
          <td style="text-align: left">更灵活，适合复杂和多变的查询条件</td>
      </tr>
  </tbody>
</table>
<p><img loading="lazy" src="/img/Milvus%20%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95%ef%bc%9a%e4%bb%8e2.0%20%e5%88%b02.5%e7%89%88%e6%9c%ac%e7%9a%84%e4%bb%8e%e5%a4%b4%e5%ad%a6%e4%b9%a0-assets/Pasted%202024-12-25-14-07-42.png" alt="Pasted 2024-12-25-14-07-42.png"  />
</p>
<p>有无分区差异</p>
<p>通过partition-key 实现数据隔离查询的简单例子；</p>
<p>在这个例子中，每一个user只有查询自己数据的权限，当user选择将数据公开share，此时partition-key会被改成<code>public</code>，作为单独的partition存在，从而实现数据隔离查询。</p>
<p>数据准备：</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">from</span> <span class="nn">pymilvus</span> <span class="kn">import</span> <span class="n">MilvusClient</span><span class="p">,</span> <span class="n">DataType</span><span class="p">,</span> <span class="n">Function</span><span class="p">,</span> <span class="n">FunctionType</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span> <span class="o">=</span> <span class="n">MilvusClient</span><span class="p">(</span><span class="n">uri</span><span class="o">=</span><span class="s2">&#34;http://localhost:19530&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">create_schema</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="n">index_params</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">prepare_index_params</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">INT64</span><span class="p">,</span> <span class="n">is_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_id</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;partition_key&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> <span class="n">is_partition_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span><span class="n">description</span><span class="o">=</span><span class="s2">&#34;Partition key for data isolation&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;data_id&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Unique data identifier&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">FLOAT_VECTOR</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Vector representation&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl"><span class="n">schema</span><span class="o">.</span><span class="n">add_field</span><span class="p">(</span><span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;metadata&#34;</span><span class="p">,</span> <span class="n">datatype</span><span class="o">=</span><span class="n">DataType</span><span class="o">.</span><span class="n">JSON</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&#34;Additional filtering metadata&#34;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;vector&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;AUTOINDEX&#34;</span><span class="p">,</span>  <span class="c1"># Automatically choose the best index type</span>
</span></span><span class="line"><span class="cl">            <span class="n">metric_type</span><span class="o">=</span><span class="s2">&#34;L2&#34;</span>         <span class="c1"># Use L2 distance as the metric</span>
</span></span><span class="line"><span class="cl">        <span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Add a sort index for the id field</span>
</span></span><span class="line"><span class="cl"><span class="n">index_params</span><span class="o">.</span><span class="n">add_index</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">field_name</span><span class="o">=</span><span class="s2">&#34;id&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_type</span><span class="o">=</span><span class="s2">&#34;STL_SORT&#34;</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">create_collection</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;partitionkey_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">index_params</span><span class="o">=</span><span class="n">index_params</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">num_partitions</span><span class="o">=</span><span class="mi">1024</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>构造一些假数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="kn">import</span> <span class="nn">json</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">def</span> <span class="nf">generate_test_data</span><span class="p">(</span><span class="n">num_records</span><span class="p">,</span> <span class="n">num_users</span><span class="p">,</span> <span class="n">public_probability</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">    生成测试数据，支持一定概率生成公共数据。
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Args:
</span></span></span><span class="line"><span class="cl"><span class="s2">        num_records (int): 数据总数
</span></span></span><span class="line"><span class="cl"><span class="s2">        num_users (int): 用户数量
</span></span></span><span class="line"><span class="cl"><span class="s2">        public_probability (float): 生成公共数据的概率 (0.0 到 1.0)
</span></span></span><span class="line"><span class="cl"><span class="s2">    
</span></span></span><span class="line"><span class="cl"><span class="s2">    Returns:
</span></span></span><span class="line"><span class="cl"><span class="s2">        list: 生成的测试数据，每条数据为一个字典
</span></span></span><span class="line"><span class="cl"><span class="s2">    &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_records</span><span class="p">):</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># 根据概率选择 partition_key 为 &#34;public&#34; 或随机用户 ID</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">public_probability</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">partition_key</span> <span class="o">=</span> <span class="s2">&#34;public&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="k">else</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">            <span class="n">partition_key</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&#34;user_</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_users</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span>
</span></span><span class="line"><span class="cl">        
</span></span><span class="line"><span class="cl">        <span class="n">record</span> <span class="o">=</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;partition_key&#34;</span><span class="p">:</span> <span class="n">partition_key</span><span class="p">,</span>  <span class="c1"># 设置分区键</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;data_id&#34;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&#34;data_</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">9999</span><span class="p">)</span><span class="si">}</span><span class="s2">&#34;</span><span class="p">,</span>  <span class="c1"># 随机生成数据 ID</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;vector&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">128</span><span class="p">)],</span>  <span class="c1"># 随机生成128维向量</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;metadata&#34;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;category&#34;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&#34;image&#34;</span><span class="p">,</span> <span class="s2">&#34;text&#34;</span><span class="p">,</span> <span class="s2">&#34;video&#34;</span><span class="p">]),</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;tags&#34;</span><span class="p">:</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">([</span><span class="s2">&#34;AI&#34;</span><span class="p">,</span> <span class="s2">&#34;ML&#34;</span><span class="p">,</span> <span class="s2">&#34;NLP&#34;</span><span class="p">,</span> <span class="s2">&#34;CV&#34;</span><span class="p">])</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">)],</span>
</span></span><span class="line"><span class="cl">                <span class="s2">&#34;rating&#34;</span><span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">})</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">data</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">data</span> <span class="o">=</span> <span class="n">generate_test_data</span><span class="p">(</span><span class="mi">500</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">client</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span><span class="o">=</span><span class="s2">&#34;partitionkey_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="n">data</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></div><p>仅查询<code>user_10</code> 的数据</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">query_result</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&#34;partitionkey_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;partition_key == &#34;user_10&#34;&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;data_id&#34;</span><span class="p">,</span> <span class="s2">&#34;partition_key&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nb">print</span><span class="p">(</span><span class="n">query_result</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">data: [&#34;{&#39;data_id&#39;: &#39;data_7887&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665088}&#34;, &#34;{&#39;data_id&#39;: &#39;data_9004&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665090}&#34;, &#34;{&#39;data_id&#39;: &#39;data_8970&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665092}&#34;, &#34;{&#39;data_id&#39;: &#39;data_2031&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665098}&#34;, &#34;{&#39;data_id&#39;: &#39;data_6972&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665111}&#34;, &#34;{&#39;data_id&#39;: &#39;data_3463&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665118}&#34;, &#34;{&#39;data_id&#39;: &#39;data_9998&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665123}&#34;, &#34;{&#39;data_id&#39;: &#39;data_5411&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665133}&#34;, &#34;{&#39;data_id&#39;: &#39;data_9952&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665205}&#34;, &#34;{&#39;data_id&#39;: &#39;data_9002&#39;, &#39;partition_key&#39;: &#39;user_10&#39;, &#39;id&#39;: 454187296102665257}&#34;] ...
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><p>user_10 所能ANN搜索的内容（<code>ppublic</code>and <code>user_10</code>)</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="line"><span class="cl"><span class="n">query_vectors</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">128</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">res</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">search</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">    <span class="n">collection_name</span> <span class="o">=</span> <span class="s2">&#34;partitionkey_collection&#34;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">data</span><span class="o">=</span><span class="p">[</span><span class="n">query_vectors</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="nb">filter</span><span class="o">=</span><span class="s1">&#39;partition_key in [&#34;public&#34;,&#34;user_10&#34;]&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">output_fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&#34;data_id&#34;</span><span class="p">,</span> <span class="s2">&#34;partition_key&#34;</span><span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nb">print</span><span class="p">(</span><span class="n">hit</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665637, &#39;distance&#39;: 15.168614387512207, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;public&#39;, &#39;data_id&#39;: &#39;data_9024&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665532, &#39;distance&#39;: 15.173531532287598, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;user_10&#39;, &#39;data_id&#39;: &#39;data_8461&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665598, &#39;distance&#39;: 15.250306129455566, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;user_10&#39;, &#39;data_id&#39;: &#39;data_7539&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665323, &#39;distance&#39;: 15.833619117736816, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;user_10&#39;, &#39;data_id&#39;: &#39;data_8433&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665234, &#39;distance&#39;: 16.50188446044922, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;public&#39;, &#39;data_id&#39;: &#39;data_1534&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665501, &#39;distance&#39;: 16.521953582763672, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;public&#39;, &#39;data_id&#39;: &#39;data_9944&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665463, &#39;distance&#39;: 16.524085998535156, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;public&#39;, &#39;data_id&#39;: &#39;data_6430&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665453, &#39;distance&#39;: 16.64727020263672, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;public&#39;, &#39;data_id&#39;: &#39;data_8403&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665629, &#39;distance&#39;: 16.649581909179688, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;public&#39;, &#39;data_id&#39;: &#39;data_5141&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">{&#39;id&#39;: 454187296102665631, &#39;distance&#39;: 16.809789657592773, &#39;entity&#39;: {&#39;partition_key&#39;: &#39;public&#39;, &#39;data_id&#39;: &#39;data_3505&#39;}}
</span></span></span><span class="line"><span class="cl"><span class="s2">
</span></span></span><span class="line"><span class="cl"><span class="s2">&#34;&#34;&#34;</span>
</span></span></code></pre></div><h2 id="models">Models<a hidden class="anchor" aria-hidden="true" href="#models">#</a></h2>
<p>在2.4 版本之后支持了对于embedding模型和reranking模型的集成。</p>
<p>个人认为没有太大必要。</p>
<h2 id="图形化界面">图形化界面<a hidden class="anchor" aria-hidden="true" href="#图形化界面">#</a></h2>
<p>之前使用的是<a href="https://github.com/milvus-io/milvus-insight">milvus-insight</a>，不过不再维护了。</p>
<p>官方主推的是<a href="https://github.com/zilliztech/attu">attu</a>。</p>
<h2 id="一些踩坑点">一些踩坑点<a hidden class="anchor" aria-hidden="true" href="#一些踩坑点">#</a></h2>
<p>（待更新）</p>
<h2 id="参考">参考<a hidden class="anchor" aria-hidden="true" href="#参考">#</a></h2>
<p><a href="https://milvus.io/docs">官方文档</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://niraya666.github.io/tags/rag/">RAG</a></li>
      <li><a href="https://niraya666.github.io/tags/%E5%90%91%E9%87%8F%E5%BA%93/">向量库</a></li>
    </ul>
<nav class="paginav">
  <a class="next" href="https://niraya666.github.io/posts/agent-%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E6%A1%86%E6%9E%B6--openai-swarm/">
    <span class="title">Next »</span>
    <br>
    <span>Agent 学习笔记：框架 ｜ openAI Swarm</span>
  </a>
</nav>


<ul class="share-buttons">
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Milvus-2.5版本：学习笔记和备忘录 on x"
            href="https://x.com/intent/tweet/?text=Milvus-2.5%e7%89%88%e6%9c%ac%ef%bc%9a%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95&amp;url=https%3a%2f%2fniraya666.github.io%2fposts%2fmilvus-%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25E5%2592%258C%25E5%25A4%2587%25E5%25BF%2598%25E5%25BD%2595%25E4%25BB%258E2.0-%25E5%2588%25B02.5%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E4%25BB%258E%25E5%25A4%25B4%25E5%25AD%25A6%25E4%25B9%25A0%2f&amp;hashtags=RAG%2c%e5%90%91%e9%87%8f%e5%ba%93">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M512 62.554 L 512 449.446 C 512 483.97 483.97 512 449.446 512 L 62.554 512 C 28.03 512 0 483.97 0 449.446 L 0 62.554 C 0 28.03 28.029 0 62.554 0 L 449.446 0 C 483.971 0 512 28.03 512 62.554 Z M 269.951 190.75 L 182.567 75.216 L 56 75.216 L 207.216 272.95 L 63.9 436.783 L 125.266 436.783 L 235.9 310.383 L 332.567 436.783 L 456 436.783 L 298.367 228.367 L 432.367 75.216 L 371.033 75.216 Z M 127.633 110 L 164.101 110 L 383.481 400.065 L 349.5 400.065 Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Milvus-2.5版本：学习笔记和备忘录 on linkedin"
            href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https%3a%2f%2fniraya666.github.io%2fposts%2fmilvus-%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25E5%2592%258C%25E5%25A4%2587%25E5%25BF%2598%25E5%25BD%2595%25E4%25BB%258E2.0-%25E5%2588%25B02.5%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E4%25BB%258E%25E5%25A4%25B4%25E5%25AD%25A6%25E4%25B9%25A0%2f&amp;title=Milvus-2.5%e7%89%88%e6%9c%ac%ef%bc%9a%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95&amp;summary=Milvus-2.5%e7%89%88%e6%9c%ac%ef%bc%9a%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95&amp;source=https%3a%2f%2fniraya666.github.io%2fposts%2fmilvus-%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25E5%2592%258C%25E5%25A4%2587%25E5%25BF%2598%25E5%25BD%2595%25E4%25BB%258E2.0-%25E5%2588%25B02.5%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E4%25BB%258E%25E5%25A4%25B4%25E5%25AD%25A6%25E4%25B9%25A0%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-288.985,423.278l0,-225.717l-75.04,0l0,225.717l75.04,0Zm270.539,0l0,-129.439c0,-69.333 -37.018,-101.586 -86.381,-101.586c-39.804,0 -57.634,21.891 -67.617,37.266l0,-31.958l-75.021,0c0.995,21.181 0,225.717 0,225.717l75.02,0l0,-126.056c0,-6.748 0.486,-13.492 2.474,-18.315c5.414,-13.475 17.767,-27.434 38.494,-27.434c27.135,0 38.007,20.707 38.007,51.037l0,120.768l75.024,0Zm-307.552,-334.556c-25.674,0 -42.448,16.879 -42.448,39.002c0,21.658 16.264,39.002 41.455,39.002l0.484,0c26.165,0 42.452,-17.344 42.452,-39.002c-0.485,-22.092 -16.241,-38.954 -41.943,-39.002Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Milvus-2.5版本：学习笔记和备忘录 on reddit"
            href="https://reddit.com/submit?url=https%3a%2f%2fniraya666.github.io%2fposts%2fmilvus-%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25E5%2592%258C%25E5%25A4%2587%25E5%25BF%2598%25E5%25BD%2595%25E4%25BB%258E2.0-%25E5%2588%25B02.5%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E4%25BB%258E%25E5%25A4%25B4%25E5%25AD%25A6%25E4%25B9%25A0%2f&title=Milvus-2.5%e7%89%88%e6%9c%ac%ef%bc%9a%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-3.446,265.638c0,-22.964 -18.616,-41.58 -41.58,-41.58c-11.211,0 -21.361,4.457 -28.841,11.666c-28.424,-20.508 -67.586,-33.757 -111.204,-35.278l18.941,-89.121l61.884,13.157c0.756,15.734 13.642,28.29 29.56,28.29c16.407,0 29.706,-13.299 29.706,-29.701c0,-16.403 -13.299,-29.702 -29.706,-29.702c-11.666,0 -21.657,6.792 -26.515,16.578l-69.105,-14.69c-1.922,-0.418 -3.939,-0.042 -5.585,1.036c-1.658,1.073 -2.811,2.761 -3.224,4.686l-21.152,99.438c-44.258,1.228 -84.046,14.494 -112.837,35.232c-7.468,-7.164 -17.589,-11.591 -28.757,-11.591c-22.965,0 -41.585,18.616 -41.585,41.58c0,16.896 10.095,31.41 24.568,37.918c-0.639,4.135 -0.99,8.328 -0.99,12.576c0,63.977 74.469,115.836 166.33,115.836c91.861,0 166.334,-51.859 166.334,-115.836c0,-4.218 -0.347,-8.387 -0.977,-12.493c14.564,-6.47 24.735,-21.034 24.735,-38.001Zm-119.474,108.193c-20.27,20.241 -59.115,21.816 -70.534,21.816c-11.428,0 -50.277,-1.575 -70.522,-21.82c-3.007,-3.008 -3.007,-7.882 0,-10.889c3.003,-2.999 7.882,-3.003 10.885,0c12.777,12.781 40.11,17.317 59.637,17.317c19.522,0 46.86,-4.536 59.657,-17.321c3.016,-2.999 7.886,-2.995 10.885,0.008c3.008,3.011 3.003,7.882 -0.008,10.889Zm-5.23,-48.781c-16.373,0 -29.701,-13.324 -29.701,-29.698c0,-16.381 13.328,-29.714 29.701,-29.714c16.378,0 29.706,13.333 29.706,29.714c0,16.374 -13.328,29.698 -29.706,29.698Zm-160.386,-29.702c0,-16.381 13.328,-29.71 29.714,-29.71c16.369,0 29.689,13.329 29.689,29.71c0,16.373 -13.32,29.693 -29.689,29.693c-16.386,0 -29.714,-13.32 -29.714,-29.693Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Milvus-2.5版本：学习笔记和备忘录 on facebook"
            href="https://facebook.com/sharer/sharer.php?u=https%3a%2f%2fniraya666.github.io%2fposts%2fmilvus-%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25E5%2592%258C%25E5%25A4%2587%25E5%25BF%2598%25E5%25BD%2595%25E4%25BB%258E2.0-%25E5%2588%25B02.5%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E4%25BB%258E%25E5%25A4%25B4%25E5%25AD%25A6%25E4%25B9%25A0%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-106.468,0l0,-192.915l66.6,0l12.672,-82.621l-79.272,0l0,-53.617c0,-22.603 11.073,-44.636 46.58,-44.636l36.042,0l0,-70.34c0,0 -32.71,-5.582 -63.982,-5.582c-65.288,0 -107.96,39.569 -107.96,111.204l0,62.971l-72.573,0l0,82.621l72.573,0l0,192.915l-191.104,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Milvus-2.5版本：学习笔记和备忘录 on whatsapp"
            href="https://api.whatsapp.com/send?text=Milvus-2.5%e7%89%88%e6%9c%ac%ef%bc%9a%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95%20-%20https%3a%2f%2fniraya666.github.io%2fposts%2fmilvus-%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25E5%2592%258C%25E5%25A4%2587%25E5%25BF%2598%25E5%25BD%2595%25E4%25BB%258E2.0-%25E5%2588%25B02.5%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E4%25BB%258E%25E5%25A4%25B4%25E5%25AD%25A6%25E4%25B9%25A0%2f">
            <svg version="1.1" viewBox="0 0 512 512" xml:space="preserve" height="30px" width="30px" fill="currentColor">
                <path
                    d="M449.446,0c34.525,0 62.554,28.03 62.554,62.554l0,386.892c0,34.524 -28.03,62.554 -62.554,62.554l-386.892,0c-34.524,0 -62.554,-28.03 -62.554,-62.554l0,-386.892c0,-34.524 28.029,-62.554 62.554,-62.554l386.892,0Zm-58.673,127.703c-33.842,-33.881 -78.847,-52.548 -126.798,-52.568c-98.799,0 -179.21,80.405 -179.249,179.234c-0.013,31.593 8.241,62.428 23.927,89.612l-25.429,92.884l95.021,-24.925c26.181,14.28 55.659,21.807 85.658,21.816l0.074,0c98.789,0 179.206,-80.413 179.247,-179.243c0.018,-47.895 -18.61,-92.93 -52.451,-126.81Zm-126.797,275.782l-0.06,0c-26.734,-0.01 -52.954,-7.193 -75.828,-20.767l-5.441,-3.229l-56.386,14.792l15.05,-54.977l-3.542,-5.637c-14.913,-23.72 -22.791,-51.136 -22.779,-79.287c0.033,-82.142 66.867,-148.971 149.046,-148.971c39.793,0.014 77.199,15.531 105.329,43.692c28.128,28.16 43.609,65.592 43.594,105.4c-0.034,82.149 -66.866,148.983 -148.983,148.984Zm81.721,-111.581c-4.479,-2.242 -26.499,-13.075 -30.604,-14.571c-4.105,-1.495 -7.091,-2.241 -10.077,2.241c-2.986,4.483 -11.569,14.572 -14.182,17.562c-2.612,2.988 -5.225,3.364 -9.703,1.12c-4.479,-2.241 -18.91,-6.97 -36.017,-22.23c-13.314,-11.876 -22.304,-26.542 -24.916,-31.026c-2.612,-4.484 -0.279,-6.908 1.963,-9.14c2.016,-2.007 4.48,-5.232 6.719,-7.847c2.24,-2.615 2.986,-4.484 4.479,-7.472c1.493,-2.99 0.747,-5.604 -0.374,-7.846c-1.119,-2.241 -10.077,-24.288 -13.809,-33.256c-3.635,-8.733 -7.327,-7.55 -10.077,-7.688c-2.609,-0.13 -5.598,-0.158 -8.583,-0.158c-2.986,0 -7.839,1.121 -11.944,5.604c-4.105,4.484 -15.675,15.32 -15.675,37.364c0,22.046 16.048,43.342 18.287,46.332c2.24,2.99 31.582,48.227 76.511,67.627c10.685,4.615 19.028,7.371 25.533,9.434c10.728,3.41 20.492,2.929 28.209,1.775c8.605,-1.285 26.499,-10.833 30.231,-21.295c3.732,-10.464 3.732,-19.431 2.612,-21.298c-1.119,-1.869 -4.105,-2.99 -8.583,-5.232Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Milvus-2.5版本：学习笔记和备忘录 on telegram"
            href="https://telegram.me/share/url?text=Milvus-2.5%e7%89%88%e6%9c%ac%ef%bc%9a%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95&amp;url=https%3a%2f%2fniraya666.github.io%2fposts%2fmilvus-%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25E5%2592%258C%25E5%25A4%2587%25E5%25BF%2598%25E5%25BD%2595%25E4%25BB%258E2.0-%25E5%2588%25B02.5%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E4%25BB%258E%25E5%25A4%25B4%25E5%25AD%25A6%25E4%25B9%25A0%2f">
            <svg version="1.1" xml:space="preserve" viewBox="2 2 28 28" height="30px" width="30px" fill="currentColor">
                <path
                    d="M26.49,29.86H5.5a3.37,3.37,0,0,1-2.47-1,3.35,3.35,0,0,1-1-2.47V5.48A3.36,3.36,0,0,1,3,3,3.37,3.37,0,0,1,5.5,2h21A3.38,3.38,0,0,1,29,3a3.36,3.36,0,0,1,1,2.46V26.37a3.35,3.35,0,0,1-1,2.47A3.38,3.38,0,0,1,26.49,29.86Zm-5.38-6.71a.79.79,0,0,0,.85-.66L24.73,9.24a.55.55,0,0,0-.18-.46.62.62,0,0,0-.41-.17q-.08,0-16.53,6.11a.59.59,0,0,0-.41.59.57.57,0,0,0,.43.52l4,1.24,1.61,4.83a.62.62,0,0,0,.63.43.56.56,0,0,0,.4-.17L16.54,20l4.09,3A.9.9,0,0,0,21.11,23.15ZM13.8,20.71l-1.21-4q8.72-5.55,8.78-5.55c.15,0,.23,0,.23.16a.18.18,0,0,1,0,.06s-2.51,2.3-7.52,6.8Z" />
            </svg>
        </a>
    </li>
    <li>
        <a target="_blank" rel="noopener noreferrer" aria-label="share Milvus-2.5版本：学习笔记和备忘录 on ycombinator"
            href="https://news.ycombinator.com/submitlink?t=Milvus-2.5%e7%89%88%e6%9c%ac%ef%bc%9a%e5%ad%a6%e4%b9%a0%e7%ac%94%e8%ae%b0%e5%92%8c%e5%a4%87%e5%bf%98%e5%bd%95&u=https%3a%2f%2fniraya666.github.io%2fposts%2fmilvus-%25E5%25AD%25A6%25E4%25B9%25A0%25E7%25AC%2594%25E8%25AE%25B0%25E5%2592%258C%25E5%25A4%2587%25E5%25BF%2598%25E5%25BD%2595%25E4%25BB%258E2.0-%25E5%2588%25B02.5%25E7%2589%2588%25E6%259C%25AC%25E7%259A%2584%25E4%25BB%258E%25E5%25A4%25B4%25E5%25AD%25A6%25E4%25B9%25A0%2f">
            <svg version="1.1" xml:space="preserve" width="30px" height="30px" viewBox="0 0 512 512" fill="currentColor"
                xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape">
                <path
                    d="M449.446 0C483.971 0 512 28.03 512 62.554L512 449.446C512 483.97 483.97 512 449.446 512L62.554 512C28.03 512 0 483.97 0 449.446L0 62.554C0 28.03 28.029 0 62.554 0L449.446 0ZM183.8767 87.9921H121.8427L230.6673 292.4508V424.0079H281.3328V292.4508L390.1575 87.9921H328.1233L256 238.2489z" />
            </svg>
        </a>
    </li>
</ul>

  </footer>
<div id="utterances">
  <script src="https://utteranc.es/client.js"
        repo="https://github.com/Niraya666/niraya666.github.io.git"
        issue-term="pathname"
        theme="github-light"
        crossorigin="anonymous"
        async>
  </script>
</div>


<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      displayMath: [['$$', '$$'], ['\\[', '\\]']]
    },
    svg: {
      fontCache: 'global'
    }
  };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>


</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2024 <a href="https://niraya666.github.io/">LZY Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
